(function($){APF({group:"FBA",name:"Core",models:["ShipFromAddress","CapacityUsage","CapacityLimit","Manifest","ManifestItem","CartManifest","ManifestItemSurplusStorageAck","GeneratePlannedShipments","PlannedShipment","PlannedShipmentItem","CreatePlannedShipments","EligibleShipment","Shipment","ShipmentPrepSummary","ShipmentPreorderEligibility","SmsShipment","SasShipment","ShipmentStatus","ShipmentItem","SearchShipment","ShipmentSetCreationStatus","Carrier","CarrierShipment","CarrierShipmentEstimate","CisCarton","CisCartonItem","ValidateShipmentCartonQuantities","CisCasePackedCartonConfiguration","Carton","CartonItem","WMSInquiry","WMSInquiryDocumentRequirements","WMSInquiryItem","WMSInquiryShipmentEligibility","EligibleSailGroups","SailProfileUpdate","Defect","DefectDetails","DefectImage","ShipmentDefectAcknowledgementStatus","DefectStatus","MerchantItem","MerchantOffer","InventoryItem","MerchantAddress","MerchantLevelProperty","MerchantItemLevelProperty","AfnFees","MfnFees","AsinGuidanceRecommendation","LabelType","PrepDetail","PrepDispute","ItemAttributes","VerifyItemAttributes","MerchantConfiguration","MerchantShipmentCountries","MerchantShipmentSubdivisions","Contact","Report","TrackingEvent","PickupSlots","Box","UissProperty","CliDisplayConfiguration","SellerAction","CliPlannedServiceFeeEstimate","WorkflowInstrumentation"],initialize:function(){var s=APF.strings;
$.datepicker.setDefaults({dateFormat:$.datepicker.datePickerFormat,prevText:"&lt; Prev",nextText:"Next &gt;",dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:[s.january,s.february,s.march,s.april,s.may,s.june,s.july,s.august,s.september,s.october,s.november,s.december],dayNames:[s.sunday,s.monday,s.tuesday,s.wednesday,s.thursday,s.friday,s.saturday]});
FBA.Core.EventBus=_.extend({},Backbone.Events);
}});
}(jQuery));
(function($){$.extend(FBA.Core.Html,{controllerPaginationTotalsTemplate:_.template($("#fba-core-template-html-controller-pagination-totals").html()),controllerPaginationNoTotalsTemplate:_.template($("#fba-core-template-html-controller-pagination-no-totals").html()),controllerPaginationNavTemplate:_.template($("#fba-core-template-html-controller-pagination-nav").html()),controllerPaginationTotals:function(pagination,options){var model=new FBA.Core.Model.ControllerPaginationTotals(pagination);
if(!model.get("totalRecords")){return this.controllerPaginationNoTotalsTemplate({model:model,options:options});
}return this.controllerPaginationTotalsTemplate({model:model,options:options});
},controllerPaginationNav:function(pagination,options){var model=new FBA.Core.Model.ControllerPaginationNav(pagination);
return this.controllerPaginationNavTemplate({model:model,options:options});
},containsHazmatItems:function(models){var containsHazmatItems=false;
$.each(models||[],function(){if(this.containsHazmatItems()){containsHazmatItems=true;
}});
return containsHazmatItems;
}});
}(jQuery));
(function($){FBA.Core.View.Pagination=APF.View.Base.extend({initialize:function(options){this.view=options.view;
this.el=$(this.view.el);
this.totalsTemplate=_.template($("#fba-core-template-html-controller-pagination-totals").html());
this.noTotalsTemplate=_.template($("#fba-core-template-html-controller-pagination-no-totals").html());
this.showMoreTemplate=_.template($("#fba-core-template-html-controller-pagination-show-more").html());
},enter:function(){var events={"click #show-more":"showMore"};
Backbone.View.prototype.delegateEvents.call(this,events);
this.totals();
if(this.view.totalsModel.get("totalRecords")>this.view.collection.length){this.renderShowMoreButton();
}},totals:function(){var view=this.view;
var collection=view.collection;
var data=collection.data;
var el=this.el;
if(!(data.nextBatchTokens||data.previousBatchTokens)){view.totalsModel=new FBA.Core.Model.ControllerPaginationTotals({index:0,pageSize:data.pageSize,totalRecords:data.totalRecords});
}else{var i=Math.floor((collection.length-1)/collection.data.pageSize);
if(i<0){i=0;
}view.totalsModel=new FBA.Core.Model.ControllerPaginationTotals({index:0,pageSize:data.pageSize,totalRecords:this.view.shipment.attributes.totalLineItems});
view.totalsModel.update({page:view.data.page,index:(i*collection.data.pageSize)});
}if(!view.totalsModel.get("totalRecords")){el.find(".pagination-totals").html(this.noTotalsTemplate({model:view.totalsModel}));
return;
}el.find(".pagination-totals").html(this.totalsTemplate({model:view.totalsModel}));
},updateTotals:function(){var view=this.view;
var collection=view.collection;
var data=collection.data;
var el=this.el;
if(!(data.nextBatchTokens||data.previousBatchTokens)){view.totalsModel.update({page:view.data.page,index:view.data.index||0});
}else{var i=Math.floor((collection.length-1)/data.pageSize);
if(i<0){i=0;
}view.totalsModel.update({page:view.data.page,index:(i*data.pageSize)});
}if(!view.totalsModel.get("totalRecords")){el.find(".pagination-totals").html(this.noTotalsTemplate({model:this.view.totalsModel}));
return;
}el.find(".pagination-totals").html(this.totalsTemplate({model:this.view.totalsModel}));
},renderShowMoreButton:function(){this.el.find(".pagination-show-more").html(this.showMoreTemplate());
},showMore:function(){var view=this.view;
var that=this;
var collection=view.collection;
var dataCollection=collection.data;
var dataView=view.data;
if(!(dataCollection.nextBatchTokens||dataCollection.previousBatchTokens)){if(dataView.index+dataView.pageSize>=dataCollection.totalRecords){return;
}if(!dataView.currentPage){dataView.page=2;
dataView.index=dataCollection.pageSize;
dataView.pageSize=dataCollection.pageSize;
dataView.currentPage=1;
}else{dataView.page+=1;
dataView.index=dataView.index+dataView.pageSize;
dataView.currentPage+=1;
}collection.fetch({add:true,data:{manifestId:dataView.manifestId,step:dataView.step,filterBy:dataView.filterBy,page:dataView.page,index:dataView.index,pageSize:dataView.pageSize,currentPage:dataView.currentPage},success:function(){$(collection.models.slice(dataView.index,dataView.index+dataView.pageSize)).each(function(){var view2=view.createView(this);
view.models.push(this);
view.views.push(view2);
var tmp=view2.render();
view2.enter();
$(view2.el).insertAfter(view.el.find(".pagination tbody tr:last"));
});
view.manifest.setNextPageTotalQuantity();
that.updateTotals();
if(dataView.index+dataView.pageSize>=view.totalsModel.get("totalRecords")){that.el.find("#show-more").hide();
}}});
}else{if(dataCollection.nextBatchTokens.length==0){return;
}var oldLength=collection.length;
var i=Math.ceil((collection.length)/dataCollection.pageSize);
if(i<0){i=0;
}var nextToken=dataCollection.nextBatchTokens.length-Math.ceil((view.totalsModel.get("totalRecords")-(i*dataCollection.pageSize))/dataCollection.pageSize);
if(!dataView.page){dataView.page=2;
}else{dataView.page++;
}collection.fetch({add:true,data:{page:dataView.page,token:collection.data.nextBatchTokens[nextToken],shipmentId:dataView.shipmentId},success:function(){$(collection.models.slice(oldLength,collection.length)).each(function(){var view2=view.createView(this);
view.models.push(this);
view.views.push(view2);
var tmp=view2.render();
view2.enter();
$(view2.el).insertAfter(view.el.find(".pagination tbody tr:last"));
});
view.shipment.manifest.setNextPageTotalQuantity();
that.updateTotals();
if(dataCollection.nextBatchTokens.length==0){$(view.el).find("#show-more").hide();
}}});
}}});
}(jQuery));
(function($){FBA.Core.Model.CisCarton=FBA.Core.Model.CisCarton.replace({idAttribute:"cartonId",updateWeight:function(shipmentId,weightValue){var cartons=new FBA.Core.Collection.CisCartons([],{shipmentId:shipmentId});
this.set({weight:weightValue});
cartons.add(this);
cartons.save();
},updateDimensions:function(shipmentId,dimensions){var cartons=new FBA.Core.Collection.CisCartons([],{shipmentId:shipmentId});
var lengthValue=dimensions.lengthValue;
var widthValue=dimensions.widthValue;
var heightValue=dimensions.heightValue;
if(lengthValue&&widthValue&&heightValue){this.set({length:lengthValue,width:widthValue,height:heightValue});
cartons.add(this);
cartons.save();
}}});
})(jQuery);
(function($){FBA.Core.Model.CisCartonItem=FBA.Core.Model.CisCartonItem.replace({updateExpirationDate:function(shipmentId,expirationDate){var cartonItems=new FBA.Core.Collection.CisCartonItems([],{shipmentId:shipmentId});
this.set({expirationDateUTC:expirationDate});
cartonItems.add(this);
cartonItems.save();
}});
})(jQuery);
(function($){FBA.Core.Model.CisCasePackedCartonConfiguration=FBA.Core.Model.CisCasePackedCartonConfiguration.replace({defaults:{unitsPerCarton:0,numberOfCartons:1,owner:"MERCHANT",origin:"WEB_FORM_SINGLE_SKU_PER_CARTON",isSingleAsinDeclaredByUser:true},initialize:function(attributes,options){APF.Model.Base.prototype.initialize.call(this,options);
this.bind("change:unitsPerCarton",this.updateTotalQuantity,this);
this.bind("change:numberOfCartons",this.updateTotalQuantity,this);
this.updateTotalQuantity();
},updateTotalQuantity:function(){this.setAttr("totalQuantity",this.get("unitsPerCarton")*this.get("numberOfCartons"));
},isNew:function(){return true;
},destroy:function(options){this.unbind("change:unitsPerCarton",this.updateTotalQuantity);
this.unbind("change:numberOfCartons",this.updateTotalQuantity);
this.id=undefined;
APF.Model.Base.prototype.destroy.call(this,options);
},validNumberOfCartons:function(){var val=this.get("numberOfCartons");
return !isNaN(val)&&val>0;
},validExpirationDate:function(){var shipmentItem=this.shipmentItem;
var val=this.get("expirationDateUTC");
if(!shipmentItem||!shipmentItem.get("expirationDateRequiredOnReceive")){return true;
}return !_.isUndefined(val)&&!_.isNull(val);
}});
})(jQuery);
(function($){FBA.Core.Model.CliPlannedServiceFeeEstimate=FBA.Core.Model.CliPlannedServiceFeeEstimate.replace({initialize:function(options){this.set({state:"NOT_LOADED"});
},fetch:function(options){options||(options={});
this.set({state:"LOADING"});
var that=this;
var onSuccess=options.success||options.callback;
var onError=options.error||options.callback;
var onSuccessOverride=function(response){if(that.isValid()){that.set({state:"LOADED"});
}else{that.set({state:"ERROR_LOADING"});
}if(typeof(onSuccess)=="function"){onSuccess(response);
}};
var onErrorOverride=function(response){that.set({state:"ERROR_LOADING"});
if(typeof(onError)=="function"){onError(response);
}};
options.success=onSuccessOverride;
options.error=onErrorOverride;
APF.Model.Base.prototype.fetch.call(this,options);
},isValid:function(){return(this.getAttr("feePerUnit")&&this.getAttr("totalFee"));
},reset:function(){APF.Model.Base.prototype.reset.call(this);
this.set({state:"NOT_LOADED"});
}});
}(jQuery));
(function($){FBA.Core.Model.ItemType={getLabelPrepInstructions:function(){return["ITEM_LABELING"];
},getNonLabelPrepInstructions:function(){return["ITEM_POLYBAGGING","ITEM_BUBBLEWRAP","ITEM_TAPING","ITEM_BLACK_SHRINKWRAP","ITEM_HANG_GARMENT"];
},getLPNPrepInstructions:function(){return["ITEM_LPN_LABELING"];
},getAllPrepInstructions:function(){var instr=[];
instr.push(this.getLabelPrepInstructions());
instr.push(this.getNonLabelPrepInstructions());
instr.push(this.getLPNPrepInstructions());
return instr;
},hasExceptions:function(){return false;
},canFixExceptions:function(){return true;
},updateException:function(){return 0;
},getQuantity:function(){return this.get("unitsPerCase")*this.get("numberOfCases");
},getBarcode:function(){var barcodes=this.get("barcodes");
var barcode={type:"UPC",value:"--"};
if(barcodes&&barcodes.length){barcode=barcodes[0];
}return barcode;
},convertToSinglePackedItem:function(){this.setAttr("numberOfCases",this.getQuantity());
this.setAttr("unitsPerCase",1);
},updateQuantity:function(quantity){if(this.hasExceptions()&&!this.canFixExceptions()){this.set({numberOfCases:0,unitsPerCase:0});
}else{if(quantity.numberOfCases!==null){this.set({numberOfCases:quantity.numberOfCases||0});
}if(quantity.unitsPerCase!==null){this.set({unitsPerCase:quantity.unitsPerCase||0});
}}this.trigger("change:quantity");
},updateLabelQuantity:function(quantity){this.set({labelQuantity:quantity.labelQuantity},{silent:true});
},getSize:function(){return(this.get("isSortable")?"SORTABLE":"NON_SORTABLE");
},getAllowedQuantityRange:function(){if(this.get("allowedShipQtyRange")!==undefined){return this.get("allowedShipQtyRange");
}else{return this.get("plannedQuantity");
}},isValidQuantityRange:function(){var range=this.getAllowedQuantityRange();
var qty=this.getQuantity();
if(!range){return true;
}return(qty>=range.min&&qty<=range.max);
},hasValidUnitsPerCase:function(){var maxQuantityPerCasePack=APF.getAttr("maxQuantityPerCasePack");
if(maxQuantityPerCasePack&&this.get("unitsPerCase")>maxQuantityPerCasePack){return false;
}return true;
}};
}(jQuery));
(function($){FBA.Core.Model.ShipmentType={hasShipmentAttribute:function(attr){var hasAttr=false;
$.each(this.get("shipmentAttributes")||[],function(){if(this.type==attr&&this.value=="YES"){hasAttr=true;
}});
return hasAttr;
},containsHazmatItems:function(){return this.hasShipmentAttribute("CONTAINS_HAZMAT_ITEMS");
},containsOversizeItems:function(){return this.hasShipmentAttribute("CONTAINS_OVERSIZE_ITEMS");
},cannotShipInBlankBoxes:function(){return this.hasShipmentAttribute("CANNOT_SHIP_IN_BLANK_BOXES");
},updateTotalQuantity:function(){var totalCases=0;
var totalQuantity=0;
var totalSortableQuantity=0;
var totalOversizeQuantity=0;
var models=this.get("totalCartons")?this.cartonItems.models:this.items.models;
if(models.length==0){return;
}$.each(models,function(i,model){if(!model.get("isRemoved")){totalCases+=parseInt(model.get("numberOfCases"));
totalQuantity+=model.getQuantity();
if(model.getSize()=="SORTABLE"){totalSortableQuantity+=model.getQuantity();
}else{totalOversizeQuantity+=model.getQuantity();
}}});
totalCases+=this.get("nextPageTotalCases");
totalQuantity+=this.get("nextPageTotalQuantity");
totalSortableQuantity+=this.get("nextPageTotalSortableQuantity");
totalOversizeQuantity+=this.get("nextPageTotalOversizeQuantity");
this.set({totalCases:totalCases,totalQuantity:totalQuantity,totalSortableQuantity:totalSortableQuantity,totalOversizeQuantity:totalOversizeQuantity});
},setNextPageTotalQuantity:function(){var currentTotalCases=0;
var currentTotalQuantity=0;
var currentTotalSortableQuantity=0;
var currentTotalOversizeQuantity=0;
var models=this.get("totalCartons")?this.cartonItems.models:this.items.models;
$.each(models,function(i,model){currentTotalCases+=parseInt(model.get("numberOfCases"));
currentTotalQuantity+=model.getQuantity();
if(model.getSize()=="SORTABLE"){currentTotalSortableQuantity+=model.getQuantity();
}else{currentTotalOversizeQuantity+=model.getQuantity();
}});
var nextPageTotalCases=this.get("totalCases")-currentTotalCases;
var nextPageTotalQuantity=this.get("totalQuantity")-currentTotalQuantity;
var nextPageTotalSortableQuantity=this.get("totalSortableQuantity")-currentTotalSortableQuantity;
var nextPageTotalOversizeQuantity=this.get("totalOversizeQuantity")-currentTotalOversizeQuantity;
this.set({nextPageTotalCases:nextPageTotalCases,nextPageTotalQuantity:nextPageTotalQuantity,nextPageTotalSortableQuantity:nextPageTotalSortableQuantity,nextPageTotalOversizeQuantity:nextPageTotalOversizeQuantity});
},getSpecialInstructions:function(){var instructions=[];
$.each(this.get("shipmentAttributes")||[],function(){if(this.value=="YES"){instructions.push(this.type);
}});
$.each(this.get("prepTypeOwners")||[],function(){if(this.prepOwner=="MERCHANT"){instructions.push(this.prepType);
}});
return instructions;
}};
}(jQuery));
(function($){FBA.Core.Model.SearchShipment=FBA.Core.Model.SearchShipment.replace({initialize:function(options){APF.Model.Base.prototype.initialize.call(this,options);
},canWorkOnShipment:function(){return(this.get("shipmentStatus")=="WORKING"&&this.get("shipmentWorkflow")!="ViewSummary");
},isDeleted:function(){return($.inArray(this.get("shipmentStatus"),["DELETED","CANCELLED"])!=-1);
},getWorkflowState:function(){return(this.canWorkOnShipment()&&!this.isDeleted()?"prepare":"summary");
},getUrl:function(){var state=this.getWorkflowState();
var url="/gp/fba/inbound-shipment-workflow/index.html#"+escape(this.get("id"))+"/"+escape(this.getWorkflowState());
if(state=="summary"){url+="/tracking";
}return url;
}});
}(jQuery));
(function($){FBA.Core.Model.Manifest=FBA.Core.Model.Manifest.replace({associations:{items:{collection:"FBA.Core.Collection.ManifestItems",attributes:{manifestId:"manifestId"}},plannedShipments:{collection:"FBA.Core.Collection.PlannedShipments",attributes:{manifestId:"manifestId"}},shipments:{collection:"FBA.Core.Collection.Shipments",attributes:{manifestId:"manifestId"}},eligibleShipments:{collection:"FBA.Core.Collection.EligibleShipments",attributes:{manifestId:"manifestId",useCasePack:"useCasePack",plannedShipmentIds:"plannedShipmentIds"}}},hasItemExceptions:function(){var hasItemExceptions=false;
$.each(this.get("itemExceptionSummaries")||[],function(i,exception){if(exception.totalItems>0){hasItemExceptions=true;
return false;
}});
return hasItemExceptions;
},hasBlockingItemExceptions:function(){var hasBlockingItemExceptions=false;
$.each(this.get("itemExceptionSummaries")||[],function(i,exception){if(exception.totalItems>0&&exception.exceptionSeverity==="BLOCKING"){hasBlockingItemExceptions=true;
return false;
}});
return hasBlockingItemExceptions;
},surfaceBatchSurplusAcknowledgementOption:function(){var hasSurplusException=this.hasException("ITEM_SURPLUS_NOT_ACKNOWLEDGED")||this.hasException("ITEM_SURPLUS_ACKNOWLEDGED");
if(hasSurplusException&&this.get("totalLineItems")>=APF.getAttr("minLineItemsForBulkAck")){var totalSurplusItems=0;
$.each(this.get("itemExceptionSummaries")||[],function(i,exception){if(exception.exceptionCode==="ITEM_SURPLUS_NOT_ACKNOWLEDGED"){totalSurplusItems+=exception.totalItems;
}if(exception.exceptionCode==="ITEM_SURPLUS_ACKNOWLEDGED"){totalSurplusItems+=exception.totalItems;
}});
return totalSurplusItems>=APF.getAttr("minSurplusExceptionItemsForBulkAck");
}return false;
},isEditable:function(){if(this.get("status")){return this.get("status")==="WORKING";
}else{return true;
}},hasShipments:function(){return(this.get("status")==="SHIPMENTS_CREATED");
},getUrl:function(options){var url="";
if(this.hasShipments()){url="/gp/fba/inbound-shipment-workflow/index.html#plan/"+escape(this.id);
}else{var workflowState=this.get("workflowState")?this.get("workflowState"):"plan";
workflowState=workflowState=="preplabel"?"prep":workflowState;
url="/gp/fba/inbound-plan-workflow/index.html#"+escape(this.id)+"/"+workflowState;
}if(options&&options.reftag){url=FBA.Core.Util.addReftagToUrl({url:url,reftag:options.reftag});
}if(this.isRedirectingToBookingPage()){url="/hz/importbooking/request?manifestId="+this.get("id");
}return url;
},updateTotalQuantity:function(){var totalCases=0;
var totalQuantity=0;
var totalSortableQuantity=0;
var totalOversizeQuantity=0;
$.each(this.items.models,function(i,model){totalCases+=parseInt(model.get("numberOfCases"));
totalQuantity+=model.getQuantity();
if(model.getSize()=="SORTABLE"){totalSortableQuantity+=model.getQuantity();
}else{totalOversizeQuantity+=model.getQuantity();
}});
totalCases+=this.get("nextPageTotalCases");
totalQuantity+=this.get("nextPageTotalQuantity");
totalSortableQuantity+=this.get("nextPageTotalSortableQuantity");
totalOversizeQuantity+=this.get("nextPageTotalOversizeQuantity");
this.set({totalSortableQuantity:totalSortableQuantity,totalOversizeQuantity:totalOversizeQuantity,totalCases:totalCases,totalQuantity:totalQuantity});
},setNextPageTotalQuantity:function(){var currentTotalCases=0;
var currentTotalQuantity=0;
var currentTotalSortableQuantity=0;
var currentTotalOversizeQuantity=0;
$.each(this.items.models,function(i,model){currentTotalCases+=parseInt(model.get("numberOfCases"));
currentTotalQuantity+=model.getQuantity();
if(model.getSize()=="SORTABLE"){currentTotalSortableQuantity+=model.getQuantity();
}else{currentTotalOversizeQuantity+=model.getQuantity();
}});
var nextPageTotalCases=this.get("totalCases")-currentTotalCases;
var nextPageTotalQuantity=this.get("totalQuantity")-currentTotalQuantity;
var nextPageTotalSortableQuantity=this.get("totalSortableQuantity")-currentTotalSortableQuantity;
var nextPageTotalOversizeQuantity=this.get("totalOversizeQuantity")-currentTotalOversizeQuantity;
this.set({nextPageTotalCases:nextPageTotalCases,nextPageTotalQuantity:nextPageTotalQuantity,nextPageTotalSortableQuantity:nextPageTotalSortableQuantity,nextPageTotalOversizeQuantity:nextPageTotalOversizeQuantity});
},updateLabelQuantity:function(models){var totalLabelQuantity=0;
$.each(models||this.items.models,function(i,model){var labelInstr=model.getLabelPrepOwner();
if(labelInstr==""||labelInstr.prepOwner=="MERCHANT"){totalLabelQuantity+=parseInt(model.get("labelQuantity")||model.getQuantity());
}});
this.set({totalLabelQuantity:totalLabelQuantity});
},isOverCapacity:function(capacityUsages,manifestItems){var isOverCapacity=false;
$.each(capacityUsages.models,function(i,model){if(model.isAtLimit()&&manifestItems.getItemQuantityBySize(model)){isOverCapacity=true;
return false;
}});
return isOverCapacity;
},isWorkingLineItemCountOverMaxLineItems:function(){return(this.get("totalWorkingLineItems")>APF.getAttr("maxLineItems"));
},hasValidUnitsPerCase:function(){var hasValidUnitsPerCase=true;
$.each(this.items.models,function(){if(!this.hasValidUnitsPerCase()){hasValidUnitsPerCase=false;
return false;
}});
return hasValidUnitsPerCase;
},updateCapacityUsagesException:function(overCapacity){var itemExceptionSummaries=this.get("itemExceptionSummaries");
if(overCapacity){itemExceptionSummaries.push({exceptionCode:"OVER_CAPACITY",totalItems:1});
}else{$.each(itemExceptionSummaries,function(i,exception){if(exception.exceptionCode=="OVER_CAPACITY"){itemExceptionSummaries.splice(i,1);
return false;
}});
}this.set({itemExceptionSummaries:itemExceptionSummaries},{silent:true});
this.trigger("change:itemExceptionSummaries");
this.trigger("change:capacityUsages");
},hasException:function(exceptionCode){var hasException=false;
$.each(this.get("itemExceptionSummaries"),function(){if(this.exceptionCode==exceptionCode&&this.totalItems>0){hasException=true;
return false;
}});
return hasException;
},updateException:function(exceptionCode,count,exceptionSeverity){var hasException=false;
var itemExceptionSummaries=this.get("itemExceptionSummaries");
$.each(itemExceptionSummaries,function(i,exception){if(exception.exceptionCode==exceptionCode){exception.totalItems+=count;
hasException=true;
return false;
}});
if(!hasException&&count>0){itemExceptionSummaries.push({exceptionCode:exceptionCode,totalItems:count,exceptionSeverity:exceptionSeverity});
}this.set({itemExceptionSummaries:itemExceptionSummaries},{silent:true});
this.trigger("change:itemExceptionSummaries");
},removeAllExceptions:function(manifestItem){var that=this;
$.each(manifestItem.get("exceptions"),function(i,exception){that.updateException(exception.exceptionCode,-1);
});
},undoRemoveAllExceptions:function(manifestItem){var that=this;
$.each(manifestItem.get("exceptions"),function(i,exception){that.updateException(exception.exceptionCode,1);
});
},removeItem:function(manifestItem){this.set({totalCases:this.get("totalCases")-manifestItem.get("numberOfCases"),totalQuantity:this.get("totalQuantity")-manifestItem.getQuantity(),totalRemoved:(this.get("totalRemoved")||0)+1,totalWorkingLineItems:this.get("totalWorkingLineItems")-1});
},undoRemoveItem:function(manifestItem){this.set({totalCases:this.get("totalCases")+manifestItem.get("numberOfCases"),totalQuantity:this.get("totalQuantity")+manifestItem.getQuantity(),totalRemoved:this.get("totalRemoved")-1,totalWorkingLineItems:this.get("totalWorkingLineItems")+1});
},isPartneredImport:function(){return this.hasTrait(APF.getAttr("partneredImport"));
},hasTrait:function(trait){return _.contains(this.get("traits"),trait);
},isRedirectingToBookingPage:function(){return APF.getAttr("hasImportBookingTreatment")&&this.isPartneredImport()&&this.get("workflowState")=="preview";
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.PlannedShipment.prototype,FBA.Core.Model.ShipmentType);
FBA.Core.Model.PlannedShipment=FBA.Core.Model.PlannedShipment.replace({associations:{items:{collection:"FBA.Core.Collection.PlannedShipmentItems",attributes:{manifestId:"manifestId",plannedShipmentId:"plannedShipmentId"}}}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.Shipment.prototype,FBA.Core.Model.ShipmentType);
FBA.Core.Model.Shipment=FBA.Core.Model.Shipment.replace({initialize:function(options){this.carriers=new FBA.Core.Collection.Carriers();
this.cliPlannedServiceFeeEstimate=new FBA.Core.Model.CliPlannedServiceFeeEstimate();
APF.Model.Base.prototype.initialize.call(this,options);
},fetch:function(options){var success=options.success;
var customSuccess=function(response,textStatus,jqXHR){response.setInitialLabelQuantity();
if(typeof(success)=="function"){success(response,textStatus,jqXHR);
}};
options.success=customSuccess;
APF.Model.Base.prototype.fetch.call(this,options);
},setInitialLabelQuantity:function(){var totalLabelQuantity;
if(!this.get("totalLabelQuantity")){if(this.isMerchantLabelingPrepOwner()){totalLabelQuantity=this.get("totalQuantity");
}else{totalLabelQuantity=0;
}this.set({totalLabelQuantity:totalLabelQuantity});
}},associations:{items:{collection:"FBA.Core.Collection.ShipmentItems",attributes:{shipmentId:"shipmentId"}},carrierShipment:{model:"FBA.Core.Model.CarrierShipment",attributes:{shipmentId:"shipmentId"}},manifest:{model:"FBA.Core.Model.Manifest",attributes:{manifestId:"manifestId"}},cartons:{model:"FBA.Core.Collection.Cartons",attributes:{shipmentId:"shipmentId"}},cartonItems:{model:"FBA.Core.Collection.CartonItems",attributes:{shipmentId:"shipmentId"}},defects:{collection:"FBA.Core.Collection.Defects",attributes:{shipmentId:"shipmentId"}},micDefectStatus:{model:"FBA.Core.Model.DefectStatus",attributes:{shipmentId:"shipmentId"}},prepSummary:{model:"FBA.Core.Model.ShipmentPrepSummary",attributes:{shipmentId:"shipmentId"}},preorderEligibility:{model:"FBA.Core.Model.ShipmentPreorderEligibility",attributes:{shipmentId:"shipmentId",createDateFromEpoch:"createDateFromEpoch"}}},fetchCarriers:function(options){options=options||{};
if(!APF.getAttr("hasCEEMultiFCTreatment")){if(this.isEligibleForCEE()){options.data={country:APF.getAttr("virtualCountryCodeForCEE")};
}else{options.data={country:this.get("toAddress").country};
}}else{options.data={country:this.fetchDestinationCountryBasedOnFCOverride()};
}options.data.fromCountry=this.get("fromAddress").country;
options.callback=options.callback||$.noop;
this.carriers.fetch(options);
},fetchDestinationCountryBasedOnFCOverride:function(){if(this.requiresFcOverride()){return APF.getAttr("fcOverrideServedCountries")[this.get("destinationWarehouse")];
}else{return this.get("toAddress").country;
}},hasMissingBOLId:function(){var hasStatus=($.inArray(this.get("status"),["SHIPPED","READY_TO_SHIP","CHECKED_IN"])!=-1);
var carrierShipment=this.shipmentCarrier;
if(!(hasStatus&&carrierShipment)){return false;
}return carrierShipment.get("shipmentType")==="LTL"&&!carrierShipment.get("bolId");
},isApcLTLShipment:function(carrierShipment){carrierShipment=carrierShipment||this.carrierShipment;
return(carrierShipment&&carrierShipment.get("isInternalShipment")&&this.get("type")==="LTL");
},isApcSPDShipment:function(carrierShipment){carrierShipment=carrierShipment||this.carrierShipment;
return(carrierShipment&&carrierShipment.get("isInternalShipment")&&this.get("type")==="SMALL_PARCEL");
},isGIFTOnboardingCarrierSelected:function(){return APF.getAttr("giftOnboardingCarriersList").indexOf(this.carrierShipment.get("carrierInfo").amazonCarrierId)!==-1;
},hasMissingTrackingId:function(){return false;
var hasStatus=($.inArray(this.get("status"),["SHIPPED","READY_TO_SHIP","CHECKED_IN"])!=-1);
var missingTracking=false;
if(this.shipmentCarrier&&hasStatus&&this.get("type")==="SMALL_PARCEL"){if(!this.shipmentCarrier.packages.length){missingTracking=true;
}}return missingTracking;
},isDeleted:function(){return($.inArray(this.get("status"),["DELETED","CANCELLED"])!=-1);
},canWorkOnShipment:function(){return(this.get("status")=="WORKING"&&this.get("workflowState")!="ViewSummary");
},canEditShipmentContents:function(){return($.inArray(this.get("status"),["READY_TO_SHIP","WORKING","SHIPPED","IN_TRANSIT","DELIVERED","CHECKED_IN"])!=-1)&&!this.isSNSShipment();
},canReviewAndModifyUnits:function(){return(!_.contains(["CHECKED_IN","RECEIVING","CLOSED","DELETED","CANCELLED","ABANDONED"],this.get("status")))&&this.get("workflowState")!="ViewSummary";
},canDelete:function(){return($.inArray(this.get("status"),["READY_TO_SHIP","WORKING"])!=-1);
},canCancel:function(){return($.inArray(this.get("status"),["PENDING_SHIPPED","SHIPPED","RECEIVING","IN_TRANSIT","DELIVERED","CHECKED_IN"])!=-1);
},canTrackLTL:function(){return($.inArray(this.get("status"),["READY_TO_SHIP","SHIPPED","PENDING_SHIPPED","RECEIVING","CHECKED_IN","DELIVERED","IN_TRANSIT"])!=-1);
},getWorkflowState:function(){return(this.canWorkOnShipment()&&!this.isDeleted()?"prepare":"summary");
},hasCarrierEvent:function(){if(this.shipmentCarrier&&this.shipmentCarrier.hasLatestEvent()){return true;
}return false;
},isInTerminalStatus:function(){return _.contains(["CLOSED","DELETED","CANCELLED","ABANDONED"],this.get("status"));
},hasUnacknowledgedDefect:function(){if(!this.hasOwnProperty("defectStatus")){return false;
}return !this.defectStatus.get("areAllDefectsAcknowledged");
},hasCartons:function(){if(this.get("totalCartons")>0){return true;
}return false;
},getUrl:function(options){var state=this.getWorkflowState();
var url="/gp/fba/inbound-shipment-workflow/index.html#"+escape(this.get("id"))+"/"+escape(this.getWorkflowState());
if(state=="summary"){url+="/tracking";
}if(options&&options.reftag){url=FBA.Core.Util.addReftagToUrl({url:url,reftag:options.reftag});
}return url;
},isHazmatShipment:function(){var containsHazmatItems=false;
$.each(this.get("shipmentAttributes"),function(i,shipmentAttribute){if(shipmentAttribute.type==="CONTAINS_HAZMAT_ITEMS"&&shipmentAttribute.value==="YES"){containsHazmatItems=true;
}});
return containsHazmatItems;
},isPartneredImport:function(){var isPartneredImportShipment=false;
var shipmentAttributes=this.get("shipmentAttributes");
if(shipmentAttributes){if($.isArray(shipmentAttributes)){$.each(shipmentAttributes,function(index,shipmentAttribute){if(shipmentAttribute["type"]==="PARTNERED_IMPORT"&&shipmentAttribute["value"]==="YES"){isPartneredImportShipment=true;
}});
}else{if(typeof(shipmentAttributes)==="object"){if("PARTNERED_IMPORT" in shipmentAttributes&&shipmentAttributes["PARTNERED_IMPORT"]==="YES"){isPartneredImportShipment=true;
}}}}return isPartneredImportShipment;
},allowLabelOptOut:function(){var allowLabelOptOut=false;
if(this.get("manifestId")!==undefined){return allowLabelOptOut;
}$.each(this.get("prepTypeOwners"),function(i,owner){if(owner&&owner.prepType==="LABELING"&&owner.prepOwner==="AMAZON"){allowLabelOptOut=true;
}});
return allowLabelOptOut;
},setPrepTypeOwnerPreference:function(pref){var prefs=this.get("prepTypeOwnerPreferences")||[];
var owners=this.get("prepTypeOwners")||[];
var setPref=false;
var setOwner=false;
var that=this;
$.each(prefs,function(){if(this.prepType==pref.prepType){this.prepOwner=pref.prepOwnerPreference;
setPref=true;
return false;
}});
if(!setPref){prefs.push(pref);
}$.each(owners,function(){if(this.prepType==pref.prepType){this.prepOwner=pref.prepOwnerPreference;
setOwner=true;
return false;
}});
if(!setOwner){owners.push({prepType:pref.prepType,prepOwner:pref.prepOwnerPreference});
}this.set({"prepTypeOwnerPreferences":prefs});
this.set({"prepTypeOwners":owners});
},isMerchantLabelingPrepOwner:function(){var isMerchantLabelingPrepOwner=false;
$.each(this.get("prepTypeOwners")||[],function(i,prepTypeOwner){if(!prepTypeOwner){return true;
}if(prepTypeOwner.prepType=="LABELING"){if(prepTypeOwner.prepOwner=="MERCHANT"){isMerchantLabelingPrepOwner=true;
}return false;
}});
return isMerchantLabelingPrepOwner;
},hasItemExceptions:function(){var exceptions=this.get("itemExceptionSummaries");
return(exceptions&&exceptions.length);
},removeItem:function(model){this.set({totalLineItems:this.get("totalLineItems")-1,totalQuantity:this.get("totalQuantity")-model.getQuantity(),totalLabelQuantity:this.get("totalLabelQuantity")-model.get("labelQuantity")},{silent:true});
model.set({isRemoved:true},{silent:true});
this.updateTotalQuantity();
this.trigger("change:totalQuantity");
this.trigger("change:totalLabelQuantity");
},hasSingleItem:function(){if(this.get("totalCartons")){if(this.get("totalCartonLineItems")==1){return true;
}return false;
}if(this.get("totalLineItems")==1){return true;
}return false;
},isUpdateConfirmationNeeded:function(){return this.canEditShipmentContents()&&this.get("type")=="SMALL_PARCEL"&&this.carrierShipment.get("isInternalShipment")&&this.carrierShipment.get("status")=="CONFIRMED";
},hasInboundCrossDockFC:function(){var inboundCrossDockFCList=APF.getAttr("inboundCrossDockFCList");
var hasInboundCrossDockFC=false;
var shipment=this;
$.each(inboundCrossDockFCList,function(i,fcCode){if(shipment.get("destinationWarehouse")==fcCode){hasInboundCrossDockFC=true;
return false;
}});
return hasInboundCrossDockFC;
},isEligibleForCEE:function(){return APF.getAttr("hasMultiSpdApcCarrier")&&this.get("destinationWarehouse")==APF.getAttr("destinationCEEFC");
},requiresFcOverride:function(){return APF.getAttr("hasMultiSpdApcCarrier")&&this.isFcIdInOverrideWarehouseIdsList(this.get("destinationWarehouse"));
},isFcIdInOverrideWarehouseIdsList:function(destWarehouseId){return APF.getAttr("fcOverrideWarehouseIds").indexOf(destWarehouseId)>-1;
},isCarrierNameInListOfOverrideCarriers:function(carrierName){return carrierName in APF.getAttr("fcOverridePartnerCarrierNames");
},isSNSShipment:function(){return this.get("totalQuantity")==0||this.hasCartons()||this.get("createdBySNS");
},isBlockedOnShippingQueue:function(){if(this.get("toAddress")&&"country" in this.get("toAddress")){return APF.getAttr("isUnifiedNAMarketplace")&&(this.get("toAddress").country!==APF.getAttr("currentMarketplaceCountry"));
}return false;
}});
}(jQuery));
(function($){FBA.Core.Model.ShipmentPrepSummary=FBA.Core.Model.ShipmentPrepSummary.replace({hasMerchantLabeledItems:function(){return this.hasPrepWithOwner({owner:"MERCHANT",type:"ITEM_LABELING"});
},hasAmazonLabeledItems:function(){return this.hasPrepWithOwner({owner:"AMAZON",type:"ITEM_LABELING"});
},hasLabeledItems:function(){return this.hasPrepWithOwner({type:"ITEM_LABELING"});
},hasPrepWithOwner:function(options){var prepSummaries=this.get("prepSummaries");
if(!prepSummaries){return false;
}options=options||{};
var matchAnyOwner=options.owner?false:true;
var matchAnyType=options.type?false:true;
return _.any(prepSummaries,function(prep){return(matchAnyOwner||options.owner===prep.owner)&&(matchAnyType||options.type===prep.type)&&prep.totalLineItems>0;
});
}});
}(jQuery));
(function($){FBA.Core.Model.SmsShipment=FBA.Core.Model.SmsShipment.replace({hasAtLeastOneExpirationDatedProduct:function(){var result=false;
if(_.isObject(this.get("shipmentSummary"))){var totalLineItemsRequiringExpDate=this.get("shipmentSummary").totalLineItemsRequiringExpDate;
if(_.isNumber(totalLineItemsRequiringExpDate)){result=totalLineItemsRequiringExpDate>0;
}}return result;
}});
}(jQuery));
(function($){FBA.Core.Model.Carton=FBA.Core.Model.Carton.replace({associations:{items:{model:"FBA.Core.Collection.CartonItems",attributes:{shipmentId:"shipmentId",sscc:"sscc"}}}});
}(jQuery));
(function($){FBA.Core.Model.ValidateShipmentCartonQuantities=FBA.Core.Model.ValidateShipmentCartonQuantities.replace({fetch:function(options){options||(options={});
$.extend(true,options,{data:{shipmentId:APF.getData().shipmentId}});
APF.Model.Base.prototype.fetch.call(this,options);
}});
})(jQuery);
(function($){FBA.Core.Model.CapacityUsage=FBA.Core.Model.CapacityUsage.replace({getUtilization:function(){var utilization=this.get("utilization");
if(utilization<0){return 0;
}return utilization;
},isUnlimited:function(){return !this.get("limit");
},getUsagePercentage:function(){var utilization=this.getUtilization();
if(utilization&&!this.isUnlimited()){var usage=utilization/this.get("limit")*100;
if(usage>100){return 100;
}if(usage>0){return usage;
}}return 0;
},isAtWarning:function(){return(this.getUsagePercentage()>=this.get("msgTypePercentages").warning?true:false);
},isAtRisk:function(){return(this.getUsagePercentage()>=this.get("msgTypePercentages").risk?true:false);
},isAtLimit:function(){return(!this.isUnlimited()&&this.getUtilization()>=this.get("limit"));
},getInfoType:function(){if(this.isAtLimit()){return"limit";
}if(this.isAtRisk()){return"risk";
}if(this.isAtWarning()){return"warning";
}}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.Defect.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.Defect=FBA.Core.Model.Defect.replace({associations:{details:{model:"FBA.Core.Model.DefectDetails",attributes:{defectId:"defectId"}}}});
}(jQuery));
(function($){FBA.Core.Model.DefectDetails=FBA.Core.Model.DefectDetails.replace({associations:{defectImages:{collection:"FBA.Core.Collection.DefectImages",attributes:{tokens:"tokens"}}}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.Contact.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){$.extend(FBA.Core.Model.Report.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.Report=FBA.Core.Model.Report.replace({initialize:function(){this.set({status:""});
},getDownloadUrl:function(){var relatedDocuments=this.get("relatedDocuments");
return(relatedDocuments&&relatedDocuments.length)?"/gp/reports/documents/"+relatedDocuments[0].messageType+"_"+relatedDocuments[0].documentId+".txt?ie=UTF8&contentType=text/xls":"";
}});
}(jQuery));
(function($){FBA.Core.Model.CarrierShipment=FBA.Core.Model.CarrierShipment.replace({initialize:function(options){APF.Model.Base.prototype.initialize.call(this,options);
if(APF.getAttr("hasMultiSpdApcCarrier")){this.bind("change:carrierId",this.persistValidPackages,this);
}this.packages=new FBA.Core.Collection.CarrierShipmentPackages(this.get("packages"),{carrierShipment:this});
this.palletGroups=new FBA.Core.Collection.CarrierShipmentPalletGroups(this.get("palletGroups"),{carrierShipment:this});
},associations:{estimate:{model:"FBA.Core.Model.CarrierShipmentEstimate",attributes:{shipmentId:"shipmentId"}}},isActive:function(){return(this.get("status")=="CONFIRMED");
},isLTLBOLReady:function(shipment){return(this.isActive()&&this.get("ltlData")&&this.get("ltlData").amazonReferenceNumber&&shipment.get("bolId"));
},getUrl:function(){return"/gp/fba/inbound-shipment-workflow/index.html#"+escape(this.get("id"))+"/prepare";
},hasLatestEvent:function(){return this.get("events")||this.get("ltlData").previewPickupDate;
},getLatestEvent:function(){var events=this.get("events");
var event=events?events[0]:"";
return event;
},canCalculate:function(){if($.inArray(this.get("status"),["WORKING","ERROR_ON_ESTIMATING","ESTIMATED","ERROR_ON_CONFIRMING"])!=-1){return true;
}return false;
},isValidStatus:function(){var invalidStatuses=["ESTIMATING","CONFIRMING","CONFIRMED","VOIDING","ERROR_ON_VOIDING"];
if($.inArray(this.get("status"),invalidStatuses)!=-1){return false;
}return true;
},addPackage:function(inputPackage){if(!this.get("packages")){this.set({packages:[]});
}var packages=this.get("packages");
var nextPackageNum=packages.length+1;
var newPackage=$.extend({number:nextPackageNum},inputPackage);
packages.push(newPackage);
},changeNumPackages:function(packageCount){var packages=this.get("packages");
var oldPackageCount=packages.length;
var newPackageCount=packageCount;
if(oldPackageCount!=newPackageCount){if(oldPackageCount<newPackageCount){for(var i=oldPackageCount;
i<newPackageCount;
++i){this.addPackage({});
}}else{if(oldPackageCount>newPackageCount){for(var i=oldPackageCount;
i>newPackageCount;
--i){delete packages[i-1];
packages.splice(i-1,1);
}}}this.trigger("change:packages");
}},updatePackageTrackingId:function(number,trackingId,options){var index=number-1;
var packages=this.get("packages");
packages[index].trackingId=trackingId;
this.packages.models[index].set({trackingId:trackingId},{silent:true});
this.savePackages(options);
},savePackages:function(options){var that=this;
var packages=this.get("packages");
var saveOptions={queue:true};
if(options){if(typeof options.queue==="boolean"){saveOptions.queue=options.queue;
}if(options.silent!==true){saveOptions.success=function(){that.trigger("save:complete");
};
}if(options.reftag){saveOptions.reftag=options.reftag;
}}if(!APF.getAttr("hasNapcWeightFormTreatment")&&!APF.getAttr("hasMultiSpdApcCarrier")){$.each(packages,function(i){delete packages[i].weight;
delete packages[i].dimensions;
});
this.set({packages:packages});
}this.save({},saveOptions);
},deletePackage:function(packageNum){var index=packageNum-1;
var packages=this.get("packages");
delete packages[index];
packages.splice(index,1);
if(!APF.getAttr("hasNapcWeightFormTreatment")&&!APF.getAttr("hasMultiSpdApcCarrier")){for(var i=0;
i<index;
i++){delete packages[i].weight;
delete packages[i].dimensions;
}}for(var i=index;
i<packages.length;
i++){packages[i].number=i+1;
if(!APF.getAttr("hasNapcWeightFormTreatment")&&!APF.getAttr("hasMultiSpdApcCarrier")){delete packages[i].weight;
delete packages[i].dimensions;
}}},getUserDeclaredValue:function(){var ltlData=this.get("ltlData")||{};
if(ltlData.isDeclaredValueSetByUser){return ltlData.declaredValue;
}return"";
},validateLtlData:function(value,attributes,options){if(!value||!value.palletGroups){return true;
}var dateFormat=new RegExp($.datepicker.dateRegularExpression);
var isValid=true;
if(!value.freightReadyDate||!dateFormat.test(value.freightReadyDate)){if(!options.silent){this.trigger("error:freightReadyDate",{model:this,attribute:"freightReadyDate",value:value});
}isValid=false;
}if(!value.contact){if(!options.silent){this.trigger("error:contact",{model:this,attribute:"contact",value:value});
}isValid=false;
}return isValid;
},persistValidPackages:function(options){var allPackages=this.get("packages");
if(allPackages&&allPackages.length>0){var validPackages=[];
var saveOptions=this.getSaveOptionsForCarrierShipment(options);
this.removeEmptyPackagesAtLast();
this.pickUpValidPackages(validPackages);
if(validPackages.length<allPackages.length){this.set({packages:validPackages},{silent:true});
this.save({},saveOptions);
this.set({packages:allPackages,ignoreCallBackWithInvalidPackages:true},{silent:true});
return true;
}}return false;
},persistValidPackagesForNapc:function(options){var allPackages=this.get("packages");
var validPackages=[];
var saveOptions=this.getSaveOptionsForCarrierShipment(options);
this.removeEmptyPackagesAtLast();
this.pickUpValidPackages(validPackages);
if(allPackages.length==0){this.addPackage({});
this.trigger("change:packages");
this.save({},saveOptions);
this.set({ignoreCallBackWithInvalidPackages:true},{silent:true});
return true;
}else{if(validPackages.length<allPackages.length){if(validPackages.length==0){validPackages.push($.extend({number:1},{}));
}this.set({packages:validPackages},{silent:true});
this.save({},saveOptions);
this.set({packages:allPackages,ignoreCallBackWithInvalidPackages:true},{silent:true});
return true;
}}return false;
},getSaveOptionsForCarrierShipment:function(options){var completeCallback=$.noop;
if(options&&options.completeCallback){completeCallback=options.completeCallback;
}return saveOptions={queue:true,success:function(){completeCallback();
},error:function(){completeCallback();
}};
},removeEmptyPackagesAtLast:function(){var packages=this.get("packages");
var packageCount=packages.length;
for(var i=packageCount-1;
i>=0;
--i){if(packages[i].dimensions.length===""&&packages[i].dimensions.width===""&&packages[i].dimensions.height===""&&packages[i].weight===""){delete packages[i];
packages.splice(i,1);
}else{break;
}}if(packageCount>packages.length){this.trigger("change:packages");
}},pickUpValidPackages:function(validPackages){var that=this;
var index=1;
var totalWeight=0;
var totalVolume=0;
var allPackages=this.get("packages");
$.each(allPackages,function(i,pkg){var pkgCopy=$.extend(true,{},pkg);
var dimensions=pkgCopy.dimensions;
pkgCopy.number=index;
totalWeight+=pkgCopy.weight;
totalVolume+=dimensions.length*dimensions.width*dimensions.height;
validPackages.push(pkgCopy);
var packagesForTest=new FBA.Core.Collection.CarrierShipmentPackages(validPackages,{carrierShipment:that,ignoreAllEvents:true});
packagesForTest.setAttr("totalWeight",totalWeight);
packagesForTest.setAttr("totalVolume",totalVolume);
packagesForTest.setAttr("totalCount",validPackages.length);
if(!packagesForTest.isValid()){validPackages.pop();
}else{++index;
}delete packagesForTest.carrierShipment;
packagesForTest=null;
});
},createPackageJSON:function(){var packages=this.get("packages");
var packageWeights={};
$.each(packages,function(i){packageWeights[i]=packages[i].weight;
});
return JSON.stringify(packageWeights);
}});
}(jQuery));
(function($){FBA.Core.Model.CarrierShipmentBox=APF.Model.Base.extend({initialize:function(options){var dimensions=this.get("dimensions")||{};
dimensions.width=dimensions.width||"";
dimensions.height=dimensions.height||"";
dimensions.length=dimensions.length||"";
this.set({dimensions:dimensions,weight:this.get("weight")||""},{silent:true});
APF.Model.Base.prototype.initialize.call(this,options);
},isEmpty:$.noop,validateWeight:function(value){return(value?true:false);
},showDimensionsError:function(value){var that=this;
var carrierShipment=this.collection.carrierShipment;
var isInternalShipment=carrierShipment.getAttr("isInternalShipment");
if(!isInternalShipment){return;
}$.each(["width","height","length"],function(){if(!value[this]&&value[this]!==null&&value[this]!==""){$(".box-error-dimensions").show();
that.trigger("error:"+this,{model:that,attribute:this,value:value});
}});
},isOverTotalSize:function(){return false;
},validateDimensions:function(value,attributes,options){var areDimensionsValid=true;
var hasValue=(value.width||value.height||value.length);
var that=this;
var arePackageDimensionsRequired=FBA.Core.Util.arePackageDimensionsRequired(this.collection.carrierShipment);
var areAllFieldsPresentAndValid=value.width&&value.height&&value.length;
var isInternalShipment=this.collection.carrierShipment.get("isInternalShipment");
if(!isInternalShipment){return true;
}if(arePackageDimensionsRequired){if(!areAllFieldsPresentAndValid){areDimensionsValid=false;
this.showDimensionsError(value);
}}else{if(hasValue!==null&&hasValue!==undefined&&hasValue!==""&&!areAllFieldsPresentAndValid){areDimensionsValid=false;
this.showDimensionsError(value);
}}return areDimensionsValid&&!this.isOverTotalSize();
},hasDimensions:function(){var dimensions=this.get("dimensions");
return(dimensions&&dimensions.length&&dimensions.width&&dimensions.height);
}});
}(jQuery));
(function($){FBA.Core.Model.CarrierShipmentPackage=FBA.Core.Model.CarrierShipmentBox.extend({initialize:function(options){this.carrierIdToDimensionalFormulaFunction={"AZIJ9NS621I3V":this.totalSizeFormulaLengthAndGirth,"A1KIAD4ID8IDBW":this.totalSizeFormulaLengthAndGirth,"A1QF24WRM97A7P":this.totalSizeFormula,"AU9OOUY4YFBNA":this.totalSizeFormula,"A167RZYVLKH43T":this.totalSizeFormula,"A3TK3PM52MN38B":this.totalSizeFormula,"XXUNKNOWNXX":this.dummyFormula,"A2FG52YTB8D9M1":this.dummyFormula,"A3I0DB0R06HML6":this.dummyFormula,"A1YZ90V46PJUZX":this.dummyFormula,"AHZYJBEGYVXJ0":this.dummyFormula};
this.carrierIdToDimensionalWeightFormulaFunction={"AZIJ9NS621I3V":this.dimensionalWeightUps,"A1KIAD4ID8IDBW":this.dimensionalWeightFdeg};
FBA.Core.Model.CarrierShipmentBox.prototype.initialize.call(this,options);
},totalSizeFormula:function(sumOfDimensions,maxDimension){return sumOfDimensions;
},totalSizeFormulaLengthAndGirth:function(sumOfDimensions,maxDimension){return sumOfDimensions*2-maxDimension;
},dummyFormula:function(sumOfDimensions,maxDimension){return 0;
},boxVolume:function(){var width=this.get("dimensions").width;
var height=this.get("dimensions").height;
var length=this.get("dimensions").length;
var volume=1;
if(width<=0||height<=0||length<=0){return 0;
}$.each([width,height,length],function(){volume*=this;
});
return volume;
},dimensionalWeightUps:function(boxVolume,threshold,dimWeightParameter){var volumeDivisor=dimWeightParameter["volumeDivisor"];
if(!isNaN(parseFloat(volumeDivisor))&&isFinite(volumeDivisor)&&parseFloat(volumeDivisor)>0){return boxVolume/parseFloat(volumeDivisor);
}else{return 0;
}},dimensionalWeightFdeg:function(boxVolume,threshold,dimWeightParameter){var volumeDivisor=(boxVolume>=threshold)?dimWeightParameter["volumeDivisorAboveThreshold"]:dimWeightParameter["volumeDivisorBelowThreshold"];
if(!isNaN(parseFloat(volumeDivisor))&&isFinite(volumeDivisor)&&parseFloat(volumeDivisor)>0){return boxVolume/parseFloat(volumeDivisor);
}else{return 0;
}},isHeavyWeight:function(){var carrierShipment=this.collection.carrierShipment;
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var heavyWeightMap=carrierShipment.get("boxHeavyWeight");
var heavyWeight=heavyWeightMap[encryptedCarrierId];
return this.isOverThreshold(heavyWeight,this.get("weight"));
},isOverMaxWeight:function(){var carrierShipment=this.collection.carrierShipment;
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var boxMaxWeightMap=carrierShipment.get("maxWeight");
var boxMaxWeight=boxMaxWeightMap[encryptedCarrierId];
return this.isOverThreshold(boxMaxWeight,this.get("weight"));
},checkTotalSize:function(threshold){var isOverThreshold=false;
var width=this.get("dimensions").width;
var height=this.get("dimensions").height;
var length=this.get("dimensions").length;
var totalSize=0;
var maxDimension=0;
var carrierShipment=this.collection.carrierShipment;
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
$.each([width,height,length],function(){if(this>0){totalSize+=this;
if(this>maxDimension){maxDimension=this;
}}});
totalSize=this.carrierIdToDimensionalFormulaFunction[encryptedCarrierId](totalSize,maxDimension);
if(threshold!=0&&totalSize>threshold){isOverThreshold=true;
}return isOverThreshold;
},isLargeSize:function(){var carrierShipment=this.collection.carrierShipment;
var isInternalShipment=carrierShipment.get("isInternalShipment");
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var thresholdMap=carrierShipment.get("largePackageThreshold");
var threshold=thresholdMap[encryptedCarrierId];
if(!this.isPositiveNumeric(threshold)){return false;
}if(!isInternalShipment){return false;
}return this.checkTotalSize(threshold);
},isDimWeightSurcharge:function(){var carrierShipment=this.collection.carrierShipment;
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var thresholdMap=carrierShipment.get("dimensionalWeightThreshold");
var threshold=thresholdMap[encryptedCarrierId];
var dimWeightParameterMap=carrierShipment.get("dimensionalWeightParameter");
var dimWeightParameter=dimWeightParameterMap[encryptedCarrierId];
if(!this.isPositiveNumeric(threshold)){return false;
}if(!(encryptedCarrierId in this.carrierIdToDimensionalWeightFormulaFunction)){return false;
}if(this.get("weight")<this.carrierIdToDimensionalWeightFormulaFunction[encryptedCarrierId](this.boxVolume(),parseFloat(threshold),dimWeightParameter)){return this.boxVolume()>parseFloat(threshold);
}else{return false;
}},isOverTotalSize:function(){var carrierShipment=this.collection.carrierShipment;
var isInternalShipment=carrierShipment.get("isInternalShipment");
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var thresholdMap=carrierShipment.get("totalSize");
var threshold=thresholdMap[encryptedCarrierId];
var isOverTotalSize=false;
if(!this.isPositiveNumeric(threshold)){return false;
}if(!isInternalShipment){return false;
}isOverTotalSize=this.checkTotalSize(threshold);
if(!isOverTotalSize){var width=this.get("dimensions").width;
var height=this.get("dimensions").height;
var length=this.get("dimensions").length;
var encryptedCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var maxDimensionMap=carrierShipment.get("maxDimension");
var mediumDimensionMap=carrierShipment.get("mediumDimension");
var minDimensionMap=carrierShipment.get("minDimension");
var maxDimension=maxDimensionMap[encryptedCarrierId];
var mediumDimension=mediumDimensionMap[encryptedCarrierId];
var minDimension=minDimensionMap[encryptedCarrierId];
var dimensionThreshold=[minDimension,mediumDimension,maxDimension];
var dimensions=[width,height,length];
dimensions.sort(function(a,b){return a-b;
});
for(index=0;
index<dimensions.length;
index++){if(!this.isNumeric(dimensionThreshold[index])){return false;
}if(this.isOverThreshold(dimensionThreshold[index],dimensions[index])){isOverTotalSize=true;
}}}return isOverTotalSize;
},isEmpty:function(){return(!this.hasDimensions()&&!this.get("weight"));
},validateWeight:function(value){var isWeightValid=true;
var isInternalShipment=this.collection.carrierShipment.get("isInternalShipment");
if(!isInternalShipment&&!APF.getAttr("spdNapcWeightValidation")){return true;
}if(!FBA.Core.Model.CarrierShipmentBox.prototype.validateWeight(value)||this.isOverMaxWeight()||value<1){isWeightValid=false;
}return isWeightValid;
},isPositiveNumeric:function(n){return this.isNumeric(n)?parseFloat(n)>0:false;
},isNumeric:function(n){return !isNaN(parseFloat(n))&&isFinite(n);
},isOverThreshold:function(threshlold,value){return this.isPositiveNumeric(threshlold)?parseFloat(value)>parseFloat(threshlold):false;
}});
}(jQuery));
(function($){FBA.Core.Model.CarrierShipmentPalletGroup=FBA.Core.Model.CarrierShipmentBox.extend({defaults:{palletCount:""},initialize:function(options){FBA.Core.Model.CarrierShipmentBox.prototype.initialize.call(this,options);
var dimensions=this.get("dimensions");
dimensions.width=40;
dimensions.length=48;
},validatePalletCount:function(value){return(value?true:false);
},isEmpty:function(){return(!this.get("dimensions").height&&!this.get("weight")&&!this.get("palletCount"));
},getSinglePalletWeight:function(){var weight=this.get("weight");
var palletCount=this.get("palletCount");
if(weight&&palletCount){return weight/palletCount;
}return 0;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.InventoryItem.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){$.extend(FBA.Core.Model.ManifestItem.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.ManifestItem=FBA.Core.Model.ManifestItem.replace({initialize:function(options){var labelQuantity;
var labelInstr=this.getLabelPrepOwner();
if(labelInstr===""){labelQuantity="0";
}this.set({labelQuantity:labelQuantity});
},hasExceptions:function(){return this.get("exceptions").length>0;
},hasBlockingExceptions:function(){var hasBlockingExceptions=false;
$.each(this.get("exceptions"),function(){if(this.exceptionSeverity==="BLOCKING"){hasBlockingExceptions=true;
return false;
}});
return hasBlockingExceptions;
},hasException:function(exceptionCode){var hasException=false;
$.each(this.get("exceptions"),function(){if(this.exceptionCode==exceptionCode){hasException=true;
return false;
}});
return hasException;
},canFixExceptions:function(){var canFix=true;
var canFixExceptionCodes=["AMAZON_CANNOT_LABEL","MISSING_DIMENSIONS","OVER_ASIN_GUIDANCE","OVER_PLANNED_QTY","OVER_SORTABLE_CAPACITY","OVER_NONSORTABLE_CAPACITY","ZERO_QUANTITY","ITEM_SURPLUS_NOT_ACKNOWLEDGED"];
$.each(this.get("exceptions"),function(i,exception){if($.inArray(exception.exceptionCode,canFixExceptionCodes)==-1&&exception.exceptionSeverity!=="NON_BLOCKING"){canFix=false;
return false;
}});
return canFix;
},hasRemovalRequiredException:function(){var removalRequiredExceptions=APF.getAttr("removalRequiredExceptions");
var hasRemovalRequiredException=false;
$.each(this.get("exceptions"),function(index,exception){if(removalRequiredExceptions.indexOf(exception.exceptionCode)>-1){hasRemovalRequiredException=true;
}});
return hasRemovalRequiredException;
},updateException:function(exceptionCode){if(exceptionCode=="ZERO_QUANTITY"){if(parseInt(this.get("numberOfCases"))==0||parseInt(this.get("unitsPerCase"))==0){return this.addException(exceptionCode);
}else{return this.removeException(exceptionCode);
}}},addException:function(exceptionCode,exceptionSeverity){var hasException=false;
var exceptions=this.get("exceptions");
$.each(exceptions,function(i,exception){if(exception.exceptionCode==exceptionCode){hasException=true;
return false;
}});
if(!hasException){exceptions.push({exceptionSeverity:exceptionSeverity,exceptionCode:exceptionCode});
}this.set({exceptions:exceptions},{silent:true});
this.trigger("change:exceptions");
return hasException?0:1;
},removeException:function(exceptionCode){var hasException=false;
var exceptions=this.get("exceptions");
$.each(exceptions,function(i,exception){if(exception.exceptionCode==exceptionCode){exceptions.splice(i,1);
hasException=true;
return false;
}});
this.set({exceptions:exceptions},{silent:true});
this.trigger("change:exceptions");
return hasException?-1:0;
},saveQuantity:function(quantity,callback){this.set({unitsPerCase:quantity});
this.save({},callback);
},hasGuidance:function(){return false;
},getGuidance:function(){return 0;
},getNonLabelPrepInstructions:function(){var nonLabelPrepInstructions=FBA.Core.Model.ItemType.getNonLabelPrepInstructions();
var instructions=_.filter(this.get("prepInstructions"),function(prep){return $.inArray(prep.prepType,nonLabelPrepInstructions)!=-1;
});
return instructions?instructions:[];
},getLPNPrepInstructions:function(){var lpnLabelPrepInstructions=FBA.Core.Model.ItemType.getLPNPrepInstructions();
var instructions=_.filter(this.get("prepInstructions"),function(prep){return $.inArray(prep.prepType,lpnLabelPrepInstructions)!=-1;
});
return instructions?instructions:[];
},getLabelPrepInstructions:function(){var labelPrepInstructions=FBA.Core.Model.ItemType.getLabelPrepInstructions();
var instructions=_.filter(this.get("prepInstructions"),function(prep){return $.inArray(prep.prepType,labelPrepInstructions)!=-1;
});
return instructions?instructions:[];
},getLabelPrepOwner:function(){var label=this.getLabelPrepInstructions();
if(label.length){if(label[0].allowPrepOwnerChange===undefined){label[0].allowPrepOwnerChange=1;
}return label[0];
}return"";
},updatePrepOwner:function(owner){var instructions=[];
var labelPrepInstructions=this.getLabelPrepInstructions();
var nonLabelPrepInstructions=this.getNonLabelPrepInstructions();
var lpnLabelPrepInstructions=this.getLPNPrepInstructions();
if(owner==="AMAZON"){this.trigger("forcedLabelFees");
}if(labelPrepInstructions&&labelPrepInstructions.length){instructions.push(labelPrepInstructions[0]);
}$.each(nonLabelPrepInstructions,function(i,instruction){instruction.prepOwner=owner;
instructions.push(instruction);
});
if(lpnLabelPrepInstructions&&lpnLabelPrepInstructions.length){instructions.push(lpnLabelPrepInstructions[0]);
}this.set({prepInstructions:instructions},{silent:true});
this.trigger("change:prepInstructions");
},updateCategory:function(prepModel,category){if(this.get("prepCategory")==="FC_PROVIDED"){return;
}var prep=[];
var nonLabelPrepInstructions=FBA.Core.Model.ItemType.getNonLabelPrepInstructions();
var labelPrepInstructions=FBA.Core.Model.ItemType.getLabelPrepInstructions();
var lpnLabelPrepInstructions=FBA.Core.Model.ItemType.getLPNPrepInstructions();
var owner;
_.each(this.get("prepInstructions"),function(instruction){if($.inArray(instruction.prepType,nonLabelPrepInstructions)!=-1){owner=instruction.prepOwner;
}});
if(!owner){owner=APF.getAttr("nonLabelPrepOwner").get("value");
}if(category!=="NONE"){_.each(prepModel.get("prepInstructions"),function(instruction){prep.push({allowPrepOwnerChange:1,prepType:instruction,prepOwner:owner});
});
var merchantItemLevelProperty=new FBA.Core.Model.MerchantItemLevelProperty();
merchantItemLevelProperty.set({type:"DEFAULT_PREP_CATEGORY",mSku:this.get("mSku"),value:category});
merchantItemLevelProperty.save();
}_.each(this.get("prepInstructions"),function(instruction){if($.inArray(instruction.prepType,labelPrepInstructions)!=-1){prep.push(instruction);
}});
_.each(this.get("prepInstructions"),function(instruction){if($.inArray(instruction.prepType,lpnLabelPrepInstructions)!=-1){prep.push(instruction);
}});
this.set({prepCategory:category,prepInstructions:prep});
},updateLabelOwner:function(owner){var prepInstructions=this.getNonLabelPrepInstructions();
var labelPrepInstructions=this.getLabelPrepInstructions();
var lpnLabelPrepInstructions=this.getLPNPrepInstructions();
if(!labelPrepInstructions.length){return;
}if(!this.get("barcodes").length){if(owner=="AMAZON"){this.trigger("error:noBarcode");
}return;
}if(labelPrepInstructions[0].allowPrepOwnerChange===undefined){labelPrepInstructions[0].allowPrepOwnerChange=1;
}if(labelPrepInstructions[0].allowPrepOwnerChange===0){return;
}labelPrepInstructions[0].prepOwner=owner;
prepInstructions.push(labelPrepInstructions[0]);
if(lpnLabelPrepInstructions&&lpnLabelPrepInstructions.length){prepInstructions.push(lpnLabelPrepInstructions[0]);
}this.set({prepInstructions:prepInstructions},{silent:true});
this.trigger("change:prepInstructions");
},softDestroy:function(options){this.softDestroyed=true;
this.saveWithQueue(options,_.bind(function(options){var success=options.success;
var that=this;
options.success=function(resp){success(that,resp);
};
return this.sync("delete",this,options);
},this));
},undoSoftDestroy:function(options){var that=this;
var success=options.success;
this.set({prepInstructions:[]});
options.success=function(resp){that.softDestroyed=false;
success(resp);
};
this.save({},options);
},isSoftDestroyed:function(){return(typeof this.softDestroyed==="undefined")?false:this.softDestroyed;
}});
}(jQuery));
(function($){FBA.Core.Model.ManifestItemSurplusStorageAck=FBA.Core.Model.ManifestItemSurplusStorageAck.replace({});
})(jQuery);
(function($){$.extend(FBA.Core.Model.MerchantOffer.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){$.extend(FBA.Core.Model.MerchantItem.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){FBA.Core.Model.PrepDispute=FBA.Core.Model.PrepDispute.replace({isCompleted:function(){if($.inArray(this.get("prepDisputeStatus"),["DISPUTED","REJECTED","PARTIAL_DISPUTED"])>-1){return true;
}return false;
},isInProgress:function(){if($.inArray(this.get("prepDisputeStatus"),["INIT","PROCESSING"])>-1){return true;
}return false;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.MerchantConfiguration.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){$.extend(FBA.Core.Model.MerchantShipmentCountries.prototype,FBA.Core.Model.ItemType);
}(jQuery));
(function($){$.extend(FBA.Core.Model.PlannedShipmentItem.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.PlannedShipmentItem=FBA.Core.Model.PlannedShipmentItem.replace({});
}(jQuery));
(function($){FBA.Core.Model.ShipmentDefectAcknowledgementStatus=FBA.Core.Model.ShipmentDefectAcknowledgementStatus.replace({getShipmentProblemUrl:function(){return"/gp/ssof/workflow/workflow.html/ref=ag_fbaworkflo_cont_fbashipq?step=ViewSummary&shipmentId="+escape(this.get("id"))+"#problem_summary";
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.ShipmentItem.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.ShipmentItem=FBA.Core.Model.ShipmentItem.replace({setInitialLabelQuantity:function(){var shipment=APF.getAttr("shipments").get(this.get("shipmentId"));
var labelQuantity;
if(!this.isAmazonLabeledItem()){labelQuantity=this.getQuantity().toString();
}else{labelQuantity="0";
}this.set({labelQuantity:labelQuantity});
},isAmazonLabeledItem:function(){return _.any(this.get("prepDetails"),function(prep){return prep.prepOwner==="AMAZON"&&prep.prepType==="ITEM_LABELING";
});
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.CartonItem.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.CartonItem=FBA.Core.Model.CartonItem.replace({isAmazonLabeledItem:function(){return false;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Model.WMSInquiryItem.prototype,FBA.Core.Model.ItemType);
FBA.Core.Model.WMSInquiryItem=FBA.Core.Model.WMSInquiryItem.replace({getTotalDiscrepancyQuantity:function(){if(this.get("totalDiscrepancyQuantity")>0){return"+"+this.get("totalDiscrepancyQuantity");
}else{return this.get("totalDiscrepancyQuantity");
}},getYumaCaseURL:function(){if(this.get("caseId")){return'<a href="/gp/case-dashboard/view-case.html/ref=sc_cd_lobby_vc?ie=UTF8&caseID='+this.get("caseId")+'">'+this.get("caseId")+"</a>";
}else{return"--";
}}});
}(jQuery));
(function($){FBA.Core.Model.EligibleShipment=FBA.Core.Model.EligibleShipment.replace({});
}(jQuery));
(function($){FBA.Core.Model.ShipmentStatus=FBA.Core.Model.ShipmentStatus.replace({});
}(jQuery));
(function($){FBA.Core.Model.ControllerPaginationTotals=APF.Model.Base.extend({defaults:{startIndex:0,endIndex:0,page:0,index:null,pageSize:0,totalRecords:0},initialize:function(){var page=this.get("page");
var index=this.get("index");
var pageSize=this.get("pageSize");
var totalRecords=this.get("totalRecords");
var startIndex=0;
var endIndex=0;
if(!totalRecords){return;
}if(this.get("index")!==null){startIndex=index+1;
endIndex=index+pageSize;
}else{startIndex=(page-1)*pageSize+1;
endIndex=page*pageSize;
}if(startIndex>totalRecords){startIndex=totalRecords;
}if(endIndex>totalRecords){endIndex=totalRecords;
}this.set({startIndex:startIndex,endIndex:endIndex});
},update:function(options){var page=options.page;
var index=options.index;
var pageSize=this.get("pageSize");
var totalRecords=this.get("totalRecords");
var startIndex=0;
var endIndex=0;
if(!totalRecords){return;
}if(this.get("index")!==null){startIndex=1;
endIndex=index+pageSize;
}else{startIndex=1;
endIndex=page*pageSize;
}if(startIndex>totalRecords){startIndex=totalRecords;
}if(endIndex>totalRecords){endIndex=totalRecords;
}this.set({startIndex:startIndex,endIndex:endIndex});
}});
}(jQuery));
(function($){FBA.Core.Model.ControllerPaginationNav=APF.Model.Base.extend({defaults:{page:1,previousBatchTokens:[],nextBatchTokens:[],index:null,pageSize:0,totalRecords:0,batchSize:null,navSize:5},initialize:function(){if(!this.get("totalRecords")){return;
}if(this.get("index")!==null){this.initializeIndexPagination();
}else{this.initializeTokenPagination();
}},initializeTokenPagination:function(){var page=this.get("page")||1;
var pageSize=this.get("pageSize");
var previousBatchTokens=this.get("previousBatchTokens");
var nextBatchTokens=this.get("nextBatchTokens");
var totalRecords=this.get("totalRecords");
var firstPage=null;
var previousPage=null;
var nextPage=null;
var previousPages=[];
var nextPages=[];
var totalPages=Math.ceil(totalRecords/pageSize);
$.each(previousBatchTokens||[],function(i,token){var p=page-(i+1);
if(p==1){previousPages.push({page:p,data:{}});
}else{previousPages.push({page:p,data:{page:p,token:token}});
}});
$.each(nextBatchTokens||[],function(i,token){var p=page+(i+1);
nextPages.push({page:p,data:{page:p,token:token}});
});
if(page>2){firstPage={page:1,data:{}};
}if(page>1&&previousPages.length){previousPage=previousPages[0];
}if(page<totalPages&&nextPages.length){nextPage=nextPages[0];
}this.set({currentPage:page,firstPage:firstPage,previousPage:previousPage,nextPage:nextPage,previousPages:previousPages,nextPages:nextPages,totalPages:totalPages});
},initializeIndexPagination:function(){var index=this.get("index");
var pageSize=this.get("pageSize");
var navSize=this.get("navSize");
var totalRecords=this.get("totalRecords");
var firstPage=null;
var previousPage=null;
var nextPage=null;
var previousPages=[];
var nextPages=[];
var page=(index%pageSize)?Math.ceil(index/pageSize)+1:Math.floor(index/pageSize)+1;
totalRecords+=(index%pageSize)?pageSize-index%pageSize:0;
var totalPages=Math.ceil(totalRecords/pageSize);
var firstPageData={page:1,data:{}};
if(totalPages<navSize){navSize=totalPages;
}for(var i=1;
i<navSize;
i++){var previousNavPage=page-i;
var nextNavPage=page+i;
if(previousNavPage>=1){if(previousNavPage==1){previousPages.push(firstPageData);
}else{previousPages.push({page:previousNavPage,data:{page:previousNavPage,index:index-pageSize*i,pageSize:pageSize,currentPage:page}});
}}if(nextNavPage<=totalPages){nextPages.push({page:nextNavPage,data:{page:nextNavPage,index:index+pageSize*i,pageSize:pageSize,currentPage:page}});
}}if(page>2){firstPage=firstPageData;
}if(page>1&&previousPages.length){previousPage=previousPages[0];
}if(page<totalPages&&nextPages.length){nextPage=nextPages[0];
}this.set({currentPage:page,firstPage:firstPage,previousPage:previousPage,nextPage:nextPage,previousPages:previousPages,nextPages:nextPages,totalPages:totalPages});
},hasMultiplePages:function(){return this.get("totalPages")>1;
},hasFirstPage:function(){return this.get("firstPage");
},hasPreviousPage:function(){return this.get("previousPage");
},hasNextPage:function(){return this.get("nextPage");
}});
}(jQuery));
(function($){FBA.Core.Model.AfnFees=FBA.Core.Model.AfnFees.replace({defaults:{price:0,unitsSold:1}});
}(jQuery));
(function($){FBA.Core.Model.MfnFees=FBA.Core.Model.MfnFees.replace({defaults:{price:0,unitsSold:1}});
}(jQuery));
(function($){FBA.Core.Model.AsinGuidanceRecommendation=FBA.Core.Model.AsinGuidanceRecommendation.replace({});
}(jQuery));
(function($){FBA.Core.Model.BoxItem=APF.Model.Base.extend({});
}(jQuery));
(function($){FBA.Core.Model.Box=FBA.Core.Model.Box.replace({defaults:{boxNumber:1,shipmentName:""},initialize:function(){this.items=new FBA.Core.Collection.BoxItems();
}});
}(jQuery));
(function($){FBA.Core.Model.UissProperty=FBA.Core.Model.UissProperty.replace({});
})(jQuery);
(function($){FBA.Core.Model.WorkflowInstrumentation=FBA.Core.Model.WorkflowInstrumentation.replace({setWorkflowName:function(workflowName){this.setAttr("page-type",workflowName);
},setWorkflowStep:function(workflowStep){this.setAttr("sub-page-type",workflowStep);
}});
}(jQuery));
(function($){FBA.Core.Collection.CisCartons=FBA.Core.Collection.CisCartons.replace({shipmentId:"",initialize:function(){var models=arguments[0];
var options=arguments[1];
options||(options={});
this.shipmentId=options.shipmentId;
APF.Collection.Base.prototype.initialize.call(this,options);
},fetch:function(options){options||(options={});
this.models=[];
options=$.extend(true,{data:{shipmentId:this.shipmentId,pageSize:options.pageSize||1000,pageStartIndex:options.pageStartIndex||0}},options);
return APF.Collection.Base.prototype.fetch.call(this,options);
},save:function(options){options||(options={});
options.modelAttributes={shipmentId:this.shipmentId};
var removedCartonIds=this.getRemovedCartonIdsIfAny();
if(removedCartonIds.length>0){$.extend(true,options,{modelAttributes:{cartonIds:removedCartonIds}});
}var that=this;
var attachCartonIds=function(resp){var newModels=[];
$.each(that.models,function(){if(this.isNew()){newModels.push(this);
}});
if(resp&&resp.data&&resp.data.cartonIds.length===newModels.length){var cartonIds=resp.data.cartonIds;
for(var i=0;
i<newModels.length;
i++){newModels[i].set({cartonId:cartonIds[i]});
}}};
$.extend(true,options,{attachModelIds:attachCartonIds});
return APF.Collection.Base.prototype.save.call(this,options);
},setWeight:function(weight){$.each(this.models,function(){this.set({weight:weight});
});
},removeAll:function(options){var that=this;
options||(options={});
options.callback=options.callback||$.nop;
options.modelAttributes={shipmentId:this.shipmentId,removeAll:true};
options.success=function(response){options.callback();
};
this.reset([]);
this.sync("delete",this,options);
},markForRemoval:function(model){model=this.get(model);
if(model){model.isMarkedForRemoval=true;
}},getRemovedCartonIdsIfAny:function(){var removedCartonIds=_(this.filter(function(cartonModel){return cartonModel.isMarkedForRemoval;
})).chain().pluck("id").value();
return removedCartonIds;
},appendNewCartons:function(numCartons,cartonOrigin){for(var i=0;
i<numCartons;
i++){var newCarton=new FBA.Core.Model.CisCarton();
newCarton.set({isSingleAsinDeclaredByUser:false,owner:"MERCHANT",origin:cartonOrigin});
this.add(newCarton);
}},removeCartons:function(numCartons){for(var i=1;
i<numCartons+1;
i++){var indexToRemove=this.size()-i,cartonToRemove=this.models[indexToRemove];
this.markForRemoval(cartonToRemove.get("cartonId"));
}},removeCarton:function(carton){if(carton.isNew()){this.remove(carton);
}else{carton.isMarkedForRemoval=true;
}},markAllForRemoval:function(){var that=this;
this.models.slice().forEach(function(carton){that.removeCarton(carton);
});
},getUnremovedCartons:function(){return _.filter(this.models,function(model){return !model.isMarkedForRemoval;
});
}});
})(jQuery);
(function($){FBA.Core.Collection.CisCartonItems=FBA.Core.Collection.CisCartonItems.replace({shipmentId:"",initialize:function(){var options=arguments[1];
options||(options={});
if(!options.shipmentId){throw new Error("shipmentId needs to be passed in to know which items to fetch");
}this.shipmentId=options.shipmentId;
APF.Collection.Base.prototype.initialize.call(this,options);
},fetch:function(options){options||(options={});
if(!options.data.cartonIdList){throw new Error("cartonIdList needs to be passed in to know which items to fetch");
}this.models=[];
options=$.extend(true,{data:{isRemoved:0,shipmentId:this.shipmentId,pageSize:1000,pageStartIndex:0}},options);
return APF.Collection.Base.prototype.fetch.call(this,options);
},save:function(options){options||(options={});
options.modelAttributes={shipmentId:this.shipmentId,skipExpDateValidation:options.skipExpDateValidation};
var removedCartonItems=this.getRemovedCartonItems();
if(removedCartonItems){$.extend(true,options,{modelAttributes:{cartonIdAndMSkuList:removedCartonItems}});
}APF.Collection.Base.prototype.save.call(this,options);
},markForRemoval:function(model){if(model){model.isMarkedForRemoval=true;
model.id=model.get("cartonId")+"_"+model.get("merchantSku");
}},undoMarkForRemoval:function(model){if(model){model.isMarkedForRemoval=false;
model.id=undefined;
}},getRemovedCartonItems:function(){var removedCartonItems=[];
$.each(this.models,function(){if(this.isMarkedForRemoval){var removedCartonId=this.get("cartonId");
var removedCartonMerchantSkus=_.find(removedCartonItems,function(model){return model.cartonId===removedCartonId;
});
if(removedCartonMerchantSkus){removedCartonMerchantSkus.merchantSkus.push(this.get("merchantSku"));
}else{removedCartonItems.push({cartonId:this.get("cartonId"),merchantSkus:[this.get("merchantSku")]});
}}});
return removedCartonItems;
},hasCartonItems:function(cartonId){var hasCartonItems=false;
$.each(this.models,function(){var cartonItem=this,cartonItemCartonId=cartonItem.get("cartonId");
if(cartonId===cartonItemCartonId&&!cartonItem.isMarkedForRemoval){hasCartonItems=true;
}});
return hasCartonItems;
}});
})(jQuery);
(function($){FBA.Core.Collection.CisCasePackedCartonConfigurations=FBA.Core.Collection.CisCasePackedCartonConfigurations.replace({initialize:function(models,options){options=options||{};
this.shipmentItems=options.shipmentItems||(new FBA.Core.Collection.ShipmentItems());
this.shipment=options.shipment||(new FBA.Core.Model.Shipment());
this._cidToIndex={};
this._mSkuToCids={};
APF.Collection.Base.prototype.initialize.call(this,options);
this.bind("add",this.onAdd,this);
this.bind("remove",this.onRemove,this);
},fetch:function(options){var shipment=this.shipment;
var shipmentItems=this.shipmentItems;
var shipmentItemsCallback=_.bind(function(){APF.Collection.Base.prototype.fetch.call(this,options);
shipmentItems.unbind("add",shipmentItemsCallback);
},this);
if(shipment.get("totalLineItems")>100&&shipmentItems.length<=100){this.fetchAdditionalShipmentItems({callback:function(additionalShipmentItems){var shipmentItemsToAdd=additionalShipmentItems.filter(function(additionalItem){return !shipmentItems.get(additionalItem);
}).map(function(additionalItem){return additionalItem.toJSON();
});
shipmentItems.add(shipmentItemsToAdd,{silent:true});
shipmentItemsCallback();
}});
}else{if(!shipmentItems.hasBeenSynced){shipmentItems.bind("add",shipmentItemsCallback);
}else{shipmentItemsCallback();
}}},fetchAdditionalShipmentItems:function(options){var shipmentId=this.shipment.get("id");
var additionalShipmentItems=new FBA.Core.Collection.ShipmentItems();
var callback=options.callback||$.noop;
var pageSize=options.pageSize||1000;
additionalShipmentItems.fetch({data:{shipmentId:shipmentId,pageSize:pageSize},callback:function(){callback(additionalShipmentItems);
}});
},syncFromCache:function(){return;
},_prepareModel:function(model,options){model=APF.Collection.Base.prototype._prepareModel.call(this,model,options);
if(this.shipmentItems===undefined){return model;
}var shipmentItem=this.shipmentItems.filter(function(item){return item.get("mSku")===model.get("merchantSku");
})[0];
if(shipmentItem===undefined){shipmentItem=new FBA.Core.Model.ShipmentItem();
}model.shipmentItem=shipmentItem;
return model;
},isExpDateRequiredForAnyItem:function(){return this.shipment.get("totalLineItemsRequiringExpDate")>0;
},isLastConfigurationByMsku:function(model){var byMsku=this._mSkuToCids[model.get("merchantSku")];
return _.last(byMsku)===model.cid;
},isFirstConfigurationByMsku:function(model){var byMsku=this._mSkuToCids[model.get("merchantSku")];
return _.first(byMsku)===model.cid;
},containsMsku:function(mSku){var byMsku=this._mSkuToCids[mSku];
return byMsku!==undefined&&!_.isEmpty(byMsku);
},totalNumberOfCartons:function(){return this.reduce(function(runningSum,model){return runningSum+(model.get("numberOfCartons")||0);
},0);
},getByMsku:function(mSku){var collection=this;
var cids=this._mSkuToCids[mSku]||[];
return _.map(cids,_.bind(this.getByCid,this));
},removeByMsku:function(mSku,options){var modelsToRemove=this.getByMsku(mSku);
this.remove(modelsToRemove,options);
return modelsToRemove;
},comparator:function(model){return model.get("merchantSku");
},sortedIndex:function(model){var mSku=model.get("merchantSku");
var byMsku=this._mSkuToCids[mSku];
var byCid=this._cidToIndex;
if(byMsku!==undefined){var lastModelOfMsku=_.last(byMsku);
return byCid[lastModelOfMsku]+1;
}return APF.Collection.Base.prototype.sortedIndex.call(this,model,this.comparator);
},_reset:function(options){APF.Collection.Base.prototype._reset.call(this,options);
this._cidToIndex={};
this._mSkuToCids={};
},onAdd:function(model){var mSku=model.get("merchantSku");
var mSkuToCids=this._mSkuToCids;
if(!mSkuToCids.hasOwnProperty(mSku)){mSkuToCids[mSku]=[];
}mSkuToCids[mSku].push(model.cid);
this.updateCidToIndex();
return model;
},onRemove:function(model){var mSku=model.get("merchantSku");
var mSkuToCids=this._mSkuToCids;
mSkuToCids[mSku]=_.without(mSkuToCids[mSku],model.cid);
this.updateCidToIndex();
return model;
},updateCidToIndex:function(){this._cidToIndex={};
this.each(function(model,index){this._cidToIndex[model.cid]=index;
},this);
},_add:function(model,options){var addedModel=APF.Collection.Base.prototype._add.call(this,model,options);
if(options&&options.silent){this.onAdd(addedModel);
}return addedModel;
},_remove:function(model,options){var removedModel=APF.Collection.Base.prototype._remove.call(this,model,options);
if(options&&options.silent){this.onRemove(model);
}return removedModel;
}});
})(jQuery);
(function($){FBA.Core.Collection.ItemsType={getItemQuantityBySize:function(model){if(model.get("type")==="SORTABLE"){return this.getSortableQuantity();
}else{if(model.get("type")==="NON_SORTABLE"){return this.getNonSortableQuantity();
}else{if(model.get("type")==="HAZMAT"){return this.getHazmatQuantity();
}else{return 0;
}}}},getSortableQuantity:function(){var qty=0;
_.each(this.models,function(model){if(model.getSize()==="SORTABLE"){qty+=model.getQuantity();
}});
return qty;
},getNonSortableQuantity:function(){var qty=0;
_.each(this.models,function(model){if(model.getSize()==="NON_SORTABLE"){qty+=model.getQuantity();
}});
return qty;
},getHazmatQuantity:function(){var qty=0;
_.each(this.models,function(model){if(model.getSize()==="HAZMAT"){qty+=model.getQuantity();
}});
return qty;
}};
}(jQuery));
(function($){FBA.Core.Collection.CapacityUsages=FBA.Core.Collection.CapacityUsages.replace({updateSortableUtilization:function(qty){_.each(this.models,function(model){if(model.get("type")==="SORTABLE"){if(!model.has("originalUtilization")){model.set({originalUtilization:model.get("utilization")},{silent:true});
}var totalQty=model.get("originalUtilization")+qty;
model.set({utilization:totalQty});
}});
},updateNonSortableUtilization:function(qty){_.each(this.models,function(model){if(model.get("type")==="NON_SORTABLE"){if(!model.has("originalUtilization")){model.set({originalUtilization:model.get("utilization")},{silent:true});
}var totalQty=model.get("originalUtilization")+qty;
model.set({utilization:totalQty});
}});
},addUtilization:function(type,qty){$.each(this.models,function(){if(this.get("type")==type){this.setAttr("utilization",(this.get("utilization")||0)+qty);
return false;
}});
},getAtLimit:function(){var atLimit;
$.each(this.models,function(){if(this.isAtLimit()){atLimit=this;
return false;
}});
return atLimit;
}});
}(jQuery));
(function($){FBA.Core.Collection.Shipments=FBA.Core.Collection.Shipments.replace({fetch:function(options){var callback=options.callback;
var customCallback=function(response){$.each(response.models,function(){this.setInitialLabelQuantity();
});
callback(response);
};
options.callback=customCallback;
APF.Collection.Base.prototype.fetch.call(this,options);
},associations:{carrierShipments:{collection:"FBA.Core.Collection.CarrierShipments",attributes:{shipmentId:"shipmentIds"}},defectAcknowledgementStatus:{collection:"FBA.Core.Collection.ShipmentDefectAcknowledgementStatus",attributes:{shipmentId:"shipmentIds"}}}});
}(jQuery));
(function($){$.extend(FBA.Core.Collection.ShipmentItems.prototype,FBA.Core.Collection.ItemsType);
FBA.Core.Collection.ShipmentItems=FBA.Core.Collection.ShipmentItems.replace({associations:{capacityLimits:{collection:"FBA.Core.Collection.CapacityLimits",attributes:{mSku:"mSkus"}}},fetch:function(options){var callback=options.callback||$.noop;
var customCallback=function(response){if(!options.skipSetInitialLabelQuantity){$.each(response.models,function(){this.setInitialLabelQuantity();
});
}callback(response);
};
options.callback=customCallback;
APF.Collection.Base.prototype.fetch.call(this,options);
},getItemByMsku:function(msku){var shipmentItem=_.find(this.models,function(model){return model.get("mSku")===msku;
});
return shipmentItem;
}});
}(jQuery));
(function($){FBA.Core.Collection.SearchShipments=FBA.Core.Collection.SearchShipments.replace({});
}(jQuery));
(function($){$.extend(FBA.Core.Collection.ManifestItems.prototype,FBA.Core.Collection.ItemsType);
FBA.Core.Collection.ManifestItems=FBA.Core.Collection.ManifestItems.replace({totalUnits:function(){var sum=_.reduce(this.models,function(num,model){return num+model.getQuantity();
},0);
return sum;
},enablePrintLabels:function(models){var showPrintLabels=false;
var currentModels=models||this.models;
if(this.manifest.get("totalLabelQuantity")==0){return false;
}$.each(currentModels,function(i,model){$.each(model.get("prepInstructions"),function(j,prepInstruction){if(prepInstruction.prepType==="ITEM_LABELING"&&prepInstruction.prepOwner==="MERCHANT"){showPrintLabels=true;
return false;
}});
if(showPrintLabels){return false;
}});
return showPrintLabels;
},updateQuantity:function(models,quantity){$.each(models||this.models,function(i,model){model.updateQuantity(quantity);
});
},updateException:function(models,exceptionCode){var count=0;
$.each(models||this.models,function(i,model){count+=model.updateException(exceptionCode);
});
return count;
},addException:function(models,exceptionCode){var count=0;
$.each(models||this.models,function(i,model){count+=model.addException(exceptionCode);
});
return count;
},updateCategory:function(models,category){var prepModel=APF.getAttr("prep-categories").filterByCategory(category)[0];
var manifestItems=models||this.models;
$.each(manifestItems,function(){this.updateCategory(prepModel,category);
});
this.save({models:manifestItems});
},removeException:function(models,exceptionCode){var count=0;
$.each(models||this.models,function(i,model){count+=model.removeException(exceptionCode);
});
return count;
}});
}(jQuery));
(function($){FBA.Core.Collection.MerchantAddress=FBA.Core.Collection.MerchantAddress.replace({getPreferredAddress:function(){if(this.size){return this.at(0);
}return null;
}});
}(jQuery));
(function($){FBA.Core.Collection.PrepDetails=FBA.Core.Collection.PrepDetails.replace({filterByCategory:function(category){return this.filter(function(model){return model.get("prepCategory")==category;
});
}});
}(jQuery));
(function($){FBA.Core.Collection.PrepDisputes=FBA.Core.Collection.PrepDisputes.replace({addItems:function(items){var that=this;
$.each(items.models,function(){that.add({id:this.get("asin"),asin:this.get("asin"),prepDisputeStatus:"INVESTIGATE"});
});
}});
}(jQuery));
(function($){FBA.Core.Collection.Carriers=FBA.Core.Collection.Carriers.replace({getCarriersByType:function(type){var models=[];
$.each(this.models||[],function(){if(this.get("type")==type){models.push(this);
}});
return models;
},getSpdCarriers:function(){return this.getCarriersByType("SMALL_PARCEL");
},getLtlCarriers:function(){return this.getCarriersByType("LTL");
},getFreightCarriers:function(){return this.getCarriersByType("FREIGHT");
}});
}(jQuery));
(function($){FBA.Core.Collection.CarrierShipmentBoxes=APF.Collection.Base.extend({model:null,type:"",initialize:function(models,options){this.carrierShipment=options.carrierShipment;
var carrierShipment=this.carrierShipment;
var that=this;
APF.Collection.Base.prototype.initialize.call(this,models,options);
var reset=function(){that.reset(that.objToModels(carrierShipment.get(that.type)),{silent:true});
that.setBoxes();
};
if(!options.ignoreAllEvents){carrierShipment.bind("reset",reset);
carrierShipment.bind("change:"+this.type,reset);
this.bind("add",this.setBoxes,this);
this.bind("reset",function(){that.setBoxes();
});
this.bind("change",function(){that.setBoxes();
});
this.bind("remove",function(){that.setBoxes();
});
}},setBoxes:$.noop,isEmpty:function(){var models=this.models;
var isEmpty=true;
$.each(models||[],function(){if(!this.isEmpty()){isEmpty=false;
}});
return isEmpty;
},save:function(){this.carrierShipment.save();
},hasValidWeight:function(){var hasValidWeight=true;
var isInternalShipment=this.carrierShipment.getAttr("isInternalShipment");
$.each(this.models,function(i,model){var weight=model.get("weight");
hasValidWeight=(weight===null||weight===""||weight);
if(!hasValidWeight){return false;
}});
return hasValidWeight;
}});
}(jQuery));
(function($){FBA.Core.Collection.CarrierShipmentPackages=FBA.Core.Collection.CarrierShipmentBoxes.extend({model:FBA.Core.Model.CarrierShipmentPackage,type:"packages",setBoxes:function(){var carrierShipment=this.carrierShipment;
var packages=[];
var totalWeight=0;
var totalVolume=0;
var that=this;
var dimensions;
$.each(this.models,function(i,model){var n=i+1;
packages.push($.extend(model.toJSON(),{number:n,status:"SHIPPED"}));
model.set({number:n},{silent:true});
model.trigger("change:number");
totalWeight+=model.get("weight")||0;
dimensions=model.get("dimensions");
totalVolume+=dimensions.length*dimensions.width*dimensions.height;
});
totalWeight=+totalWeight.toFixed(2);
totalVolume=+totalVolume.toFixed(2);
carrierShipment.set({packages:packages},{silent:true});
this.setAttr("totalCount",packages.length);
this.setAttr("totalWeight",totalWeight);
this.setAttr("totalVolume",totalVolume);
this.trigger("change:data");
this.trigger("change:totalCount");
},isTotalWeightValid:function(){var carrierShipment=this.carrierShipment;
var totalWeight=this.getAttr("totalWeight");
var maxTotalWeight=carrierShipment.get("maxTotalWeight");
var isInternalShipment=carrierShipment.getAttr("isInternalShipment");
if(!isInternalShipment||maxTotalWeight==0){return true;
}return FBA.Core.Util.isValueBetween(totalWeight,0,maxTotalWeight);
},isTotalVolumeValid:function(){var carrierShipment=this.carrierShipment;
var totalVolume=this.getAttr("totalVolume");
var maxTotalVolume=carrierShipment.get("maxTotalVolume");
var isInternalShipment=carrierShipment.getAttr("isInternalShipment");
if(!isInternalShipment||maxTotalVolume==0){return true;
}return FBA.Core.Util.isValueBetween(totalVolume,0,maxTotalVolume);
},isValid:function(options){var isPackagesValid=true;
if(!FBA.Core.Collection.CarrierShipmentBoxes.prototype.isValid.call(this,options)){isPackagesValid=false;
}if(this.isOverAPCBoxLimit()){isPackagesValid=false;
}if(!this.isTotalWeightValid()){isPackagesValid=false;
}if(!this.isTotalVolumeValid()){isPackagesValid=false;
}return isPackagesValid;
},isHeavyWeight:function(){var isHeavyWeight=false;
var that=this;
$.each(this.models,function(){if(this.isHeavyWeight()){isHeavyWeight=true;
return false;
}});
return isHeavyWeight;
},isOverMaxWeight:function(){var isOverMaxWeight=false;
var that=this;
$.each(this.models,function(){if(this.isOverMaxWeight()){isOverMaxWeight=true;
return false;
}});
return isOverMaxWeight;
},isOverTotalSize:function(){var isOverTotalSize=false;
var that=this;
$.each(this.models,function(){if(this.isOverTotalSize()){isOverTotalSize=true;
return false;
}});
return isOverTotalSize;
},isLargeSize:function(){var isLargeSize=false;
var that=this;
$.each(this.models,function(){if(this.isLargeSize()){isLargeSize=true;
return false;
}});
return isLargeSize;
},isDimWeightSurcharge:function(){var isDimWeightSurcharge=false;
var that=this;
var carrierShipment=this.carrierShipment;
var isInternalShipment=carrierShipment.getAttr("isInternalShipment");
if(!isInternalShipment){return false;
}$.each(this.models,function(i,model){if(this.isDimWeightSurcharge()){isDimWeightSurcharge=true;
return false;
}});
return isDimWeightSurcharge;
},isOverAPCBoxLimit:function(){var carrierShipment=this.carrierShipment;
if(carrierShipment.getAttr("isInternalShipment")){var packageCount=this.getAttr("totalCount");
return packageCount>carrierShipment.getAttr("maxNumberOfPackages");
}else{return false;
}},isValidTotalCount:function(){var carrierShipment=this.carrierShipment;
var packageCount=this.getAttr("totalCount");
return packageCount>=APF.getAttr("minPackageCountSPDNAPC")&&packageCount<=APF.getAttr("maxPackageCountSPDNAPC");
}});
}(jQuery));
(function($){FBA.Core.Collection.CarrierShipmentPalletGroups=FBA.Core.Collection.CarrierShipmentBoxes.extend({model:FBA.Core.Model.CarrierShipmentPalletGroup,type:"palletGroups",initialize:function(models,options){FBA.Core.Collection.CarrierShipmentBoxes.prototype.initialize.call(this,models,options);
this.carrierShipment.bind("change:ltlData",this.checkChangedPalletGroups,this);
},checkChangedPalletGroups:function(){var ltlData=this.carrierShipment.get("ltlData");
if(this.length&&(!ltlData||!ltlData.palletGroups)){this.reset();
}if(ltlData&&ltlData.palletGroups&&ltlData.palletGroups.length!=this.length){this.reset(ltlData.palletGroups);
}},setBoxes:function(){var carrierShipment=this.carrierShipment;
var palletGroups=[];
var totalWeight=0;
var totalPalletCount=0;
var totalStackablePalletCount=0;
var totalUnstackablePalletCount=0;
var that=this;
$.each(this.models,function(){var model=this;
totalWeight+=model.get("weight")||0;
totalPalletCount+=model.get("palletCount")||0;
if(model.get("isStacked")){totalStackablePalletCount+=model.get("palletCount")||0;
}else{totalUnstackablePalletCount+=model.get("palletCount")||0;
}palletGroups.push(model.toJSON());
});
var ltlData=$.extend({},carrierShipment.get("ltlData"));
ltlData.weight=totalWeight;
ltlData.palletGroups=palletGroups;
this.setAttr("totalWeight",totalWeight);
this.setAttr("totalPalletCount",totalPalletCount);
this.setAttr("totalStackablePalletCount",totalStackablePalletCount);
this.setAttr("totalUnstackablePalletCount",totalUnstackablePalletCount);
carrierShipment.setAttr("ltlData",ltlData);
this.trigger("change:data");
},isTotalWeightValid:function(){var weight=this.getAttr("totalWeight");
return FBA.Core.Util.isValueBetween(weight,150,40000);
},isTotalPalletCountValid:function(){var isPalletCountValid=false;
var numTotalPallets=this.getAttr("totalPalletCount");
if(FBA.Core.Util.isValueBetween(numTotalPallets,1,26)){isPalletCountValid=true;
}return isPalletCountValid;
},isValid:function(options){var isEverythingValid=true;
if(!FBA.Core.Collection.CarrierShipmentBoxes.prototype.isValid.call(this,options)){isEverythingValid=false;
}if(this.length&&(!this.isTotalWeightValid()||!this.isTotalPalletCountValid()||!this.hasValidSinglePalletWeight())){isEverythingValid=false;
}return isEverythingValid;
},hasValidSinglePalletWeight:function(){var hasValidSinglePalletWeight=true;
$.each(this.models,function(i,model){var weight=model.getSinglePalletWeight();
if(!weight||!(FBA.Core.Util.isValueBetween(weight,1,1500))){hasValidSinglePalletWeight=false;
}});
return hasValidSinglePalletWeight;
},hasValidSinglePalletCount:function(){var hasAllValidPalletCount=true;
var hasValidPalletCount=true;
$.each(this.models,function(i,model){var palletCount=model.get("palletCount");
hasValidPalletCount=(!palletCount&&palletCount!==""&&palletCount!==null&&palletCount!==undefined)?false:true;
if(!hasValidPalletCount){hasAllValidPalletCount=false;
}});
return hasAllValidPalletCount;
}});
}(jQuery));
(function($){FBA.Core.Collection.Defects=FBA.Core.Collection.Defects.replace({getAndonCordDefect:function(type){var defectModels=this.models;
if(!defectModels.length){return;
}var returnModel;
$.each(defectModels,function(i,defectModel){if(defectModel.get("isAllowAcknowledged")&&(defectModel.get("andonPullReason")==type)){returnModel=defectModel;
return false;
}});
return returnModel;
},haveUnacknowledgedDefects:function(){var result=false;
$.each(this.models,function(i,defectModel){if(defectModel.get("isAllowAcknowledged")&&!(defectModel.get("acknowledgement"))){result=true;
return false;
}});
return result;
},haveNotAllowAcknowledgedDefects:function(){var result=false;
$.each(this.models,function(i,defectModel){if(defectModel.get("isAndonPull")&&!defectModel.get("isAllowAcknowledged")&&!(defectModel.get("acknowledgement"))){result=true;
return false;
}});
return result;
},getAndonPullReasonForShipment:function(){var result="";
$.each(this.models,function(i,defectModel){if(defectModel.get("isAndonPull")&&!(defectModel.get("acknowledgement"))){result=defectModel.get("andonPullReason");
if(result==="SHIPMENT"||result==="SHIPMENT_AUTO_ANDON"){return false;
}}});
return result;
}});
}(jQuery));
(function($){FBA.Core.Collection.EligibleShipments=FBA.Core.Collection.EligibleShipments.replace({});
}(jQuery));
(function($){FBA.Core.Collection.AsinGuidanceRecommendations=FBA.Core.Collection.AsinGuidanceRecommendations.replace({updateAsinsList:function(asin,mSku){this.add([{id:asin,mSku:mSku,targetQuantity:-1}]);
}});
}(jQuery));
(function($){FBA.Core.Collection.BoxItems=APF.Collection.Base.extend({model:FBA.Core.Model.BoxItem});
}(jQuery));
(function($){FBA.Core.Collection.Boxes=APF.Collection.Base.extend({model:FBA.Core.Model.Box});
}(jQuery));
(function($){FBA.Core.View.InboundPerformance=APF.View.Base.extend({initialize:function(options){var template=$("#fba-core-template-inbound-performance");
this.capacityUsages=options&&options.capacityUsages||new FBA.Core.Collection.CapacityUsages();
if(!template.length){return;
}this.el=$(this.el);
this.template=_.template(template.html());
this.window=$(window);
this.body=$("body");
this.bodyPadding=parseInt(this.body.css("padding-bottom"))||20;
this.isIE6=$.browser.msie&&$.browser.version.substr(0,1)=="6";
this.interval=null;
this.nodeName=undefined;
var that=this;
this.showInboundPerformanceForIndia=false;
$(".fba-core").filter(":first").append(this.el);
if(this.showNodeCapacity()){APF.bind("change:nodeName",this.fetchNodeCapacity,this);
this.nodeName=this.getNodeName();
}else{this.capacityUsages.fetch({callback:function(response){that.render();
}});
}this.capacityUsages.bind("change",this.render,this);
},fetchNodeCapacity:function(){if((this.nodeName==undefined)||(this.nodeName!=this.getNodeName())){this.nodeName=this.getNodeName();
this.fetchNodeStorageMonitor();
}},render:function(){if(this.interval){this.clearInterval(interval);
}if(!this.capacityUsages.length){return;
}var showStorageMonitor=false;
var layoutEl=$("#fba-core-inbound-performance",this.el);
var that=this;
$.each(this.capacityUsages.models,function(i,capacityUsage){if(capacityUsage.get("limit")){showStorageMonitor=true;
return false;
}});
if(showStorageMonitor){this.displayStorageMonitor();
if(this.isIE6){layoutEl.css("position","absolute");
layoutEl.css("top",(this.window.height()+this.window.scrollTop())-layoutEl.outerHeight());
this.interval=setInterval(function(){layoutEl.css("top",(that.window.height()+that.window.scrollTop())-layoutEl.outerHeight());
},15);
}this.body.css("padding-bottom",layoutEl.outerHeight()+this.bodyPadding);
}var events={"click  #show-hazmat-storage-monitor-helper":"hazmatStorageMonitorHelper"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
},hazmatStorageMonitorHelper:function(e){e.preventDefault();
e.stopPropagation();
var popOverWidth=400;
this.coveragePopover=new APF.View.Popover({localContent:"#hazmat-helper-content",width:popOverWidth,location:this.positionHazmatHelperPopover});
this.coveragePopover.render();
},positionHazmatHelperPopover:function(){return{left:$("#show-hazmat-storage-monitor-helper").offset().left-250,top:$("#show-hazmat-storage-monitor-helper").offset().top-175};
},showNodeCapacity:function(){return APF.getAttr("isIndianFC");
},getNodeName:function(){var fcName=undefined;
var nodeName=undefined;
if(APF){nodeName=APF.getAttr("nodeName");
if(nodeName){fcName=nodeName;
}else{var manifest=APF.getAttr("manifest");
if(manifest&&manifest.getAttr("destinationRegions")){fcName=manifest.getAttr("destinationRegions")[0].regionName;
}}}if(fcName==="ANY_REGION"){fcName=undefined;
}return fcName;
},fetchNodeStorageMonitor:function(){this.capacityUsages.reset();
var that=this;
this.capacityUsages.fetch({data:{nodeNames:this.nodeName},callback:function(){that.render();
}});
},displayStorageMonitor:function(){if(this.showNodeCapacity()){this.showInboundPerformanceForIndia=true;
}this.el.html($(this.template({capacityUsages:this.capacityUsages,showInboundPerformanceForIndia:this.showInboundPerformanceForIndia,nodeName:this.nodeName})));
}});
}(jQuery));
(function($){FBA.Core.Util.AsinGuidance=FBA.Core.Util.AsinGuidance||{};
FBA.Core.Util.AsinGuidance.Manager=Backbone.Model.extend({initialize:function(options){this.models=options.models;
this.guidance={};
},addCapacityLimits:function(capacityCollection){var that=this;
_.each(capacityCollection,function(cap){var key=cap.get("capacityGroupKey");
var limit=cap.get("guidanceLimit");
if(key&&limit){that.guidance[key]=parseInt(limit,10);
_.find(that.models,function(model){if(model.get("mSku")===key){model.set({guidanceLimit:limit,hasGuidance:true});
}});
}});
},getLimit:function(capacityGroup){if(this.guidance[capacityGroup]){return this.guidance[capacityGroup];
}else{return;
}},canAddQty:function(capacityGroup,qty){if(this.guidance[capacityGroup]){return this.guidance[capacityGroup]>=parseInt(qty,10);
}else{return true;
}}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{applyDefaultText:function(inputEl){inputEl.focus(function(e){if(inputEl.val()===inputEl.attr("data-defaultText")){inputEl.attr("value","");
inputEl.removeClass("label");
}});
inputEl.blur(function(e){if($.trim(inputEl.val())==""){inputEl.attr("value",inputEl.attr("data-defaultText"));
inputEl.addClass("label");
}});
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{isValidEmail:function(email){var patt=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
if(patt.exec(email)===null){return false;
}return true;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{isValidNonZeroInteger:function(val){if(parseInt(val)==0){return false;
}return true;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{isValidPhone:function(phone){var patt=/[0-9-()+]{3,20}/;
if(patt.exec(phone)===null){return false;
}return true;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{validateNumeric:function(container){$(container).bind("keypress",function(e){var key=e.which;
var input=$(e.target);
if(!input.hasClass("fba-core-input-number")&&!input.hasClass("number")&&!input.hasClass("validate-positive-float")){return true;
}if(key===13||key===9||key===0||key===null||key===8||key===27){return true;
}var val=String.fromCharCode(key);
if(input.hasClass("validate-positive-float")){return FBA.Core.Util.positiveFloat(val);
}else{return FBA.Core.Util.positiveInteger(val);
}});
},positiveInteger:function(val){return FBA.Core.Util.stringMatch(val,"0123456789");
},positiveFloat:function(val){return FBA.Core.Util.stringMatch(val,".,0123456789");
},stringMatch:function(val,string){var valid=true;
if(!val){return false;
}$.each(val.split(""),function(){if(string.indexOf(this)===-1){valid=false;
return false;
}});
return valid;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{getRawNumber:function(val){var decSign=APF.merchant.get("decimalPoint");
var reg=new RegExp("([^0-9"+decSign+"])","g");
val=val.replace(reg,"");
if(decSign!=""){val=val.replace(decSign,".");
}return val;
},getInputNumber:function(val){val=val.toString();
var sign=val.charAt(0)=="-"?"-":"";
val=FBA.Core.Util.getRawNumber(val);
val=sign+val;
return parseFloat(val);
},getOutputNumber:function(val){if(val==""){return val;
}val=val||0;
val=val.toString();
var sign=val.charAt(0)=="-"?"-":"";
var decimal="";
var decSign=APF.merchant.get("decimalPoint");
var thousSign=APF.merchant.get("thousandsSeparator");
val=FBA.Core.Util.getRawNumber(val);
var p=val.indexOf(".");
if(p!=-1){decimal=val.substr(p+1);
val=val.substring(0,p);
}var start=(start=val.length)>3?start%3:0;
var newVal=sign+(start?val.substr(0,start)+thousSign:"")+val.substr(start).replace(/(\d{3})(?=\d)/g,"$1"+thousSign);
newVal+=decimal!=""?(decSign+decimal):"";
return newVal;
},getSumForFloatingPointNumbers:function(values,precision){var multiplier=Math.pow(10,precision);
var total=_.reduce(values,function(runningSum,currentValue){return runningSum+(currentValue*multiplier);
},0);
return total/multiplier;
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{isValidValueForInputField:function(value,isEmptyStringAcceptable,isZeroAcceptable){if(value==""&&isEmptyStringAcceptable){return true;
}else{if(value==0&&isZeroAcceptable){return true;
}else{if(value){return true;
}}}return false;
},isValueBetween:function(valueToCompare,lowValue,highValue){return(valueToCompare>=lowValue&&valueToCompare<=highValue);
}});
}(jQuery));
(function($){$.extend(FBA.Core.Util,{addReftagToUrl:function(options){if(!options||!options.url){return"";
}var params={url:options.url};
if(options.reftag){var reftag=options.reftag;
var attr=["to","from","where","treatment"];
$.each(attr,function(){if(reftag[this]){params[this]=reftag[this];
}});
}return SCUI.Tools.Reftag.addToUrl(params);
}});
}(jQuery));
(function($){FBA.Core.View.Progress=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.model=this.options.parent.model;
this.step=this.options.parent.progressStep||APF.getData().step;
if(this.model.get("shipmentId")){this.template=_.template($("#fba-core-templates-workflow-progress-shipment").html());
}else{this.template=_.template($("#fba-core-templates-workflow-progress-manifest").html());
}},enter:function(){APF.View.Base.prototype.enter.call(this);
if(this.model.get("manifestId")){this.model.bind("change:itemExceptionSummaries",this.render,this);
}},exit:function(){APF.View.Base.prototype.exit.call(this);
this.model.unbind("change:itemExceptionSummaries",this.render,this);
},render:function(){this.el.html(this.template({model:this.model,classes:this.getClasses()}));
},getClasses:function(){var classes={plan:"",prep:"",label:"",preview:""};
if(this.model.get("shipmentId")){return classes;
}if(this.model.get("workflowState")==="plan"||this.step==="plan"){classes.plan="current first";
if(!this.model.hasBlockingItemExceptions()){classes.prep="previous";
classes.label="previous";
classes.preview="previous";
}}if(this.model.get("workflowState")==="prep"){classes.plan="previous first";
classes.prep="current";
classes.label="previous";
classes.preview="previous";
}if(this.model.get("workflowState")==="preplabel"){classes.plan="previous first";
classes.prep="current";
classes.preview="previous";
}if(this.model.get("workflowState")==="label"){classes.plan="previous first";
classes.prep="previous";
classes.label="current";
classes.preview="previous";
}if(this.model.get("workflowState")==="preview"||!this.step){classes.plan="previous first";
classes.prep="previous";
classes.label="previous";
classes.preview="current";
}return classes;
}});
}(jQuery));
(function($){FBA.Core.View.Message=APF.View.Base.extend({initialize:function(options){this.el=options.el||$("#workflow-message");
this.template=_.template($("#fba-core-templates-workflow-message").html());
this.message=options.message;
this.messageType=options.messageType||"info";
},render:function(){this.el.html(this.template({messageType:this.messageType,message:this.message}));
$(this.el).fadeIn("slow");
}});
}(jQuery));
(function($){FBA.Core.View.MerchantAddress=APF.View.Base.extend({isEditable:true,initialize:function(options){this.el=$(this.el);
this.isEditable=options.isEditable!==undefined?options.isEditable:this.isEditable;
this.addressId=options.addressId;
this.manifestId=options.manifestId;
this.shipmentId=options.shipmentId;
this.manifestEditable=options.isManifest!==undefined?options.parent.model.isEditable():true;
var that=this;
var template=options.template||"#fba-core-template-merchant-address";
this.template=_.template($(template).html());
if(options.loadingTemplate){this.loadingTemplate=_.template($(options.loadingTemplate).html());
this.el.html(this.loadingTemplate());
}if(!this.model&&!this.collection){var address=new FBA.Core.Model.ShipFromAddress();
this.collection=new FBA.Core.Collection.ShipFromAddress();
this.collection.add(address);
address.fetch({data:{id:this.addressId},success:function(){that.collection.hasBeenSynced=true;
that.collection.trigger("reset");
}});
}},render:function(){var collection=this.collection;
if(collection&&!collection.hasBeenSynced){this.el.html(this.template({loading:true,manifestId:this.manifestId,shipmentId:this.shipmentId}));
return;
}if(!this.model){if(this.addressId){this.model=collection.get(this.addressId);
}else{if(collection.at(0).get("addressId")){this.model=collection.at(0);
}else{this.model=null;
}}}this.el.html(this.template({loading:false,model:this.model,manifestId:this.manifestId,shipmentId:this.shipmentId,isEditable:this.isEditable,manifestEditable:this.manifestEditable}));
},enter:function(){var events={"click #fba-core-merchant-address-change-link":"changeAddress"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
if(this.collection){this.collection.bind("reset",this.render,this);
}},exit:function(){if(this.collection){this.collection.unbind("reset",this.render);
}},changeAddress:function(e){e.preventDefault();
var addressForm=document.changeAddressForm;
addressForm.submit();
}});
}(jQuery));
(function($){FBA.Core.View.AsinGuidance=APF.View.Base.extend({initialize:function(options){this.el=options.el;
this.model=options.model;
this.template=_.template($("#fba-core-template-asin-guidance").html());
},render:function(){this.el.after(this.template({model:this.model}));
},showError:function(){$(this.el).addClass("fba-core-input-error");
$(this.el).next().addClass("error");
},hideError:function(){$(this.el).removeClass("fba-core-input-error");
$(this.el).next().removeClass("error");
}});
}(jQuery));
(function($){FBA.Core.View.AndonCordPull=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-andon-cord-pull").html());
this.el.html(this.template({}));
}});
}(jQuery));
(function($){FBA.Core.View.InboundBlockedError=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-inbound-blocked-error").html());
this.el.html(this.template({reasonCode:options.data.reasonCode}));
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataDestinationRegion=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-destination-region").html());
this.model=options.parent.model.manifest||options.parent.model;
},render:function(){if(this.model.get("manifestId")&&APF.getAttr("hasMultiCountryInbound")){this.el.html(this.template({model:this.model,showDestinationMarketplace:true,showShipToSubdivision:false}));
}else{if(this.model.get("manifestId")&&APF.getAttr("isIndianFC")&&APF.getAttr("hasDestinationSubdivisionDropdown")){var subdivisionCode=this.model.get("destinationRegions")[0]["regionName"];
APF.setAttr("nodeName",subdivisionCode);
this.el.html(this.template({model:this.model,showDestinationMarketplace:false,showShipToSubdivision:true,subdivisionName:subdivisionCode}));
}else{return false;
}}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanTypeTag=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-type-tag").html());
this.model=options.parent.model.manifest||options.parent.model;
},render:function(){if(APF.getAttr("hasImportTags")){this.el.html(this.template({manifest:this.model}));
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataMerchantAddress=FBA.Core.View.MerchantAddress.extend({initialize:function(options){var manifest=options.parent.model;
this.manifest=manifest;
options.loadingTemplate="#fba-inbound-manifest-workflow-template-shared-loading-generic-sm";
if(manifest){this.isEditable=manifest.isEditable();
options.addressId=manifest.get("fromAddressId");
options.manifestId=manifest.get("id");
options.isManifest=true;
}if(APF.getData().step=="preview"){options.isEditable=false;
}FBA.Core.View.MerchantAddress.prototype.initialize.call(this,options);
},render:function(){FBA.Core.View.MerchantAddress.prototype.render.call(this);
APF.setAttr("fromAddress",this.model);
},changeAddress:function(e){e.preventDefault();
if(APF.getAttr("offerItems")){var parameters=_(APF.getAttr("offerItems").models).reduce(function(memo,offerItem){return{query:memo.query+"&"+"mSku."+memo.i+"="+offerItem.get("mSku"),i:(memo.i+1)};
},{query:"",i:0}).query.substr(1);
if(FBA.InboundManifestWorkflow.nonOfferItems.length){var i=-1;
parameters=_(FBA.InboundManifestWorkflow.nonOfferItems).reduce(function(memo,item){i++;
return memo+_(_.keys(item)).reduce(function(memo1,field){return memo1+"&"+field+"."+i+"="+item[field];
},"");
},"");
parameters+=parameters?"&notAnOffer=1":"";
}}var addressForm=document.changeAddressForm;
addressForm.continueParameters.value=parameters;
addressForm.submit();
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataLayout=APF.View.Layout.extend({initialize:function(options){this.el=$(this.el);
this.el.html($("#fba-core-templates-workflow-meta-data-layout").html());
this.model=options.parent.model;
this.step=APF.getData().step||options.parent.metaDataStep||"base";
if(APF.getAttr("showCLIPlannedServicesFeePreview")){var prepareMetaViews=["FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentFees","FBA.Core.View.MetaDataShipmentStatus"];
var summaryMetaViews=["FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentFees","FBA.Core.View.MetaDataShipmentStatus"];
this.stepToPrimary["prepare"]=prepareMetaViews;
this.stepToPrimary["summary"]=summaryMetaViews;
this.stepToPrimaryWithImportTagTreatment["prepare"]=prepareMetaViews;
this.stepToPrimaryWithImportTagTreatment["summary"]=summaryMetaViews;
}if(APF.getAttr("hasImportTags")){this.layout["#fba-core-page-meta-primary"]=this.stepToPrimaryWithImportTagTreatment[this.step];
}else{this.layout["#fba-core-page-meta-primary"]=this.stepToPrimary[this.step];
}this.layout["#fba-core-page-meta-secondary"]=this.stepToSecondary[this.step];
APF.View.Layout.prototype.initialize.call(this,options);
},stepToPrimary:{plan:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType"],prep:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents"],label:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents"],preview:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents","FBA.Core.View.MetaDataPlanPrepCost"],base:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataPkgType"],prepare:["FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentStatus"],summary:["FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentStatus"]},stepToPrimaryWithImportTagTreatment:{plan:["FBA.Core.View.MetaDataPlanTypeTag","FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType"],prep:["FBA.Core.View.MetaDataPlanTypeTag","FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents"],label:["FBA.Core.View.MetaDataPlanTypeTag","FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataDestinationRegion","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents"],preview:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataPlanContents","FBA.Core.View.MetaDataPlanPrepCost"],base:["FBA.Core.View.MetaDataMerchantAddress","FBA.Core.View.MetaDataPkgType"],prepare:["FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentStatus"],summary:["FBA.Core.View.MetaDataShipFrom","FBA.Core.View.MetaDataShipmentName","FBA.Core.View.MetaDataShipTo","FBA.Core.View.MetaDataShipmentContents","FBA.Core.View.MetaDataShipmentStatus"]},stepToSecondary:{plan:[],prep:[],label:[],preview:[],base:[],prepare:["FBA.Core.View.MetaDataPkgType"],summary:["FBA.Core.View.MetaDataPkgType","FBA.Core.View.MetaDataShipMethod","FBA.Core.View.MetaDataShippingEstimate"]},layout:{},enter:function(){if(this.layout["#fba-core-page-meta-secondary"].length>0){$("#meta-data-show-hide").show();
}var events={"click #meta-data-show-more":"showMore"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Layout.prototype.enter.call(this);
},showMore:function(e){e.preventDefault();
var target=$(e.target);
var secondary=$("#fba-core-page-meta-secondary");
if(secondary.is(":visible")){target.html(APF.strings["show-more"]);
secondary.fadeOut("slow");
}else{target.html(APF.strings["show-less"]);
secondary.fadeIn("slow");
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanContents=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-contents").html());
this.model=options.parent.model.manifest||options.parent.model;
},render:function(){if(this.model.get("manifestId")){this.el.html(this.template({model:this.model}));
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanPrepCost=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-pkg-cost").html());
this.model=options.parent.model.manifest||options.parent.model;
},render:function(){var that=this;
if(this.model.get("manifestId")){this.model.fetch({data:{manifestId:this.model.get("manifestId")},success:function(){that.el.html(that.template({model:that.model}));
}});
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanName=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-name").html());
this.model=options.parent.model.manifest||options.parent.model;
this.allowSubmit=true;
this.isEditable=this.model.isEditable();
if(APF.getData().step=="preview"){this.isEditable=false;
}this.model.bind("change",this.render,this);
},render:function(){if(this.model.get("manifestId")){this.el.html(this.template({model:this.model,isEditable:this.isEditable}));
}else{return false;
}},enter:function(){var events={"click #change-plan-name":"changePlanName","keyup #plan-name":"validatePlanName"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
},exit:function(){if(this.popover){this.popover.hide();
}},validatePlanName:function(e){var name=$.trim($(e.target).val());
if(name===""){$("#plan-name").addClass("fba-core-input-error");
$("#update-plan-name button").addClass("btn-md-pri-ghost");
this.allowSubmit=false;
}else{$("#plan-name").removeClass("fba-core-input-error");
$("#update-plan-name button").removeClass("btn-md-pri-ghost");
this.allowSubmit=true;
}},updatePlanName:function(e){e.preventDefault();
if(this.allowSubmit===false){return;
}var newName=$.trim($("#plan-name").val());
this.model.set({name:newName});
this.model.save();
this.popover.hide();
},changePlanName:function(e){e.preventDefault();
var that=this;
if(this.popover){this.popover.hide();
}this.popover=new APF.View.Popover({width:300,localContent:"#change-plan-form",locationElement:"#change-plan-name",title:APF.strings["change-plan-name"],location:"bottom"});
this.popover.render();
$("#update-plan-name").submit(function(e){that.updatePlanName(e);
});
$("#plan-name").keyup(function(e){that.validatePlanName(e);
});
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPkgType=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-pkg-type").html());
this.model=options.parent.model.manifest||options.parent.model;
this.isPackTypeEditable=this.options.parent.step==="plan";
this.model.bind("change",this.render,this);
},render:function(){var isEditable=this.model.isEditable();
if(APF.getData().step==="preview"){isEditable=false;
}if(this.model.get("manifestId")){this.el.html(this.template({model:this.model,isEditable:isEditable,isPackTypeEditable:this.isPackTypeEditable}));
}else{return false;
}},enter:function(){var events={"click #change-plan-pkg-type":"changePlanPkg","click #toggle-plan-pkg-type":"togglePlanPkg"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
},updatePlanPkgType:function(e){e.preventDefault();
var pkgType=$("input:radio[name=pkg-type]:checked").val();
if(pkgType==="individual"){this.model.set({useCasePack:0});
}else{this.model.set({useCasePack:1});
}this.completeUpdatePlanPkgType();
this.popover.hide();
},togglePlanPkg:function(e){e.preventDefault();
if(this.isPackTypeEditable){this.model.set({useCasePack:this.model.get("useCasePack")===0?1:0});
this.completeUpdatePlanPkgType();
}},completeUpdatePlanPkgType:function(){var that=this;
this.model.save({},{success:function(model,response){if(model.items){model.items.reset();
var parentView=that.options.parent.options.parent;
parentView.exit();
parentView.render();
parentView.enter();
}}});
if(this.model.items){_.each(this.model.items,function(item){item.trigger("batchChange");
});
}},changePlanPkg:function(e){e.preventDefault();
var that=this;
if(!this.popover){this.popover=new APF.View.Popover({localContent:"#change-plan-pkg-form",title:APF.strings["change-plan-pkg"]});
this.popover.render();
}else{this.popover.show();
}$("#update-plan-pkg-type").submit(function(e){that.updatePlanPkgType(e);
});
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanShipFrom=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-inbound-workflow-metadata-plan-ship-from").html());
this.model=options.parent.model.manifest||options.parent.model;
},events:{"click #change-plan-address":"changeAddress"},changeAddress:function(e){e.preventDefault();
alert("Implement me!");
},render:function(){if(this.model.get("manifestId")){this.el.html(this.template({model:this.model}));
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataPlanStatus=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-plan-status").html());
this.model=options.parent.model.manifest||options.parent.model;
},render:function(){if(this.model.get("manifestId")){this.el.html(this.template({model:this.model}));
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipFrom=FBA.Core.View.MerchantAddress.extend({initialize:function(options){this.el=$(this.el);
var shipment=options.parent.model;
this.shipment=shipment;
this.model=new FBA.Core.Model.MerchantAddress(shipment.get("fromAddress"));
options.isEditable=shipment.canWorkOnShipment();
options.shipmentId=shipment.get("id");
options.loadingTemplate="#fba-inbound-manifest-workflow-template-shared-loading-generic-sm";
FBA.Core.View.MerchantAddress.prototype.initialize.call(this,options);
},render:function(){FBA.Core.View.MerchantAddress.prototype.render.call(this);
APF.setAttr("fromAddress",this.model);
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipmentContents=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipment-contents").html());
this.preorderWeblabState=APF.getAttr("preorderFunctionalityTreatment");
this.enableHCPOPopoverTemplate=(this.preorderWeblabState==="T2")?_.template($("#fba-core-template-html-enable-hcpo-popover").html()):_.template($("#fba-core-template-html-enable-preorder-popover").html());
this.confirmHCPOTermsPopoverTemplate=(this.preorderWeblabState==="T2")?_.template($("#fba-core-template-html-confirm-hcpo-terms-popover").html()):_.template($("#fba-core-template-html-confirm-preorder-terms-popover").html());
this.model=options.parent.model;
this.isEditable=this.model.canEditShipmentContents();
this.shipmentContentsPopover=new FBA.Core.View.WorkflowShipmentSummaryShipmentContentsPopover({model:this.model,collection:this.model.items,isEditable:this.isEditable});
},enter:function(){var validPreorderableStatusList=APF.getAttr("validPreorderableStatuses");
var preorderEligibility=this.model.preorderEligibility;
var events=(this.preorderWeblabState==="T2")?{"click  .view-modify-units":"showShipmentContentsPopover","click  #enable-hcpo-button":"renderEnableHCPOPopover"}:{"click  .view-modify-units":"showShipmentContentsPopover","click  #enable-preorder-button":"renderEnablePreorderPopover"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
this.model.bind("change:totalQuantity",this.render,this);
if((this.preorderWeblabState==="T2"||this.preorderWeblabState==="T1")&&validPreorderableStatusList.hasOwnProperty(this.model.get("status"))&&!this.model.get("needByDate")&&!preorderEligibility.hasBeenSynced){this.model.fetchPreorderEligibility({callback:_.bind(function(preorderResponse){if(preorderResponse.hasOwnProperty("model")){var preorderResponseModel=preorderResponse.model;
if(preorderResponseModel.get("shipmentContainsPreorderableItems")>0||preorderResponseModel.get("shipmentContainsBackorderableItems")>0){this.render();
}}},this)});
}},exit:function(){this.model.unbind("change:totalQuantity",this.render);
},showShipmentContentsPopover:function(e){e.preventDefault();
e.stopPropagation();
if(this.model.isUpdateConfirmationNeeded()){var isCLIShipment=this.workflow.cliWorkflow,confirmMessage=APF.strings["confirm-shipment-update"];
if(APF.getAttr("hasCartonContentsTreatment")&&isCLIShipment){if(this.model.carrierShipment.get("canBeVoided")){confirmMessage=APF.strings["confirm-voidable-cli-shipment-update"];
}else{confirmMessage=APF.strings["confirm-unvoidable-cli-shipment-update"];
}}if(confirm(confirmMessage)){this.shipmentContentsPopover.show();
}}else{this.shipmentContentsPopover.show();
}},renderEnablePreorderPopover:function(e){e.preventDefault();
e.stopPropagation();
var that=this;
this.enablePreorderPopover=new APF.View.Popover({modal:true,title:APF.strings["preorder-popover-header"],width:680,literalContent:this.enableHCPOPopoverTemplate({earliestFutureNeedByDate:this.model.preorderEligibility.get("earliestFutureNeedByDate")})});
this.enablePreorderPopover.show();
$("#create-preorder-button").click(function(e){e.stopPropagation();
that.enablePreorderPopover.hide();
that.showConfirmPreorderTermsPopover(e);
});
$("#cancel-preorder-button").click(function(e){that.enablePreorderPopover.hide();
});
},showConfirmPreorderTermsPopover:function(e){e.preventDefault();
e.stopPropagation();
var that=this;
this.confirmPreorderTermsPopover=new APF.View.Popover({modal:true,title:APF.strings["preorder-terms-popover-header"],width:680,literalContent:this.confirmHCPOTermsPopoverTemplate({})});
this.confirmPreorderTermsPopover.show();
$("#confirm-preorder-terms-button").click(function(e){e.stopPropagation();
that.confirmPreorderTermsPopover.hide();
that.markAsPreorderable();
});
$("#cancel-preorder-terms-button").click(function(e){that.confirmPreorderTermsPopover.hide();
});
},markAsPreorderable:function(){var that=this;
this.model.set({updatedNeedByDate:this.model.preorderEligibility.get("earliestFutureNeedByDateFromEpoch")});
this.model.save(null,{success:function(data,responseText){if(responseText.hasOwnProperty("errorMessage")&&!responseText.errorMessage){window.location.reload(true);
}},error:function(data,response){alert(APF.strings["sms-client-error-shipment-need-by-date"]);
}});
},renderEnableHCPOPopover:function(e){e.preventDefault();
e.stopPropagation();
var that=this;
this.enableHCPOPopover=new APF.View.Popover({modal:true,title:APF.strings["hcpo-popover-header"],width:680,showCloseButton:false,literalContent:this.enableHCPOPopoverTemplate()});
if(typeof enableHideHCPODatePickerOnExternalClick==="undefined"){$("*").live("click",function(ev){var elem=$(ev.target);
if(!elem.hasClass("hasDatepicker")&&!elem.hasClass("ui-datepicker")&&!elem.hasClass("ui-icon")&&!elem.hasClass("ui-datepicker-next")&&!elem.hasClass("ui-datepicker-prev")&&!$(elem).parents(".ui-datepicker").length){$("#needByDate").datepicker("hide");
}else{ev.preventDefault();
ev.stopPropagation();
ev.stopImmediatePropagation();
return false;
}});
$(document).unbind("mousedown",$.datepicker._checkExternalClick);
enableHideHCPODatePickerOnExternalClick=true;
}this.enableHCPOPopover.show();
this.initializeHCPODatePicker();
this.initializeHCPOPopoverButtons();
},initializeHCPODatePicker:function(){$("#needByDate").datepicker({changeMonth:true,changeYear:true,minDate:new Date().toISOString(),dateFormat:"yy-mm-dd",onSelect:function(dateText){$("#needByDate").removeClass("ui-state-error");
},onClose:function(){$("#needByDate").blur();
event.preventDefault();
event.stopPropagation();
$(document).bind("mousedown",$.datepicker._checkExternalClick);
}}).change(function manualDateChange(event){var minDate=$("#needByDate").datepicker("option","minDate");
var needByDateString=$("#needByDate").val();
if(!/^\d{4}-\d{1,2}-\d{1,2}$/.test(needByDateString)){$("#needByDate").addClass("ui-state-error");
}else{var needByDate=new Date(needByDateString).toISOString();
if(new Date(needByDate)<new Date(minDate)){$("#needByDate").addClass("ui-state-error");
}}});
if(this.model.preorderEligibility.get("earliestFutureNeedByDateFromEpoch")){var earliestFutureNeedByDateFromEpochMillis=this.model.preorderEligibility.get("earliestFutureNeedByDateFromEpoch")*1000;
var localDateGMTDateDiffMillis=this.model.preorderEligibility.get("localDateGMTDateDiffMillis");
var localEFNBDEpoch=earliestFutureNeedByDateFromEpochMillis-localDateGMTDateDiffMillis;
var localDateFromEFNBD=new Date(localEFNBDEpoch);
$("#needByDate").datepicker("setDate",localDateFromEFNBD.toISOString());
}},initializeHCPOPopoverButtons:function(){var that=this;
$("#create-hcpo-button").click(function(e){e.stopPropagation();
var needByDate=$("#needByDate").val();
if(needByDate){that.enableHCPOPopover.hide();
that.showConfirmHCPOTermsPopover(e,needByDate);
}else{$("#needByDate").addClass("ui-state-error");
}});
$("#cancel-hcpo-button").click(function(e){that.enableHCPOPopover.hide();
});
},showConfirmHCPOTermsPopover:function(e,needByDate){e.preventDefault();
e.stopPropagation();
var that=this;
this.confirmHCPOTermsPopover=new APF.View.Popover({modal:true,title:APF.strings["hcpo-terms-popover-header"],width:680,showCloseButton:false,literalContent:this.confirmHCPOTermsPopoverTemplate({needByDate:needByDate})});
this.confirmHCPOTermsPopover.show();
$("#confirm-hcpo-terms-button").click(function(e){e.stopPropagation();
that.confirmHCPOTermsPopover.hide();
that.markAsHCPO(needByDate);
});
$("#cancel-hcpo-terms-button").click(function(e){that.confirmHCPOTermsPopover.hide();
});
},markAsHCPO:function(needByDate){var inputNeedByDateParts=needByDate.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
inputNeedByDateParts[2]-=1;
var inputNeedByDateEpochMillis=Date.UTC.apply(this,inputNeedByDateParts.slice(1,4));
var needByDateEpochMillis=inputNeedByDateEpochMillis+this.model.preorderEligibility.get("localDateGMTDateDiffMillis");
var needByDateFromEpoch=needByDateEpochMillis/1000;
var that=this;
this.model.set({updatedNeedByDate:needByDateFromEpoch});
this.model.save(null,{success:function(data,responseText){if(responseText.hasOwnProperty("errorMessage")&&!responseText.errorMessage){window.location.reload(true);
}},error:function(data,response){alert(APF.strings["sms-client-error-shipment-need-by-date"]);
}});
},render:function(){var shouldRenderPreorderOrHCPO=this.model.get("needByDate")||this.model.preorderEligibility.get("isHCPOEligible")||this.model.preorderEligibility.get("isPreorderEligible");
this.el.html(this.template({model:this.model,shouldRenderPreorderOrHCPO:shouldRenderPreorderOrHCPO}));
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipmentName=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipment-name").html());
this.model=options.parent.model;
this.model.bind("change:name",this.render,this);
},render:function(){this.el.html(this.template({model:this.model}));
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipmentStatus=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipment-status").html());
this.model=options.parent.model;
},render:function(){this.el.html(this.template({model:this.model}));
},enter:function(events){events={"click .mark-as-shipped":"markAsShipped","click [name=mark-as-shipped]":"markAsShipped"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
this.model.bind("change:status",this.render,this);
},exit:function(){this.model.unbind("change:status",this.render);
},markAsShipped:function(e){e.preventDefault();
this.model.set({status:"SHIPPED"});
this.model.save();
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipMethod=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.model=options.parent.model;
this.template=_.template($("#fba-core-templates-workflow-meta-data-ship-method").html());
},enter:function(){this.model.bind("change",this.render,this);
},exit:function(){this.model.unbind("change",this.render);
},render:function(){var model=this.model;
var carrierShipment=model.carrierShipment;
var carrierInfo=carrierShipment.get("carrierInfo");
if(carrierInfo&&!carrierInfo.carrierName){var that=this;
carrierShipment.fetch({data:{shipmentId:model.get("shipmentId")},success:function(){that.renderTemplate();
}});
}else{this.renderTemplate();
}},renderTemplate:function(){var carrierInfo=this.model.carrierShipment.get("carrierInfo");
var carrierName=carrierInfo?carrierInfo.carrierName:"--";
this.el.html(this.template({model:this.model,carrierName:carrierName}));
}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShippingEstimate=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipping-estimate").html());
this.model=options.parent.model;
},render:function(){if(this.model.carrierShipment.get("estimate")){this.el.html(this.template({model:this.model}));
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipmentCostEstimate=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipment-cost-estimate").html());
this.model=options.parent.model;
},render:function(){if(this.model.get("manifestId")){this.el.html(this.template({model:this.model}));
}else{return false;
}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipTo=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-ship-to").html());
this.model=options.parent.model;
this.model.bind("change:shipToAddress",this.render,this);
},render:function(){if(!APF.getAttr("hasCEEMultiFCTreatment")){if(this.model.isEligibleForCEE()&&this.model.carrierShipment){var address=this.getOverrideShiptoAddress();
this.overrideAddress(address);
}}else{if(this.model.requiresFcOverride()&&this.model.carrierShipment){var address=this.getOverrideShiptoAddress();
this.overrideAddress(address);
}}this.el.html(this.template({model:this.model}));
},overrideAddress:function(address){var toAddress=this.model.get("toAddress");
toAddress.name=address.name;
toAddress.addressLine1=address.addressLine1;
toAddress.addressLine2=address.addressLine2;
toAddress.city=address.city;
toAddress.state=address.state;
toAddress.postalCode=address.postalCode;
toAddress.country=address.country;
},getOverrideShiptoAddress:function(){var carrierShipment=this.model.carrierShipment;
if(!APF.getAttr("hasCEEMultiFCTreatment")){if(carrierShipment.get("isInternalShipment")&&carrierShipment.get("carrierInfo").amazonCarrierId==APF.getAttr("dhlPartnerCarrierId")){return APF.getAttr("virtualFCAddress");
}else{return APF.getAttr("transloadFCAddress");
}}else{var addressMap=APF.getAttr("fcOverrideOperationalFCAddresses");
var amazonCarrierId=carrierShipment.get("carrierInfo").amazonCarrierId;
var carrierName=this.getCarrierNameToOverrideFromCarrierId(amazonCarrierId);
var destWareHouse=this.model.get("destinationWarehouse");
var overrideAddressFcFromDestFcMap=APF.getAttr("fcOverrideAddressFcFromDestFcMap");
var overrideFCCode=null;
if(carrierShipment.get("isInternalShipment")&&overrideAddressFcFromDestFcMap[destWareHouse][carrierName]!=undefined){overrideFCCode=overrideAddressFcFromDestFcMap[destWareHouse][carrierName];
}else{overrideFCCode=overrideAddressFcFromDestFcMap[destWareHouse]["DEFAULT"];
}return this.parseAddress(addressMap[overrideFCCode],destWareHouse);
}},parseAddress:function(address,destWareHouse){address.addressLine1=address.addressLine1.replace(/\{DestFC\}/g,destWareHouse);
return address;
},getCarrierNameToOverrideFromCarrierId:function(amazonCarrierId){var carriersIdMap=APF.getAttr("fcOverridePartnerCarrierIds");
for(var carrierName in carriersIdMap){if(carriersIdMap.hasOwnProperty(carrierName)){if(carriersIdMap[carrierName]===amazonCarrierId){return carrierName;
}}}}});
}(jQuery));
(function($){FBA.Core.View.MetaDataShipmentFees=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.template=_.template($("#fba-core-templates-workflow-meta-data-shipment-fees").html());
this.model=options.parent.model;
this.cliPlannedServiceFeeEstimate=options.parent.model.cliPlannedServiceFeeEstimate;
},enter:function(){this.model.bind("change:declaredCartonInformationSource",this.render,this);
this.cliPlannedServiceFeeEstimate.bind("change:state",this.render,this);
this.model.carrierShipment.bind("change:isInternalShipment",this.render,this);
this.model.carrierShipment.bind("change:status",this.render,this);
APF.View.Base.prototype.enter.call(this);
},exit:function(){this.model.unbind("change:declaredCartonInformationSource",this.render);
this.cliPlannedServiceFeeEstimate.unbind("change:state",this.render);
this.model.carrierShipment.unbind("change:isInternalShipment",this.render);
this.model.carrierShipment.unbind("change:status",this.render);
APF.View.Base.prototype.exit.call(this);
},render:function(){this.el.html(this.template({model:this.model}));
}});
}(jQuery));
(function($){FBA.Core.View.ItemType=APF.View.Base.extend({initialize:function(options){this.el=$(this.el);
this.capacityUsages=APF.getAttr("inboundPerformance").capacityUsages;
this.collectionResponse=options.parent?options.parent.collectionResponse:options.collectionResponse;
var model=this.model||options.model;
this.originalNumberOfCases=model.get("numberOfCases");
this.originalUnitsPerCase=model.get("unitsPerCase");
this.lastQuantity=model.getQuantity();
this.hidePopoverOnFocus=true;
this.resetOnPopoverHide=true;
this.preorderWeblab=APF.getAttr("preorderFunctionalityTreatment");
this.preorderUnitsReductionErrorPopoverTemplate=_.template($("#fba-core-templates-preorder-usage-message").html());
this.confirmUnitsIncrementPopoverTemplate=_.template($("#fba-core-template-html-preorder-item-increment-confirm-popover").html());
var that=this;
$.each(this.capacityUsages.models,function(){if(this.get("type")===model.getSize()){that.capacityModel=this;
}});
APF.View.Base.prototype.initialize.call(this,options);
},enter:function(events){events=$.extend(events||{},{"keyup      .update-quantity":"updateQuantity","blur       .update-quantity":"saveItem","focus      .update-quantity":"hidePopovers","keyup      .update-label-quantity":"updateLabelQuantity","blur       .update-label-quantity":"updateLabelQuantity","click      .remove-item":"removeItem","click      .undo-remove-item":"undoRemoveItem",'click      [name="apply-guidance-button"]':"saveItem",'click      [name="apply-guidance-cancel-button"]':"saveItem"});
this.model.bind("change:quantity",this.renderTotalQuantity,this);
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
},exit:function(){var model=this.model;
model.unbind("change:quantity",this.renderTotalQuantity);
this.hidePopovers();
this.consolidateQuantity();
if(!this.saveAllowed){model.updateQuantity({numberOfCases:this.originalNumberOfCases,unitsPerCase:this.originalUnitsPerCase});
if(this.shipment){this.shipment.updateTotalQuantity();
}this.updateCapacityUsages();
this.lastQuantity=model.getQuantity();
}APF.View.Base.prototype.exit.call(this);
},consolidateQuantity:function(){var model=this.model;
if(this.originalNumberOfCases!==model.get("numberOfCases")||this.originalUnitsPerCase!==model.get("unitsPerCase")){model.updateQuantity({numberOfCases:this.originalNumberOfCases,unitsPerCase:this.originalUnitsPerCase});
if(this.manifest){this.manifest.updateTotalQuantity();
}if(this.shipment){this.shipment.updateTotalQuantity();
}this.updateCapacityUsages();
this.lastQuantity=model.getQuantity();
if(this.manifest){this.manifest.trigger("change:capacityUsages");
}}},updateQuantity:function(e){var el=this.el;
var numberOfCasesEl=el.find(".update-number-cases");
var unitsPerCaseEl=el.find(".update-case-units");
var numberOfCases=$.trim(numberOfCasesEl.val())||0;
var unitsPerCase=$.trim(unitsPerCaseEl.val())||0;
var totalUpdated=this.manifest?(this.manifest.get("totalUpdated")||0):0;
this.locationElement=$(e.currentTarget);
if(!this.useCasePack){unitsPerCase=1;
}this.model.updateQuantity({numberOfCases:numberOfCases,unitsPerCase:unitsPerCase});
if(!FBA.Core.Util.isValidNonZeroInteger(numberOfCases)){numberOfCasesEl.addClass("fba-core-input-error");
}else{numberOfCasesEl.removeClass("fba-core-input-error");
}if(!FBA.Core.Util.isValidNonZeroInteger(unitsPerCase)){unitsPerCaseEl.addClass("fba-core-input-error");
}else{unitsPerCaseEl.removeClass("fba-core-input-error");
}var count=this.model.updateException("ZERO_QUANTITY");
if(this.manifest){this.manifest.updateTotalQuantity();
this.manifest.updateException("ZERO_QUANTITY",count,"BLOCKING");
if(count<0&&!this.model.hasExceptions()){totalUpdated+=1;
}else{if(count>0){totalUpdated-=1;
}}this.manifest.set({totalUpdated:totalUpdated});
}if(this.locationElement.hasClass("update-case-units")){this.checkMaxUnitsPerCase();
}this.updateCapacityUsages();
this.renderCapacityUsagesPopover();
this.isValid();
this.lastQuantity=this.model.getQuantity();
},updateLabelQuantity:function(){var originalLabelQuantity=this.model.get("labelQuantity");
var newLabelQuantity=$.trim(this.el.find(".update-label-quantity").val())||"0";
var shipmentLabelQuantity;
this.model.set({labelQuantity:newLabelQuantity});
if(this.manifest){this.manifest.updateLabelQuantity(this.collectionResponse.models);
}else{if(this.shipment){shipmentLabelQuantity=parseInt(this.shipment.get("totalLabelQuantity"))-parseInt(originalLabelQuantity)+parseInt(newLabelQuantity);
this.shipment.set({totalLabelQuantity:shipmentLabelQuantity});
}}},renderCapacityUsagesPopover:function(){if(!this.locationElement){this.locationElement=$("#manifest-total-units");
}if(this.manifest){this.manifest.trigger("change:capacityUsages");
}var model=this.capacityModel;
if(!model){return;
}if(model.isAtLimit()){var overCapacityMsg=APF.strings["over-capacity"].replace(/{type}/g,"<strong>"+APF.strings["size-"+model.get("type")]+"</strong>");
this.showPopover("capacityUsagesPopover",{literalContent:_.template($("#fba-core-templates-capacity-usages-message").html())({overCapacityMsg:overCapacityMsg})});
}else{this.hidePopover(this.capacityUsagesPopover);
}},updateCapacityUsages:function(){var capacity=this.capacityUsages;
var manifest=this.manifest;
var shipment=this.shipment;
var model=this.model;
if(manifest){capacity.updateSortableUtilization(manifest.get("totalSortableQuantity"));
capacity.updateNonSortableUtilization(manifest.get("totalOversizeQuantity"));
}if(shipment){capacity.addUtilization(model.getSize(),model.getQuantity()-this.lastQuantity);
}},checkMaxUnitsPerCase:function(){if(!this.model.hasValidUnitsPerCase()){var maxUnitPerCaseExceededMsg=APF.strings["error-fld-units-per-case"];
var popoverTemplate=_.template($("#fba-core-templates-max-unit-per-case-exceeded-popover").html())({alertMsg:maxUnitPerCaseExceededMsg});
this.showPopover("maxUnitsPerCasePopover",{literalContent:popoverTemplate});
}else{this.hidePopover(this.maxUnitsPerCasePopover);
}},hidePopover:function(popover){if(popover&&popover.isShown){this.resetOnPopoverHide=false;
popover.hide();
this.resetOnPopoverHide=true;
}},showPopover:function(popoverName,options){this.showPopoverWithoutFocus(popoverName,options);
this.hidePopoverOnFocus=false;
this.locationElement.focus();
this.hidePopoverOnFocus=true;
},showPopoverAfterSaveItem:function(popoverName,options){this.showPopoverWithoutFocus(popoverName,options);
this.locationElement.toggleClass("fba-core-input-error",true);
},showPopoverWithoutFocus:function(popoverName,options){var popover=this[popoverName];
if(popover&&popover.isShown){return;
}options=$.extend(options,{width:250,locationElement:this.locationElement,location:"bottom"});
popover=new APF.View.Popover(options);
this[popoverName]=popover;
popover.render();
popover.bind("hide",this.onErrorPopoverHide,this);
},onErrorPopoverHide:function(){if(!this.resetOnPopoverHide){return;
}this.consolidateQuantity();
var numberOfCasesEl=this.el.find(".update-number-cases");
var unitsPerCaseEl=this.el.find(".update-case-units");
if(numberOfCasesEl.length){numberOfCasesEl.val(this.originalNumberOfCases);
numberOfCasesEl.removeClass("fba-core-input-error");
}if(unitsPerCaseEl.length){unitsPerCaseEl.val(this.originalUnitsPerCase);
unitsPerCaseEl.removeClass("fba-core-input-error");
}},checkQuantityRange:function(){var item=this.model;
var range=item.getAllowedQuantityRange();
if(!item.isValidQuantityRange()){this.showPopover("rangeLimitPopover",{literalContent:APF.strings["limit-qty"].replace("{min}",range.min).replace("{max}",range.max)});
}else{this.hidePopover(this.rangeLimitPopover);
}},isValid:function(){var capacityIsAtLimit=(this.capacityModel===undefined)?false:this.capacityModel.isAtLimit();
var isValid=((!APF.getAttr("hasLimitQtyTreatment")||this.model.isValidQuantityRange())&&!capacityIsAtLimit);
var isUnitsPerCaseValid=true;
var locationEl=this.locationElement;
isValid=isValid&&this.model.hasValidUnitsPerCase();
if(locationEl){locationEl.toggleClass("fba-core-input-error",!isValid);
}return isValid;
},saveItem:function(e){var model=this.model;
var isValid=this.isValid();
if(isValid){this.updateQuantity(e);
if(this.isNonUpdatableItem()){this.preorderShipmentItemCheck(e);
}else{this.saveValidItem();
}}},saveValidItem:function(){var model=this.model;
model.save({},{queue:true,success:_.bind(this.saveItemSuccess,this)});
},isPreorder:function(){if(this.preorderWeblab==="T1"&&this.shipment&&this.shipment.get("needByDate")){return true;
}else{return false;
}},preorderShipmentItemCheck:function(e){var currentNumberCases=Number(this.model.get("numberOfCases"));
var currentUnitsPerCase=Number(this.model.get("unitsPerCase"));
var originalNumberOfCases=Number(this.originalNumberOfCases);
var originalUnitsPerCase=Number(this.originalUnitsPerCase);
if(currentNumberCases<originalNumberOfCases||currentUnitsPerCase<originalUnitsPerCase){e.stopPropagation();
var preorderShipmentItemUnitReducedMsg=this.preorderWeblab==="T2"?APF.strings["hcpo-popover-modify-shipment-item"]:APF.strings["preorder-popover-modify-shipment-item"];
this.showPopover("preorderShipmentItemErrorPopover",{literalContent:this.preorderUnitsReductionErrorPopoverTemplate({preOrderMsg:preorderShipmentItemUnitReducedMsg})});
return;
}else{if(currentNumberCases>originalNumberOfCases||currentUnitsPerCase>originalUnitsPerCase){var that=this;
this.showPopoverWithoutFocus("confirmUnitsIncrementPopover",{showCloseButton:false,literalContent:this.confirmUnitsIncrementPopoverTemplate});
$("#confirm-preorder-item-increment-button").click(function(e){e.stopPropagation();
that.hidePopover(that.confirmUnitsIncrementPopover);
that.saveValidItem();
});
$("#cancel-preorder-item-increment-button").click(function(e){that.confirmUnitsIncrementPopover.hide();
});
return;
}else{this.hidePopover(this.preorderShipmentItemErrorPopover);
this.hidePopover(this.confirmUnitsIncrementPopover);
return;
}}},displayPreorderItemRemovalDisabledPopover:function(e){e.preventDefault();
e.stopPropagation();
var popoverDetails=this.preorderWeblab==="T2"?{modal:true,literalContent:APF.strings["hcpo-popover-delete-shipment-item-message"],title:APF.strings["hcpo-popover-delete-shipment-item-title"]}:{modal:true,literalContent:APF.strings["preorder-popover-delete-shipment-item-message"],title:APF.strings["preorder-popover-delete-shipment-item-title"]};
this.removePreorderShipmentItemPopOver=new APF.View.Popover(popoverDetails);
this.removePreorderShipmentItemPopOver.render();
},isPreorderableItem:function(){var csfd=this.shipment.get("confirmedFulfillableDateEpoch");
var releaseDate=this.model.get("releaseDate");
return(releaseDate>=csfd);
},isHCPOShipment:function(){return(this.preorderWeblab==="T2"&&this.shipment&&this.shipment.get("needByDate"));
},isNonUpdatableItem:function(){return(this.isPreorder()&&this.isPreorderableItem())||this.isHCPOShipment();
},saveItemSuccess:function(itemModel,response){if(response&&response.data&&response.data.merchantSkuToQtyList&&response.data.merchantSkuToQtyList[0]){if(response.data.merchantSkuToQtyList[0]["merchantSku"]==this.model.getAttr("mSku")){var quantityRange=response.data.merchantSkuToQtyList[0]["plannedQuantity"];
if(quantityRange){this.showPopoverAfterSaveItem("rangeLimitPopover",{literalContent:APF.strings["limit-qty"].replace("{min}",quantityRange.min).replace("{max}",quantityRange.max)});
}}}else{this.hidePopover(this.rangeLimitPopover);
this.model.set({wasSaved:true});
this.setSavedQuantity();
}},setSavedQuantity:function(){var model=this.model;
this.originalNumberOfCases=model.get("numberOfCases");
this.originalUnitsPerCase=model.get("unitsPerCase");
},hidePopovers:function(){if(!this.hidePopoverOnFocus){return;
}if(this.capacityUsagesPopover){this.capacityUsagesPopover.hide();
}if(this.rangeLimitPopover){this.rangeLimitPopover.hide();
}if(this.maxUnitsPerCasePopover){this.maxUnitsPerCasePopover.hide();
}},renderTotalQuantity:function(){this.el.find(".total-quantity").html(this.model.getQuantity());
},removeItem:function(e){if(this.isNonUpdatableItem()){this.displayPreorderItemRemovalDisabledPopover(e);
return;
}e.preventDefault();
var el=this.el;
var surplusMessageTreatment="";
if(el.find(".surplus-message-treatment-C").length>0){surplusMessageTreatment="C";
}else{if(el.find(".surplus-message-treatment-T1").length>0){surplusMessageTreatment="T1";
}else{if(el.find(".surplus-message-treatment-T2").length>0){surplusMessageTreatment="T2";
}}}this.model.setAttr("surplusMessageTreatment",surplusMessageTreatment);
var deleteShipment=false;
var that=this;
this.model.trigger("softDestroy");
this.removeFromCollectionResponse();
if(this.shipment){if(this.shipment.hasSingleItem()){deleteShipment=confirm(APF.strings["delete-all-shipment-items-confirm"]);
this.updateCapacityUsages();
if(deleteShipment){this.model.destroy({queue:true,success:function(){that.shipment.destroy({success:function(model,response){window.location="/gp/fba/inbound-queue/index.html#shipments";
}});
}});
}else{return;
}}else{this.shipment.removeItem(this.model);
}}else{el.find(".fba-core-input").hide();
this.manifest.removeAllExceptions(this.model);
this.manifest.removeItem(this.model);
this.manifest.updateLabelQuantity(this.collectionResponse.models);
}el.addClass("remove");
el.find(".remove-item").hide();
el.find(".update-quantity").hide();
el.find(".quantity-readonly").hide();
el.find(".update-label-quantity").hide();
el.find(".label-quantity-readonly").hide();
el.find(".total-quantity").hide();
el.find(".total-recieved").html("");
this.updateCapacityUsages();
if(!deleteShipment){if(this.manifest){this.model.softDestroy({queue:true,success:function(){el.find(".undo-remove-item").show();
}});
}else{this.model.destroy({queue:true});
}}},undoRemoveItem:function(e){e.preventDefault();
this.el.find(".undo-remove-item").hide();
this.model.undoSoftDestroy({queue:true,success:_.bind(this.undoRemoveItemSuccessCallback,this)});
},undoRemoveItemSuccessCallback:function(){var el=this.el;
var model=this.model;
var manifest=this.manifest;
this.collectionResponse.models.push(model);
manifest.undoRemoveItem(model);
manifest.undoRemoveAllExceptions(model);
manifest.updateLabelQuantity(this.collectionResponse.models);
el.removeClass("remove");
el.find(".fba-core-input").show();
el.find(".remove-item").show();
el.find(".update-number-cases").val(model.get("numberOfCases"));
if(this.useCasePack){el.find(".update-case-units").val(model.get("unitsPerCase"));
el.find(".total-quantity").show();
}model.trigger("softDestroy:undo");
},removeFromCollectionResponse:function(){var models=[];
var that=this;
$.each(this.collectionResponse.models,function(i,crModel){if(crModel!=that.model){models.push(crModel);
}});
this.collectionResponse.models=models;
}});
}(jQuery));
(function($){FBA.Core.View.ItemsType=APF.View.Collection.extend({initialize:function(options){this.el=$(this.el);
this.capacityUsages=APF.getAttr("inboundPerformance").capacityUsages;
this.capacityUsagesPopoverTemplate=_.template($("#fba-core-templates-capacity-usages-message").html());
this.saveAllowed=true;
this.hidePopoverOnFocus=true;
this.resetOnPopoverHide=true;
APF.View.Collection.prototype.initialize.call(this,options);
},enter:function(events){events=$.extend(events||{},{"keyup      .batch-update-quantity":"batchUpdateQuantity","blur       .batch-update-quantity":"saveCollection","focus      .batch-update-quantity":"clearViewPopups","click      #batch-remove-item":"batchRemoveItem","click      #delete-plan":"deletePlan","click      .toggle-attr":"toggleAttr","click      #surplus-storage-bulk-ack-box":"bulkUpdateSurplusStorageAck"});
var showMskuIdentifiers=this.el.find("#show-msku-identifiers");
var that=this;
showMskuIdentifiers.click(function(){that.showMskuIdentifiers(showMskuIdentifiers.is(":checked"));
});
this.el.find("#show-msku-identifiers-label").click(function(){var checked=!showMskuIdentifiers.is(":checked");
showMskuIdentifiers.attr("checked",checked);
that.showMskuIdentifiers(checked);
});
this.el.find("#show-more-details").click(function(){that.showMoreDetails();
});
if(this.manifest){this.manifest.bind("change:totalQuantity",this.renderManifestTotalQuantity,this);
this.manifest.setNextPageTotalQuantity();
}else{if(this.shipment){this.shipment.bind("change:totalQuantity",this.renderShipmentTotalQuantity,this);
this.shipment.setNextPageTotalQuantity();
}}Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Collection.prototype.enter.call(this);
if(this.el.find(".duplicate-shipment")){this.duplicateShipmentView=new FBA.Core.View.DuplicateShipment({view:this});
this.duplicateShipmentView.enter();
}this.updateCapacityUsages();
this.renderManifestTotalQuantity();
this.renderShipmentTotalQuantity();
if(showMskuIdentifiers.length>0){this.showMskuIdentifiers(showMskuIdentifiers.is(":checked"));
}},exit:function(){if(this.manifest){this.manifest.unbind("change:totalQuantity",this.renderManifestTotalQuantity);
}else{if(this.shipment){this.shipment.unbind("change:totalQuantity",this.renderShipmentTotalQuantity);
}}this.hidePopovers();
APF.View.Collection.prototype.exit.call(this);
},renderManifestTotalQuantity:function(){if(this.manifest){this.el.find("#manifest-total-units").html(this.manifest.get("totalQuantity"));
}},renderShipmentTotalQuantity:function(){if(this.shipment){this.el.find("#total-units").html(this.shipment.get("totalQuantity"));
}},showMskuIdentifiers:function(toggle){this.el.find(".sku-identifiers").toggle(toggle);
},showMoreDetails:function(){this.el.find(".more-details").toggle();
},clearViewPopups:function(){if(!this.hidePopoverOnFocus){return;
}if(this.capacityUsagesPopover&&this.capacityUsagesPopover.isShown){this.capacityUsagesPopover.hide();
}if(this.rangeLimitPopover&&this.rangeLimitPopover.isShown){this.rangeLimitPopover.hide();
}if(this.maxUnitsPerCasePopover&&this.maxUnitsPerCasePopover.isShown){this.maxUnitsPerCasePopover.hide();
}$.each(this.views,function(){if(this.capacityUsagesPopover&&this.capacityUsagesPopover.isShown){this.capacityUsagesPopover.hide();
}if(this.rangeLimitPopover&&this.rangeLimitPopover.isShown){this.rangeLimitPopover.hide();
}if(this.maxUnitsPerCasePopover&&this.maxUnitsPerCasePopover.isShown){this.maxUnitsPerCasePopover.hide();
}});
},batchUpdateQuantity:function(e){if(this.collectionResponse.models.length==0){return;
}var el=this.el;
var numberOfCasesEl=el.find(".update-number-cases");
var unitsPerCaseEl=el.find(".update-case-units");
var batchNumberOfCasesEl=el.find("#batch-update-number-cases");
var batchUnitsPerCaseEl=el.find("#batch-update-case-units");
var numberOfCases=$.trim(batchNumberOfCasesEl.val());
var unitsPerCase=$.trim(batchUnitsPerCaseEl.val());
var totalUpdated=this.manifest?(this.manifest.get("totalUpdated")||0):0;
this.locationElement=$(e.currentTarget);
if(this.locationElement.attr("id")=="batch-update-number-cases"){if(numberOfCases){numberOfCasesEl.val(numberOfCases);
unitsPerCase=null;
}else{return;
}}else{if(this.locationElement.attr("id")=="batch-update-case-units"){if(unitsPerCase){unitsPerCaseEl.val(unitsPerCase);
numberOfCases=null;
}else{return;
}}}if(!FBA.Core.Util.isValidNonZeroInteger(numberOfCases)){batchNumberOfCasesEl.addClass("fba-core-input-error");
numberOfCasesEl.addClass("fba-core-input-error");
}else{batchNumberOfCasesEl.removeClass("fba-core-input-error");
numberOfCasesEl.removeClass("fba-core-input-error");
}if(!FBA.Core.Util.isValidNonZeroInteger(unitsPerCase)||!this.hasValidUnitsPerCase(unitsPerCase)){batchUnitsPerCaseEl.addClass("fba-core-input-error");
unitsPerCaseEl.addClass("fba-core-input-error");
}else{batchUnitsPerCaseEl.removeClass("fba-core-input-error");
unitsPerCaseEl.removeClass("fba-core-input-error");
}if(!this.manifest.get("useCasePack")){unitsPerCase=1;
}this.collection.updateQuantity(this.collectionResponse.models,{numberOfCases:numberOfCases,unitsPerCase:unitsPerCase});
var count=this.collection.updateException(this.collectionResponse.models,"ZERO_QUANTITY");
this.manifest.updateTotalQuantity();
this.manifest.updateException("ZERO_QUANTITY",count,"BLOCKING");
if(count<0){$.each(this.collectionResponse.models,function(){if(!this.hasExceptions()){totalUpdated+=1;
}});
}this.manifest.set({totalUpdated:totalUpdated});
if(unitsPerCase){this.renderMaxUnitPerCasePopover(unitsPerCase);
}this.updateCapacityUsages();
this.renderCapacityUsagesPopover();
},hasValidUnitsPerCase:function(unitsPerCase){var maxQuantityPerCasePack=APF.getAttr("maxQuantityPerCasePack");
if(maxQuantityPerCasePack&&unitsPerCase>maxQuantityPerCasePack){return false;
}return true;
},renderMaxUnitPerCasePopover:function(unitsPerCase){if(!this.locationElement){this.locationElement=this.el.find("#manifest-total-units");
}if(!this.hasValidUnitsPerCase(unitsPerCase)){var maxUnitPerCaseExceededMsg=APF.strings["error-fld-units-per-case"];
var popoverTemplate=_.template($("#fba-core-templates-max-unit-per-case-exceeded-popover").html())({alertMsg:maxUnitPerCaseExceededMsg});
this.showPopover("maxUnitsPerCasePopover",{literalContent:popoverTemplate});
}else{this.hidePopover(this.maxUnitsPerCasePopover);
}},renderCapacityUsagesPopover:function(){var that=this;
if(!this.locationElement){this.locationElement=$("#manifest-total-units");
}$.each(this.capacityUsages.models,function(i,model){if(model.isAtLimit()&&that.collection.getItemQuantityBySize(model)){var overCapacityMsg=APF.strings["over-capacity"].replace(/{type}/g,"<strong>"+APF.strings["size-"+model.get("type")]+"</strong>");
that.showPopover("capacityUsagesPopover",{literalContent:that.capacityUsagesPopoverTemplate({overCapacityMsg:overCapacityMsg})});
that.saveAllowed=false;
return false;
}else{that.saveAllowed=true;
that.hidePopover(that.capacityUsagesPopover);
}});
this.manifest.trigger("change:capacityUsages");
},hidePopover:function(popover){if(popover&&popover.isShown){this.resetOnPopoverHide=false;
popover.hide();
this.resetOnPopoverHide=true;
}},showPopover:function(popoverName,options){var popover=this[popoverName];
if(popover&&popover.isShown){return;
}options=$.extend(options,{width:250,locationElement:this.locationElement,location:"bottom"});
popover=new APF.View.Popover(options);
this[popoverName]=popover;
popover.render();
popover.bind("hide",_.bind(this.onErrorPopoverHide,this));
this.hidePopoverOnFocus=false;
this.locationElement.focus();
this.hidePopoverOnFocus=true;
},onErrorPopoverHide:function(){if(!this.resetOnPopoverHide){return;
}$.each(this.views,function(){this.onErrorPopoverHide();
});
},updateCapacityUsages:function(){var manifest=this.manifest;
if(manifest){this.capacityUsages.updateSortableUtilization(manifest.get("totalSortableQuantity"));
this.capacityUsages.updateNonSortableUtilization(manifest.get("totalOversizeQuantity"));
}},checkQuantityRange:function(){var range=this.model.getAllowedQuantityRange();
var quantity=this.model.getQuantity();
if(range){if(quantity<range.min||quantity>range.max){this.locationElement.addClass("fba-core-input-error");
this.showPopover("rangeLimitPopover",{literalContent:APF.strings["limit-qty"].replace("{min}",range.min).replace("{max}",range.max)});
this.saveAllowed=false;
}else{this.locationElement.removeClass("fba-core-input-error");
this.saveAllowed=true;
this.hidePopover(this.maxUnitsPerCasePopover);
}}},saveCollection:function(e){if(this.collectionResponse.models.length==0){return;
}if(!this.isPopoverShown()){this.batchUpdateQuantity(e);
if(this.saveAllowed&&!this.isPopoverShown()){this.collection.save({queue:true,models:this.collectionResponse.models});
$.each(this.views,function(){this.setSavedQuantity();
});
}}},isPopoverShown:function(){if(this.capacityUsagesPopover&&this.capacityUsagesPopover.isShown){return true;
}if(this.rangeLimitPopover&&this.rangeLimitPopover.isShown){return true;
}if(this.maxUnitsPerCasePopover&&this.maxUnitsPerCasePopover.isShown){return true;
}return false;
},hidePopovers:function(){if(this.capacityUsagesPopover){this.capacityUsagesPopover.hide();
}if(this.rangeLimitPopover){this.rangeLimitPopover.hide();
}if(this.maxUnitsPerCasePopover){this.maxUnitsPerCasePopover.hide();
}},batchRemoveItem:function(e){e.preventDefault();
this.el.find(".remove-item").click();
},toggleAttr:function(e){e.preventDefault();
var el=$(e.currentTarget);
el.toggleClass("show").toggleClass("hide");
var item=el.data("toggle-item");
var action=el.hasClass("show")?"show":"hide";
this.el.find(".item-"+item)[action]();
},deletePlan:function(e){var deletePlan=confirm(APF.strings["delete-shipping-plan-confirm"]);
e.preventDefault();
if(deletePlan){this.model.destroy({success:function(model,response){window.location="/gp/fba/inbound-queue/index.html";
}});
}},enablePrintLabelsButton:function(){$("[name=labelType]",this.el).removeAttr("disabled");
$("#print-labels-btn",this.el).removeAttr("disabled");
$("#print-labels-btn",this.el).removeClass("btn-md-pri-ghost");
},disablePrintLabelsButton:function(){$("[name=labelType]",this.el).attr("disabled","disabled");
$("#print-labels-btn",this.el).attr("disabled","disabled");
$("#print-labels-btn",this.el).addClass("btn-md-pri-ghost");
},bulkUpdateSurplusStorageAck:function(){var bulkUpdateSurplusStorageAckBox=this.el.find("#surplus-storage-bulk-ack-box");
var checked=bulkUpdateSurplusStorageAckBox.is(":checked");
var surplusStorageAckBox=this.el.find(".surplus-storage-ack-box");
bulkUpdateSurplusStorageAckBox.attr("disabled","disabled");
surplusStorageAckBox.attr("checked",checked);
surplusStorageAckBox.click();
bulkUpdateSurplusStorageAckBox.removeAttr("disabled");
}});
}(jQuery));
(function($){FBA.Core.View.DuplicateShipment=APF.View.Base.extend({initialize:function(options){this.view=options.view;
this.el=$(this.view.el);
this.maxShipmentNameLength=APF.getAttr("maxShipmentNameLength");
this.maxDuplicateItems=APF.getAttr("maxDuplicateItems");
this.shipment=options.view.shipment;
if(!this.shipment&&options.view.model){this.shipment=options.view.model.shipment;
}this.duplicatePlanButtonTemplate=_.template($("#fba-core-template-html-duplicate-plan-button").html());
this.duplicateShipmentButtonTemplate=_.template($("#fba-core-template-html-duplicate-shipment-button").html());
this.duplicatePlanPopoverTemplate=_.template($("#fba-core-template-html-duplicate-plan-popover").html());
this.duplicateShipmentPopoverTemplate=_.template($("#fba-core-template-html-duplicate-shipment-popover").html());
this.duplicatePlanPopoverLoadingTemplate=_.template($("#fba-core-template-html-duplicate-plan-popover-loading").html());
this.duplicateShipmentPopoverLoadingTemplate=_.template($("#fba-core-template-html-duplicate-shipment-popover-loading").html());
},enter:function(){var events={};
var model=this.view.model;
if(model&&model.carrierShipment){if(model.get("totalLineItems")<=this.maxDuplicateItems||this.shipment.get("totalLineItems")<=this.maxDuplicateItems){this.el.find(".duplicate-shipment").html(this.duplicateShipmentButtonTemplate());
events={"click #duplicate-shipment-button":"renderDuplicateShipmentPopover"};
var shipmentContents=model.get("totalLineItems")?model.get("totalLineItems"):this.shipment.get("totalLineItems");
var shipmentName=model.get("name")?model.get("name"):this.shipment.get("name");
this.duplicateShipmentPopover=new APF.View.Popover({modal:true,title:APF.strings["button-duplicate-shipment"],width:680,literalContent:this.duplicateShipmentPopoverTemplate({shipmentName:this.getDuplicateName(shipmentName),shipmentContents:shipmentContents,maxShipmentNameLength:this.maxShipmentNameLength})});
this.duplicateShipmentPopoverLoading=new APF.View.Popover({modal:true,title:APF.strings["button-duplicate-shipment"],width:680,literalContent:this.duplicateShipmentPopoverLoadingTemplate()});
}}else{if(model){if(this.view.collection.data.totalRecords<=this.maxDuplicateItems){this.el.find(".duplicate-shipment").html(this.duplicatePlanButtonTemplate());
events={"click #duplicate-plan-button":"renderDuplicatePlanPopover"};
var planContents=model.get("totalLineItems")?model.get("totalLineItems"):(typeof(this.shipment)!=="undefined"?this.shipment.get("totalLineItems"):0);
var shipmentName=model.get("name");
this.duplicatePlanPopover=new APF.View.Popover({modal:true,title:APF.strings["button-duplicate-plan"],width:680,literalContent:this.duplicatePlanPopoverTemplate({planName:this.getDuplicateName(shipmentName),planContents:planContents,maxPlanNameLength:this.maxShipmentNameLength})});
this.duplicatePlanPopoverLoading=new APF.View.Popover({modal:true,title:APF.strings["button-duplicate-plan"],width:680,literalContent:this.duplicatePlanPopoverLoadingTemplate()});
}}}Backbone.View.prototype.delegateEvents.call(this,events);
},getDuplicateName:function(oldName){var copyString=" - "+APF.strings["label-copy"];
if(oldName.length+copyString.length>this.maxShipmentNameLength){oldName=oldName.substring(0,this.maxShipmentNameLength-copyString.length);
}return oldName+copyString;
},renderDuplicateShipmentPopover:function(e){e.stopPropagation();
var that=this;
this.duplicateShipmentPopover.render();
$("#duplicate-button").click(function(e){e.stopPropagation();
that.newPlanName=$("#shipment-name").val();
that.duplicateShipmentPopover.hide();
that.duplicateShipmentPopoverLoading.render();
that.duplicateShipment();
});
$("#cancel-duplicate-button").click(function(){that.duplicateShipmentPopover.hide();
});
},renderDuplicatePlanPopover:function(e){e.stopPropagation();
var that=this;
this.duplicatePlanPopover.render();
$("#duplicate-button").click(function(e){e.stopPropagation();
that.newPlanName=$("#plan-name").val();
that.duplicatePlanPopover.hide();
that.duplicatePlanPopoverLoading.render();
that.duplicatePlan();
});
$("#cancel-duplicate-button").click(function(){that.duplicatePlanPopover.hide();
});
},duplicateShipment:function(){var model=this.view.model;
var duplicateManifestItems=[];
var that=this;
if(model.manifest){var manifest=model.manifest;
if(manifest.get("fromAddressId")){var duplicateManifest=new FBA.Core.Model.Manifest({name:this.newPlanName,useCasePack:manifest.get("useCasePack"),fromAddressId:manifest.get("fromAddressId"),destinationRegions:manifest.get("destinationRegions"),isDuplicateShipment:1});
that.saveDuplicateManifestShipment(duplicateManifest,model.items,model.get("shipmentId"));
}else{var addressCollection=new FBA.Core.Collection.MerchantAddress();
addressCollection.fetch({success:function(collection,response,options){var duplicateManifest=new FBA.Core.Model.Manifest({name:that.newPlanName,useCasePack:model.get("useCasePack"),fromAddressId:response.data.models[0].addressId,destinationRegions:{regionName:"ANY_REGION",isoCountryCode:model.get("toAddress").country},isDuplicateShipment:1});
that.saveDuplicateManifestShipment(duplicateManifest,model.items,model.get("shipmentId"));
}});
}}else{var manifest=this.shipment.manifest;
var shipment=that.shipment;
if(manifest.get("fromAddressId")){var duplicateManifest=new FBA.Core.Model.Manifest({name:this.newPlanName,useCasePack:manifest.get("useCasePack"),fromAddressId:manifest.get("fromAddressId"),destinationRegions:manifest.get("destinationRegions"),isDuplicateShipment:1});
var duplicateShipmentItems=new FBA.Core.Collection.ShipmentItems();
that.saveDuplicateManifestShipment(duplicateManifest,duplicateShipmentItems,shipment.get("shipmentId"));
}else{var addressCollection=new FBA.Core.Collection.MerchantAddress();
addressCollection.fetch({success:function(collection,response,options){var duplicateManifest=new FBA.Core.Model.Manifest({name:that.newPlanName,useCasePack:shipment.get("useCasePack"),fromAddressId:response.data.models[0].addressId,destinationRegions:{regionName:"ANY_REGION",isoCountryCode:shipment.get("toAddress").country},isDuplicateShipment:1});
var duplicateShipmentItems=new FBA.Core.Collection.ShipmentItems();
that.saveDuplicateManifestShipment(duplicateManifest,duplicateShipmentItems,shipment.get("shipmentId"));
}});
}}},saveDuplicateManifestShipment:function(duplicateManifest,itemsCollection,shipmentId){var duplicateManifestItems=[];
var that=this;
var data={shipmentId:shipmentId};
this.appendShipmentPageSizeProperty(data);
duplicateManifest.save({},{success:function(){itemsCollection.fetch({add:false,data:data,success:function(collection,response,options){var manifestId=duplicateManifest.get("manifestId");
$.each(response.data.models,function(){duplicateManifestItems.push({manifestId:manifestId,id:this.id,mSku:this.mSku,asin:this.asin,condition:this.condition});
});
var duplicateCollection=new FBA.Core.Collection.ManifestItems(duplicateManifestItems);
duplicateCollection.save({success:function(collection,response,options){window.location="/gp/fba/inbound-plan-workflow/index.html#"+manifestId+"/plan";
that.duplicateShipmentPopoverLoading.hide();
}});
}});
}});
},duplicatePlan:function(){var manifest=this.view.manifest;
var duplicateManifest=new FBA.Core.Model.Manifest({name:this.newPlanName,useCasePack:manifest.get("useCasePack"),fromAddressId:manifest.get("fromAddressId"),destinationRegions:manifest.get("destinationRegions"),isDuplicateManifest:1});
var duplicateManifestItems=[];
var that=this;
var viewData=that.view.data;
duplicateManifest.save({},{success:function(){that.view.collection.fetch({add:false,data:{manifestId:viewData.manifestId,resultsPerBatch:that.maxDuplicateItems},success:function(collection,response,options){var manifestId=duplicateManifest.get("manifestId");
$.each(response.data.models,function(){duplicateManifestItems.push({manifestId:manifestId,id:this.id,mSku:this.mSku,asin:this.asin,condition:this.condition});
});
var duplicateCollection=new FBA.Core.Collection.ManifestItems(duplicateManifestItems);
duplicateCollection.save({success:function(collection,response,options){window.location="/gp/fba/inbound-plan-workflow/index.html#"+manifestId+"/plan";
that.duplicatePlanPopoverLoading.hide();
}});
}});
}});
},appendShipmentPageSizeProperty:function(data){data.pageSize=this.maxDuplicateItems;
}});
}(jQuery));
(function($){FBA.Core.View.RenamePlanPopover=APF.View.Popover.extend({initialize:function(options){this.loadingTemplate=$("#fba-core-template-html-rename-plan-popover-loading").html();
this.template=_.template($("#fba-core-template-html-rename-plan-popover").html());
this.model=options.model;
this.parent=options.parent;
APF.View.Popover.prototype.initialize.call(this,{modal:true,title:APF.strings["property-rename-plan"],width:650,literalContent:$("#fba-core-template-loading").html()});
},render:function(){APF.View.Popover.prototype.render.call(this);
var el=this.el;
el.html(this.template({planName:this.model.get("name"),maxPlanNameLength:APF.getAttr("maxShipmentNameLength")}));
$("#plan-name-exceeds-limit").hide();
el.find("#plan-name").bind("keyup keydown",this.validatePlanNameLength);
el.find("#save-button").click(_.bind(this.save,this));
el.find("#cancel-button").click(_.bind(this.cancel,this));
},validatePlanNameLength:function(){var nameInput=$("#plan-name");
var planNameLength=APF.Util.stringLengthInByte(nameInput.val());
if(planNameLength>APF.getAttr("maxPlanNameLengthInByte")){nameInput.addClass("fba-core-input-error");
$("#plan-name-exceeds-limit").show();
}else{nameInput.removeClass("fba-core-input-error");
$("#plan-name-exceeds-limit").hide();
}},save:function(){var el=this.el;
var nameInput=el.find("#plan-name");
var val=$.trim(nameInput.val());
var planNameLength=APF.Util.stringLengthInByte(val);
var that=this;
if(val===""){nameInput.addClass("fba-core-input-error");
}else{if(planNameLength>APF.getAttr("maxPlanNameLengthInByte")){nameInput.addClass("fba-core-input-error");
$("#plan-name-exceeds-limit").show();
}else{el.html(this.loadingTemplate);
var manifest=new FBA.Core.Model.Manifest();
var manifestId=this.model.get("manifestId");
manifest.set({id:manifestId,manifestId:manifestId,name:val});
manifest.save({},{success:function(model,resp){if(resp.errorMessage){that.el.find(".fba-core-content").html(resp.errorMessage[0]);
}else{that.model.set({name:val});
that.parent.updatePlanName(val);
that.parent.options.parent.updatePlanNameInCachedViews(val);
that.hide();
}}});
}}},cancel:function(){this.hide();
}});
}(jQuery));
(function($){FBA.Core.View.RenamePopover=APF.View.Popover.extend({initialize:function(options){this.loadingTemplate=$("#fba-core-template-html-rename-popover-loading").html();
this.template=_.template($("#fba-core-template-html-rename-popover").html());
this.name=options.name;
this.save=options.save;
this.maxLength=options.maxLength;
APF.View.Popover.prototype.initialize.call(this,{modal:true,title:APF.strings["property-rename-plan"],width:650,literalContent:$("#fba-core-template-loading").html()});
},render:function(){APF.View.Popover.prototype.render.call(this);
var el=this.el;
el.html(this.template({name:this.name,maxLength:this.maxLength}));
this.validateNameLength();
el.find("#fba-core-rename-popover-input").bind("keyup keydown",_.bind(this.validateNameLength,this));
el.find("#fba-core-rename-save-button").click(_.bind(this.validateAndSave,this));
el.find("#fba-core-rename-cancel-button").click(_.bind(this.cancel,this));
},validateNameLength:function(){var nameInput=$("#fba-core-rename-popover-input");
var nameLength=APF.Util.stringLengthInByte(nameInput.val());
if(nameLength>this.maxLength){nameInput.addClass("fba-core-input-error");
$("#fba-core-rename-name-exceeds-limit").show();
}else{nameInput.removeClass("fba-core-input-error");
$("#fba-core-rename-name-exceeds-limit").hide();
}},cancel:function(){this.hide();
},validateAndSave:function(){var el=this.el;
var nameInput=el.find("#fba-core-rename-popover-input");
var val=$.trim(nameInput.val());
var nameLength=APF.Util.stringLengthInByte(val);
if(val===""){nameInput.addClass("fba-core-input-error");
}else{if(nameLength>this.maxLength){nameInput.addClass("fba-core-input-error");
$("#fba-core-rename-name-exceeds-limit").show();
}else{this.save(val);
this.hide();
}}}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentProblemsDefectPopover=APF.View.Popover.extend({initialize:function(options){this.template=_.template($("#fba-core-template-workflow-shipment-problems-defect-popover").html());
APF.View.Popover.prototype.initialize.call(this,{modal:true,title:APF.strings["ShipProb_"+this.model.get("type")],width:650});
},acknowledgeDefect:function(){this.hide();
this.model.details.set({acknowledgement:{type:"AGREE"}});
this.model.set({acknowledgement:{type:"AGREE"}});
APF.trigger("defect:acknowledge",this.model);
var that=this;
this.model.increaseSaveCount();
this.model.save({},{success:function(){that.model.decreaseSaveCount();
APF.trigger("defect:saved",that.model);
}});
},attachEvents:function(){var that=this;
var el=this.el;
this.el.find("#fba-core-shipment-problem-defect-popover-feedback-rating-url-href").click(function(e){e.preventDefault();
e.stopPropagation();
var ratingUrl=$("#fba-core-shipment-problem-defect-popover-feedback-rating-url").val()+"&customAttribute1Value="+that.model.details.get("type")+"&customAttribute2Value="+that.model.details.get("defectId")+"&customAttribute3Value="+that.model.details.get("shipmentId");
openModalDialog(ratingUrl,530,"scrollbars=yes");
return false;
});
$('[name="acknowledgeDefect"]',this.el).click(function(){that.acknowledgeDefect();
});
this.slideshow();
},slideshow:function(){var el=this.el;
el.find(".image_example:first").show();
if(el.find(".image_example img").length>1){el.find(".image_example img").clone().removeAttr("width").removeAttr("height").addClass("thumbnail").appendTo(".image_thumbnails",el).click(function(){$(this).addClass("selected").siblings(".thumbnail").removeClass("selected");
$(this).parents(".image_examples").find(".image_example").hide().eq($(this).parent().children(".thumbnail").index(this)).show();
}).filter(":first").addClass("selected");
}},displayImages:function(){var uris=this.getImagesURIs()||[];
var tokens=this.model.details.get("tokens")||[];
this.display(uris,tokens);
},getImagesURIs:function(){var details=this.model.details;
var images=details.get("images");
var uris=[];
var tokenList=[];
if(images){$.each(images,function(){if(this.type==="IMAGE_TOKEN"){tokenList.push(this.url);
}else{uris.push(this.url);
}});
}details.set({tokens:tokenList});
return uris;
},display:function(uriList,tokenList){var that=this;
var details=that.model.details;
if(tokenList.length==0){this.renderImagesByURIs(uriList);
return;
}details.defectImages.reset(details.defectImages.models,that.options);
details.fetchDefectImages({callback:function(){var defectImagesURIs=details.defectImages.data.URIs;
if(defectImagesURIs){$.each(defectImagesURIs,function(){uriList.push(this);
});
}that.renderImagesByURIs(uriList);
}});
},renderImagesByURIs:function(URIs){if(URIs&&URIs.length>0){var imageDivs=this.el.find(".image_examples .image");
this.el.find(".image-in-loading").remove();
if(imageDivs.length){$.each(imageDivs,function(i){var imageElem='<img width="100%" src="'+URIs[i]+'" alt="'+APF.strings["Problem_Picture_Alt"]+'" />';
$(imageDivs[i]).append(imageElem);
});
this.slideshow();
}}},render:function(){var that=this;
this.popoverOptions.literalContent=$("#fba-core-template-loading").html();
APF.View.Popover.prototype.render.call(this);
var renderPopover=function(){that.el.html(that.template({model:that.model.details,type:that.model.details.get("type")}));
$("#image_rate_link_href").click(function(){var ratingUrl=$("#image_feedback_rate_link").val()+"&customAttribute1Value="+that.model.details.get("type")+"&customAttribute2Value="+that.model.details.get("defectId")+"&customAttribute3Value="+that.model.details.get("shipmentId");
openModalDialog(ratingUrl,530,"scrollbars=yes");
return false;
});
that.attachEvents();
that.displayImages();
};
if(!this.model.details.hasBeenSynced){this.model.fetchDetails({callback:renderPopover});
}else{renderPopover();
}}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentProblemsDefectDisputePopover=APF.View.Popover.extend({initialize:function(options){this.template=_.template($("#fba-core-template-workflow-shipment-problems-defect-dispute-popover").html());
APF.View.Popover.prototype.initialize.call(this,{modal:true,width:650,skin:'<div id="fba-core-defect-dispute-popover" class="fba-dispute-popover">'+'<div class="ap_content"></div>'+"</div>",showCloseButton:false});
},acknowledgeDefect:function(){var defect=this.model;
var that=this;
this.hide();
defect.details.set({acknowledgement:{type:"AGREE"}});
defect.set({acknowledgement:{type:"AGREE"}});
defect.increaseSaveCount();
defect.save({},{success:function(){that.model.decreaseSaveCount();
}});
},attachEvents:function(){var that=this;
$("#fba-inbound-shipment-workflow-dispute-defect-ack-button",this.el).click(function(){that.acknowledgeDefect();
});
},render:function(){var that=this;
var defect=this.model;
var retry=0;
this.popoverOptions.literalContent=$("#fba-core-template-loading").html();
APF.View.Popover.prototype.render.call(this);
var renderPopover=function(){that.el.html(that.template({model:defect.details,type:defect.details.get("type")}));
that.attachEvents();
};
var syncDefectDetails=function(){if(defect.details.hasBeenSynced||retry>=3){renderPopover();
}else{defect.fetchDetails({callback:syncDefectDetails});
retry++;
}};
syncDefectDetails();
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentsController=APF.View.Controller.extend({initialize:function(options){this.parent=options.parent;
this.model=this.model||this.parent.model;
this.collection=this.collection||this.parent.collection;
APF.View.Controller.prototype.initialize.call(this,options);
},getMap:function(){return{view:"FBA.Core.View.WorkflowShipmentSummaryShipments",collection:this.collection,model:this.model};
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipments=APF.View.Collection.extend({initialize:function(options){if(options.data.pageType){options.data={manifestId:options.data.manifestId,pageType:options.data.pageType};
}else{options.data={manifestId:options.data.manifestId};
}APF.View.Collection.prototype.initialize.call(this,options);
},view:"FBA.Core.View.WorkflowShipmentSummaryShipment",container:"#fba-core-workflow-shipment-summary-shipment",templates:{loading:"#fba-core-template-workflow-shipment-summary-loading",layout:"#fba-core-template-workflow-shipment-summary-shipments"},enter:function(){APF.View.Collection.prototype.enter.call(this);
var model=this.model;
model.bind("change:totalCases",this.updateTotals,this);
model.bind("change:totalQuantity",this.updateTotals,this);
this.updateTotals();
if(model.get("status")=="SHIPMENTS_CREATED"){this.collection.bind("render:shipment:complete",this.renderCrossDockWarningMessage,this);
}},exit:function(){APF.View.Collection.prototype.exit.call(this);
var model=this.model;
model.unbind("change:totalCases",this.updateTotals);
model.unbind("change:totalQuantity",this.updateTotals);
},updateTotals:function(){var el=this.el;
var model=this.model;
el.find("#fba-core-workflow-shipment-summary-shipments-total-cases").html(model.get("totalCases"));
el.find("#fba-core-workflow-shipment-summary-shipments-total-quantity").html(model.get("totalQuantity"));
},renderCrossDockWarningMessage:function(shipment){if(shipment.hasInboundCrossDockFC()){this.el.find("#fba-core-workflow-shipment-summary-shipments-inbound-cross-dock-fc-warning-message").show();
this.collection.unbind("render:shipment:complete",this.renderCrossDockWarningMessage,this);
}},getTemplateData:function(data,model,collection){if(!model||!collection){return;
}collection.models.sort(function(model1,model2){if(model1.get("name")<model2.get("name")){return -1;
}else{if(model1.get("name")>model2.get("name")){return 1;
}else{return 0;
}}});
return{isPlannedShipments:(model.get("status")!="SHIPMENTS_CREATED"),useCasePack:model.get("useCasePack"),model:model,models:collection.models,dataPagination:{page:1,pageSize:collection.models.length,totalRecords:collection.models.length}};
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipment=APF.View.Base.extend({tagName:"tr",initialize:function(options){this.el=$(this.el);
this.parent=options.parent;
this.useCasePack=this.parent.model.get("useCasePack");
this.isPlannedShipment=(this.parent.model.get("status")!="SHIPMENTS_CREATED");
this.template=_.template($("#fba-core-template-workflow-shipment-summary-shipment").html());
this.inlineItemsContainer=null;
this.inlineItemsInView=false;
var model=this.model;
var that=this;
this.eligibleShipments=[];
this.plannedShipmentId=model.get("plannedShipmentId");
this.hasEligibleShipments=false;
this.previousSelectedShipment="";
this.itemsPopover=new FBA.Core.View.WorkflowShipmentSummaryShipmentContentsPopover({useCasePack:this.useCasePack,model:model,collection:model.items});
this.inlineItems=new FBA.Core.View.WorkflowShipmentSummaryShipmentItemsController({useCasePack:this.useCasePack,model:model,collection:model.items});
model.bind("change:workflowState",function(){that.render();
});
},enter:function(){var model=this.model;
var that=this;
var el=this.el;
var previewShipmentEl=el.find(".preview-shipment");
this.listEligibleShipmentsEl=el.find(".list-eligible-shipments");
var events={"click    .fba-core-packlist-learn-more":"showMultiplePacklistHelpContent"};
Backbone.View.prototype.delegateEvents.call(this,events);
el.find('[name="shipmentName"]').blur(this.validateShipmentName);
el.find(".view-shipment-contents").click(function(){that.showItems();
return false;
});
el.find(".view-shipment-contents-inline").click(function(){that.viewInline();
return false;
});
el.find(".hide-shipment-contents-inline").click(function(){that.hideInline();
return false;
});
if(this.isPlannedShipment){this.listEligibleShipmentsEl.change(function(e){e.stopPropagation();
var hasSelectedShipment=that.listEligibleShipmentsEl.val()!="";
el.find(".fba-core-alert-label-error").hide();
model.set({hasAlertMsg:false});
if(that.previousSelectedShipment!==""){$("option[value="+that.previousSelectedShipment+"]").attr("disabled",false);
}previewShipmentEl.hide();
that.renderContinueButton();
if(hasSelectedShipment){that.checkShipment(e);
}});
}model.bind("change:totalLineItems",this.updateTotals,this);
model.bind("change:totalCases",this.updateTotals,this);
model.bind("change:totalQuantity",this.updateTotals,this);
this.updateTotals();
if(this.shipmentPackList){this.shipmentPackList.enter();
}},exit:function(){var model=this;
model.unbind("change:totalLineItems",this.updateTotals);
model.unbind("change:totalCases",this.updateTotals);
model.unbind("change:totalQuantity",this.updateTotals);
if(this.shipmentPackList){this.shipmentPackList.exit();
}if(this.inlineItemsInView){this.inlineItems.exit();
}},showMultiplePacklistHelpContent:function(e){e.preventDefault();
if(!this.multiplePacklistHelpPopover){this.multiplePacklistHelpPopover=new APF.View.Popover({literalContent:APF.strings["learn-more-content"],title:APF.strings["packlist-help-title"]});
}this.multiplePacklistHelpPopover.render();
},updateTotals:function(){var el=this.el;
var model=this.model;
el.find(".total-line-items").html(model.get("totalLineItems"));
el.find(".total-cases").html(model.get("totalCases"));
el.find(".total-quantity").html(model.get("totalQuantity"));
},updateCreateAdd:function(){var el=this.el;
var listEligibleShipmentsEl=this.listEligibleShipmentsEl;
var hasSelectedShipment=listEligibleShipmentsEl.val()!="";
var previewShipmentEl=el.find(".preview-shipment");
var createAddValue=el.find("input[name='fba-inbound-manifest-workflow-create-add-shipment-"+this.model.get("id")+"']:checked").val();
el.find(".fba-core-alert-label-error").hide();
if(createAddValue=="add-to-shipment"){listEligibleShipmentsEl.attr("disabled",false);
el.find(".new-shipment-name").attr("disabled",true);
this.renderPreviewShipmentLink();
}else{this.model.set({hasAlertMsg:false});
listEligibleShipmentsEl.attr("disabled",true);
listEligibleShipmentsEl.removeClass("fba-core-input-warning");
previewShipmentEl.hide();
el.find(".new-shipment-name").attr("disabled",false);
}this.renderContinueButton();
},renderPlannedShipments:function(){$(".create-add-shipment").attr("disabled",false);
$.each(this.parent.views,function(){var createAddValue=this.el.find("input[name='fba-inbound-manifest-workflow-create-add-shipment-"+this.model.get("id")+"']:checked").val();
if(createAddValue=="add-to-shipment"){this.el.find(".list-eligible-shipments").attr("disabled",false);
}});
},renderContinueButton:function(){var approveShipmentButton=$("#fba-inbound-manifest-workflow-preview-edit-create-shipments");
var approveShipmentAckBox=$("#fba-inbound-manifest-workflow-preview-create-shipments-ack-checkbox");
var continueEnabled=true;
var inputIncomplete=false;
$.each(this.parent.collection.models,function(i,model){if(model.get("hasAlertMsg")){continueEnabled=false;
return false;
}});
$(".list-eligible-shipments").each(function(){var hasEligibleValue=$(this).context.value!="";
var disabled=$(this).context.disabled;
if(!disabled&&!hasEligibleValue){continueEnabled=false;
inputIncomplete=true;
return false;
}});
if(inputIncomplete){$(".next-content-disabled").show();
}else{$(".next-content-disabled").hide();
}if(approveShipmentAckBox.length&&!approveShipmentAckBox.is(":checked")){continueEnabled=false;
}if(continueEnabled){approveShipmentButton.removeClass("btn-lg-pri-arrowr-ghost");
approveShipmentButton.addClass("btn-lg-pri-arrowr");
approveShipmentButton.attr("disabled",false);
$(".next-content-enabled").show();
}else{approveShipmentButton.addClass("btn-lg-pri-arrowr-ghost");
approveShipmentButton.removeClass("btn-lg-pri-arrowr");
approveShipmentButton.attr("disabled",true);
$(".next-content-enabled").hide();
}},renderPreviewShipmentLink:function(){var el=this.el;
var currentSelectedShipment=this.listEligibleShipmentsEl.val();
var previewShipmentEl=el.find(".preview-shipment");
var hrefValueURL="/gp/fba/inbound-shipment-workflow/index.html#"+currentSelectedShipment;
if(currentSelectedShipment!=""){previewShipmentEl.attr("href",hrefValueURL);
previewShipmentEl.show();
}else{previewShipmentEl.hide();
}},renderActionButtons:function(actionVal){var goBackButton=$("#fba-inbound-manifest-workflow-preview-planned-shipments-go-back");
var deletePlanButton=$("#delete-plan");
goBackButton.attr("disabled",actionVal);
goBackButton.toggleClass("btn-lg-sec-arrowl-ghost",actionVal);
deletePlanButton.attr("disabled",actionVal);
deletePlanButton.toggleClass("btn-lg-sec-ghost",actionVal);
},showDiscrepancyMessage:function(options){if(options.shipmentStatus==="NotConfirmed"&&!options.exceedingWebFormLimit){this.renderAll();
return;
}this.alertTemplate=_.template($("#fba-inbound-manifest-workflow-templates-add-to-shipment-discrepancy-message").html());
var that=this;
var shipmentId=this.listEligibleShipmentsEl.val();
var strings="";
var stringId=options.isCLIShipment?"alert-attempt-update-cli-shipment-{X}":"alert-attempt-update-shipment-{X}";
var canUndo=true;
switch(options.shipmentStatus){case"InVoidWindow":stringId=stringId.replace("{X}",options.exceedingWebFormLimit?"exceeding-web-form-limit-in-void-window":"in-void-window");
break;
case"OutOfVoidWindow":stringId=stringId.replace("{X}","out-of-void-window");
break;
case"CompletedApc":stringId=stringId.replace("{X}","completed");
break;
case"CompletedNapc":stringId=stringId.replace("{X}",options.isCLIShipment?"completed-napc":"completed");
break;
default:stringId=stringId.replace("{X}","exceeding-web-form-limit-not-confirmed");
canUndo=false;
break;
}strings=APF.strings[stringId].replace(/{\s*shipmentId\s*}/i,shipmentId);
var content=this.alertTemplate({strings:strings,canUndo:canUndo});
this.alertPopover=new APF.View.Popover({localContent:content,showCloseButton:false,title:APF.strings["popover-title-alert"]});
this.alertPopover.render();
this.renderActionButtons(true);
$(".next-content-enabled").hide();
this.alertPopover.el.find("#alert-ok-btn").click(function(e){that.alertPopover.hide();
that.renderAll();
});
this.alertPopover.el.find("#alert-cancel-btn").click(function(e){that.alertPopover.hide();
that.listEligibleShipmentsEl.val(that.previousSelectedShipment);
that.renderAll();
});
},checkShipment:function(e){var approveShipmentButton=$("#fba-inbound-manifest-workflow-preview-edit-create-shipments");
approveShipmentButton.addClass("btn-lg-pri-arrowr-ghost");
approveShipmentButton.attr("disabled",true);
$(".list-eligible-shipments").attr("disabled",true);
$(".next-content-enabled").hide();
$(".create-add-shipment").attr("disabled",true);
this.fetchCarrierShipment();
},fetchCarrierShipment:function(){var that=this;
var currentSelectedShipment=this.listEligibleShipmentsEl.val();
var carrierShipment=new FBA.Core.Model.CarrierShipment();
var options={shipmentId:currentSelectedShipment};
var shipmentStatus=$(":selected",this.listEligibleShipmentsEl).parent().data("shipment-status");
if(currentSelectedShipment!=""){this.renderActionButtons(true);
carrierShipment.fetch({data:{shipmentId:currentSelectedShipment},success:function(){if(carrierShipment){var hasBeenConfirmed=carrierShipment.get("status")=="CONFIRMED";
var canBeVoided=carrierShipment.get("canBeVoided")=="1";
if(shipmentStatus!=="WORKING"){options.shipmentStatus=carrierShipment.getAttr("isInternalShipment")?"CompletedApc":"CompletedNapc";
}else{if(canBeVoided){options.shipmentStatus="InVoidWindow";
}else{if(hasBeenConfirmed){options.shipmentStatus="OutOfVoidWindow";
}else{options.shipmentStatus="NotConfirmed";
}}}}that.checkCliStatus(options);
}});
}},checkCliStatus:function(options){var that=this;
var shipmentId=options.shipmentId;
var shipmentStatus=$(":selected",this.listEligibleShipmentsEl).parent().data("shipment-status");
var shipment=_.find(this.eligibleShipments[shipmentStatus],function(shipment){return shipment.shipmentId===shipmentId;
});
var numItemsInTargetShipment=shipment.shipmentSummary.totalLineItems;
var declaredCartonInformationSource=shipment.shipment.declaredCartonInformationSource;
if(declaredCartonInformationSource==="INTERACTIVE"){var uissProperty=new FBA.Core.Model.UissProperty();
var uissPropertyDropdownStateKey=APF.getAttr("uissPropertyDropdownStateKey");
uissProperty.fetch({data:{key:uissPropertyDropdownStateKey+shipmentId},success:function(response){var dropdownState=response.getAttr("value");
options.isCLIShipment=!!dropdownState;
if(!options.isCLIShipment||_.contains(["OutOfVoidWindow","CompletedApc","CompletedNapc"],options.shipmentStatus)){that.showDiscrepancyMessage(options);
return;
}var maxWebformMskus=(dropdownState==="multiple-multi-asin-cartons-ten-or-less")?APF.getAttr("multiSkuWebFormMaxAsins"):APF.getAttr("defaultWebformMaxMskus");
if(numItemsInTargetShipment+that.model.get("totalLineItems")>maxWebformMskus){that.checkIfExceedingWebFormLimit(options,maxWebformMskus);
}else{that.showDiscrepancyMessage(options);
}}});
}else{that.showDiscrepancyMessage(options);
}},checkIfExceedingWebFormLimit:function(options,webFormMaxAsins){var that=this;
var mskus=[];
this.model.items.fetch({data:this.inlineItems.getData(),success:function(){$.each(that.model.items.models,function(){mskus.push(this.get("mSku"));
});
var shipmentItems=new FBA.Core.Collection.ShipmentItems();
shipmentItems.fetch({data:{shipmentId:options.shipmentId,pageSize:webFormMaxAsins},skipSetInitialLabelQuantity:true,success:function(){$.each(shipmentItems.models,function(){mskus.push(this.get("mSku"));
});
if(_.uniq(mskus).length>webFormMaxAsins){options.exceedingWebFormLimit=true;
}that.showDiscrepancyMessage(options);
}});
}});
},renderAll:function(){this.previousSelectedShipment=this.listEligibleShipmentsEl.val();
$("option[value="+this.previousSelectedShipment+"]").attr("disabled",true);
this.renderPlannedShipments();
this.renderPreviewShipmentLink();
this.renderActionButtons(false);
this.renderContinueButton();
},validateShipmentName:function(){var input=$(this);
if(!$.trim(input.val())){input.val(input.data("default-name"));
}},viewInline:function(){this.toggleInlineItems(true);
this.inlineItems.render();
this.inlineItems.enter();
},hideInline:function(){this.toggleInlineItems(false);
this.inlineItems.exit();
},toggleInlineItems:function(toggle){var el=this.el;
if(toggle){el.find(".view-shipment-contents-inline").hide();
el.find(".hide-shipment-contents-inline").show();
}else{el.find(".view-shipment-contents-inline").show();
el.find(".hide-shipment-contents-inline").hide();
}if(this.inlineItemsContainer){this.inlineItemsContainer.toggle(toggle);
}this.inlineItemsInView=toggle;
},showItems:function(){this.itemsPopover.show();
},render:function(){var that=this;
var el=this.el;
var model=this.model;
var eligibleShipmentsMap=this.model.get("eligibleShipmentsMap");
var maxPackListItemCount=APF.getAttr("maxPackListItemCount");
var packlistIndexes=_.range(0,model.get("totalLineItems"),maxPackListItemCount*1);
var packlists=[];
var packlistUrl=FBA.Core.Util.addReftagToUrl({url:"/gp/fba/core/templates/workflow/shipment-summary/shipment/generate-pack-list.html",reftag:{to:"fbapl",from:"fbass"}});
if(this.isPlannedShipment&&eligibleShipmentsMap!=undefined&&eligibleShipmentsMap.get("eligibleShipments").length>0){this.hasEligibleShipments=true;
this.eligibleShipments=this.groupShipmentsByStatus(eligibleShipmentsMap.get("eligibleShipments"));
model.set({eligibleShipments:this.eligibleShipments,hasEligibleShipments:this.hasEligibleShipments});
}else{model.set({hasEligibleShipments:this.hasEligibleShipments});
}if(APF.getAttr("isIndianFC")){APF.setAttr("nodeName",this.model.get("destinationWarehouse"));
APF.trigger("change:nodeName");
}$.each(packlistIndexes,function(){packlists.push({index:this,url:packlistUrl});
});
this.el.html(this.template({isPlannedShipment:this.isPlannedShipment,useCasePack:this.useCasePack,shipment:this.model,packlists:packlists}));
$(".next-content-disabled").hide();
if(this.isPlannedShipment){$(".fba-core-alert-label-error").hide();
el.find(".list-eligible-shipments").attr("disabled",true);
el.find(".preview-shipment").hide();
el.find("input[name^='fba-inbound-manifest-workflow-create-add-shipment-']").change(function(){that.updateCreateAdd();
});
}var shipmentPackListEl=this.el.find(".shipment-pack-list");
if(shipmentPackListEl.length!=0){this.shipmentPackList=new FBA.Core.View.WorkflowShipmentSummaryShipmentPackList({model:this.model,el:shipmentPackListEl});
}this.parent.collection.trigger("render:shipment:complete",this.model);
this.renderInlineItems();
},groupShipmentsByStatus:function(eligibleShipmentsArray){var eligibleShipmentsByStatus={WORKING:[],READY_TO_SHIP:[],PENDING_SHIPPED:[],SHIPPED:[],IN_TRANSIT:[],RECEIVING:[],DELIVERED:[],CHECKED_IN:[]};
$.each(eligibleShipmentsArray,function(){if(this.shipment.status=="WORKING"&&this.shipment.shippingWorkflowState=="ViewSummary"){this.shipment.status="READY_TO_SHIP";
}eligibleShipmentsByStatus[this.shipment.status].push(this);
});
return eligibleShipmentsByStatus;
},renderInlineItems:function(){if(this.inlineItemsInView){this.inlineItems.exit();
}if(this.inlineItemsContainer){this.inlineItemsContainer.remove();
}this.inlineItemsContainer=$('<tr style="display: none;">'+'<td class="shipment-contents-controller shipment-contents-cell" colspan="'+(this.useCasePack?7:6)+'"></td>'+"</tr>");
this.el.after(this.inlineItemsContainer);
this.inlineItemsContainer.find(".shipment-contents-controller").append(this.inlineItems.el);
this.toggleInlineItems(this.inlineItemsInView);
if(this.inlineItemsInView){this.inlineItems.render();
this.inlineItems.enter();
}}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentPackList=APF.View.Base.extend({initialize:function(options){this.el=$(options.el);
this.template=_.template($("#fba-core-template-workflow-shipment-summary-shipment-pack-list").html());
this.shipmentId=options.model.get("shipmentId");
this.report=new FBA.Core.Model.Report();
this.isPolling=false;
this.render();
},enter:function(){var events={"click .generate-pack-list":"triggerPolling"};
Backbone.View.prototype.delegateEvents.call(this,events);
APF.View.Base.prototype.enter.call(this);
if(this.isPolling){this.pollStatus();
}this.report.bind("change:status",this.render,this);
this.report.bind("change:relatedDocuments",this.render,this);
},exit:function(){this.stopPolling();
this.report.unbind("change:status",this.render);
this.report.unbind("change:relatedDocuments",this.render);
},triggerPolling:function(e){e.preventDefault();
var that=this;
this.report.set({type:"_GET_FBA_INBOUND_SHIPMENT_DATA_",attrs:[{name:"FBAShipmentId",value:this.shipmentId}],status:"_SUBMITTED_"});
this.report.save({},{success:function(){that.pollStatus();
}});
},pollStatus:function(){var that=this;
if(this.isPolling){return;
}this.isPolling=true;
this.interval=setInterval(function(){that.report.fetch({data:{referenceIds:[that.report.get("referenceId")]},success:function(){if(that.report.get("status")=="_DONE_"){that.stopPolling();
}}});
},2000);
},stopPolling:function(){clearInterval(this.interval);
this.isPolling=false;
if(this.report.get("status")!="_DONE_"){this.report.set({status:""});
}},render:function(){this.el.html(this.template({status:this.report.get("status"),downloadUrl:this.report.getDownloadUrl()}));
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentContentsPopover=APF.View.Popover.extend({initialize:function(options){this.isEditable=options.isEditable||false;
this.useCasePack=options.useCasePack;
this.controller;
options=$.extend(options,{modal:true,title:_.escape(this.model.get("name")),width:900,literalContent:_.template($("#fba-core-template-workflow-shipment-summary-shipment-items-layout").html())});
APF.View.Popover.prototype.initialize.call(this,options);
},render:function(){APF.View.Popover.prototype.render.call(this);
if(!this.controller){this.controller=new FBA.Core.View.WorkflowShipmentSummaryShipmentItemsController({isEditable:this.isEditable,useCasePack:this.useCasePack,model:this.model,collection:this.collection});
}this.controller.el=$("#fba-core-template-workflow-shipment-summary-shipment-items-controller",this.el);
var that=this;
this.controller.render();
this.controller.enter();
$("span.close-popover button",this.el).click(function(){that.hide();
return false;
});
},onHide:function(){if(this.controller&&this.el){this.controller.exit();
}APF.View.Popover.prototype.onHide.call(this);
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentItemsController=APF.View.Controller.extend({initialize:function(options){this.isEditable=options.isEditable||false;
this.useCasePack=options.useCasePack===undefined?this.model.get("useCasePack"):options.useCasePack;
this.showUnitsReceived=options.showUnitsReceived===undefined?this.model.carrierShipment:options.showUnitsReceived;
this.workflow=options.workflow;
APF.View.Controller.prototype.initialize.call(this,options);
this.el.html($("#fba-core-template-workflow-shipment-summary-loading").html());
if(this.isEditable){APF.setAttr("guidanceManager",new FBA.Core.Util.AsinGuidance.Manager());
}this.model.bind("change:totalCartons",this.reset,this);
},waitForRender:true,renderOnReset:false,controls:"fba-core-workflow-shipment-summary-shipment-items-controls",useData:[],getData:function(){var data=APF.View.Controller.prototype.getData.call(this);
var model=this.model;
data||(data={});
if(APF.getAttr("manifests")&&APF.getAttr("manifests").models.length>0&&APF.getAttr("manifests").models[0].getAttr("destinationRegions")){data.destinationCountryCode=APF.getAttr("manifests").models[0].getAttr("destinationRegions")[0].isoCountryCode;
}if(APF.getAttr("shipments")&&APF.getAttr("shipments").models.length>0&&APF.getAttr("shipments").models[0].getAttr("toAddress")){data.destinationCountryCode=APF.getAttr("shipments").models[0].getAttr("toAddress").country;
}$.each(this.model.associations.items.attributes,function(from,to){data[to]=model.get(from);
});
return data;
},getMap:function(){var collection=this.collection||this.model.items;
if(this.model.get("totalCartons")&&this.isEditable){collection=this.model.cartonItems;
}return{view:"FBA.Core.View.WorkflowShipmentSummaryShipmentItems",model:this.model,collection:collection};
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentItems=FBA.Core.View.ItemsType.extend({view:"FBA.Core.View.WorkflowShipmentSummaryShipmentItem",container:"#fba-core-workflow-shipment-summary-shipment-item",templates:{layout:"#fba-core-template-workflow-shipment-summary-shipment-items"},initialize:function(options){this.el=$(this.el);
this.parent=options.parent;
this.shipment=options.parent.model;
this.isEditable=this.parent.isEditable;
this.useCasePack=this.parent.useCasePack;
this.showUnitsReceived=this.parent.showUnitsReceived;
this.workflow=options.parent.workflow;
this.useShipmentPrepSummary=this.shipment.prepSummary!==undefined;
FBA.Core.View.ItemsType.prototype.initialize.call(this,options);
},enter:function(){var that=this;
var el=this.el;
var shipment=this.shipment;
var prepSummary=shipment.prepSummary;
var events={"click  .label-opt-out":"showLabelOptOutPopover","submit #print-labels":"printLabels","click  #fba-core-workflow-shipment-summary-shipment-items-edit":"editLabelsOnThisPage"};
var totalItems=this.shipment.get("cartonItems")?this.shipment.get("totalCartonLineItems"):this.shipment.get("totalLineItems");
if(totalItems<=APF.getAttr("defaultPageSize")){events["click #sort-by-msku"]="sortMSKU";
events["click #sort-by-title"]="sortTitle";
}el.find("#fba-core-workflow-edit-case-units").click(function(){that.toggleEditCaseUnits();
});
el.find("#fba-core-workflow-edit-number-cases").click(function(){that.toggleEditNumberCases();
});
el.find("#fba-core-workflow-edit-label-quantity").click(function(){that.toggleEditLabelQuantity();
});
Backbone.View.prototype.delegateEvents.call(this,events);
FBA.Core.View.ItemsType.prototype.enter.call(this,events);
this.shipment.bind("change:totalLabelQuantity",this.enableDisablePrintLabels,this);
this.shipment.bind("change:totalLabelQuantity",this.renderCurrentPageLabelsTotal,this);
this.collection.bind("change:quantity",this.updateShipmentTotalQuantity,this);
this.collection.bind("destroy",this.updateShipmentTotalQuantity,this);
APF.bind("labelOptOut:agree",this.render,this);
if(el.find(".pagination-totals")){this.modelPagination.enter();
}FBA.Core.Util.validateNumeric(el);
this.enableDisablePrintLabels();
this.renderCurrentPageLabelsTotal();
if(this.useShipmentPrepSummary&&!prepSummary.hasBeenSynced){shipment.fetchPrepSummary({callback:_.bind(function(){this.togglePrintLabels();
this.toggleAllowLabelOptOut();
},this)});
}else{this.togglePrintLabels();
this.toggleAllowLabelOptOut();
}this.toggleEditCaseUnits();
this.toggleEditNumberCases();
this.toggleEditLabelQuantity();
if(this.workflow){this.workflow.shipmentItemsOnCurrentPage=this.collectionResponse;
this.workflow.trigger("change:shipmentItemsOnCurrentPage");
}},sortTitle:function(e){e.preventDefault();
e.stopPropagation();
this.sortByAttribute("title","#sort-by-title");
},sortMSKU:function(e){e.preventDefault();
e.stopPropagation();
this.sortByAttribute("mSku","#sort-by-msku");
},sortByAttribute:function(attribute,selector){var sortAsc=true;
var el=this.el;
var classNames=el.find(selector).attr("class");
if(classNames&&$.inArray("sort-asc",classNames.split(" "))!=-1){sortAsc=false;
}this.collectionResponse.models.sort(function(a,b){if(a.get(attribute)>b.get(attribute)){return sortAsc?1:-1;
}else{if(a.get(attribute)<b.get(attribute)){return sortAsc?-1:1;
}else{return 0;
}}});
this.containerEl=null;
this.setCollectionDataLoadComplete();
this.enter();
this.render();
el.find(selector).addClass("sort-current");
el.find(selector).addClass(sortAsc?"sort-asc":"sort-desc");
},exit:function(){this.shipment.unbind("change:totalLabelQuantity",this.enableDisablePrintLabels,this);
this.shipment.unbind("change:totalLabelQuantity",this.renderCurrentPageLabelsTotal,this);
this.collection.unbind("change:quantity",this.updateShipmentTotalQuantity,this);
this.collection.unbind("destroy",this.updateShipmentTotalQuantity,this);
APF.unbind("labelOptOut:agree",this.render,this);
FBA.Core.View.ItemsType.prototype.exit.call(this);
},render:function(){FBA.Core.View.ItemsType.prototype.render.call(this);
this.togglePrintLabels();
this.toggleAllowLabelOptOut();
},togglePrintLabels:function(){var shipment=this.shipment;
if(!this.useShipmentPrepSummary){this.el.find("#print-labels").toggle(this.isEditable&&shipment.allowLabelOptOut&&!shipment.allowLabelOptOut()&&shipment.isMerchantLabelingPrepOwner());
}else{this.el.find("#print-labels").toggle(this.isEditable&&shipment.prepSummary.hasMerchantLabeledItems());
}},enableDisablePrintLabels:function(){if(this.getCurrentPageLabelTotal()==0){this.disablePrintLabelsButton();
}else{this.enablePrintLabelsButton();
}},toggleAllowLabelOptOut:function(){$(".label-opt-out",this.el).toggle(this.allowLabelOptOut());
},allowLabelOptOut:function(){var shipment=this.shipment;
var prepSummary=shipment.prepSummary;
if(this.useShipmentPrepSummary){return shipment.get("manifestId")===undefined&&prepSummary.hasAmazonLabeledItems();
}else{return shipment.allowLabelOptOut&&shipment.allowLabelOptOut();
}},updateShipmentTotalQuantity:function(){if(this.shipment.get("shipmentId")){this.shipment.updateTotalQuantity();
}},getCurrentPageLabelTotal:function(){var total=0;
$.each(this.collectionResponse.models,function(){total+=parseInt(this.get("labelQuantity")||this.getQuantity());
});
return total;
},renderCurrentPageLabelsTotal:function(){this.el.find("#fba-core-workflow-shipment-summary-shipment-items-total-labels").html(this.getCurrentPageLabelTotal());
},toggleEditCaseUnits:function(){var toggle=true;
$.each(this.views,function(){this.toggleEditCaseUnits(toggle);
});
},toggleEditNumberCases:function(){var toggle=true;
$.each(this.views,function(){this.toggleEditNumberCases(toggle);
});
},toggleEditLabelQuantity:function(){var toggle=true;
$.each(this.views,function(){this.toggleEditLabelQuantity(toggle);
});
},editLabelsOnThisPage:function(e){var el=this.el;
e.preventDefault();
el.find("#fba-core-workflow-edit-label-quantity").attr("checked","checked");
this.toggleEditLabelQuantity();
el.find(".update-label-quantity:visible").first().focus();
},printLabels:function(e){var args={labelType:$('select[name="labelType"]').val()};
var count=0;
var models=this.collectionResponse.models;
if(models.length===0){return false;
}_.each(models,function(model){args["mSku."+count]=model.get("mSku");
args["qty."+count]=model.get("labelQuantity")||model.getQuantity();
args["fnSku."+count]=model.get("fnSku");
count++;
});
this.el.find('input[name="model"]').val(JSON.stringify(args));
},showLabelOptOutPopover:function(e){e.preventDefault();
$(".ap_closebutton").click();
var that=this;
setTimeout(function(){that.labelOptOutPopover=new FBA.Core.View.WorkflowShipmentSummaryShipmentLabelOptOutPopover({model:that.model});
that.labelOptOutPopover.show();
},15);
},getTemplateData:function(data,model,collection){var dataPagination={};
var totalItems=model.get("cartonItems")?model.get("totalCartonLineItems"):model.get("totalLineItems");
if(collection.data.previousBatchTokens||collection.data.nextBatchTokens){dataPagination={page:data.page||1,pageSize:collection.data.pageSize,totalRecords:totalItems,previousBatchTokens:collection.data.previousBatchTokens,nextBatchTokens:collection.data.nextBatchTokens};
}else{dataPagination={index:data.index||0,pageSize:collection.data.pageSize,totalRecords:totalItems};
}if(this.el.find(".pagination-totals")){this.modelPagination=new FBA.Core.View.Pagination({view:this});
return{totalQuantity:model.get("totalQuantity"),totalLineItems:totalItems,manifestId:model.get("manifestId"),manifest:model,filter:this.filterBy,hideTotals:(this.filterBy&&this.filterBy!="all"),isEditable:this.isEditable,useCasePack:this.useCasePack,showUnitsReceived:this.showUnitsReceived,dataPagination:dataPagination,model:model,labelTotal:this.getCurrentPageLabelTotal(),modelPagination:this.modelPagination};
}else{return{totalLineItems:totalItems,isEditable:this.isEditable,useCasePack:this.useCasePack,showUnitsReceived:this.showUnitsReceived,model:model,dataPagination:dataPagination,labelTotal:this.getCurrentPageLabelTotal()};
}},createView:function(model){var view=new FBA.Core.View.WorkflowShipmentSummaryShipmentItem({manifest:this.manifest,collection:this.collection,model:model,parent:this.parent,collectionResponse:this.collectionResponse});
return view;
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentItem=FBA.Core.View.ItemType.extend({tagName:"tr",initialize:function(options){this.el=$(this.el);
this.parent=options.parent;
this.collection=options.parent?options.parent.collection:options.collection;
this.isEditable=this.parent.isEditable;
this.useCasePack=this.parent.useCasePack;
this.showUnitsReceived=this.parent.showUnitsReceived;
this.template=_.template($("#fba-core-template-workflow-shipment-summary-shipment-item").html());
this.shipment=options.parent.model;
FBA.Core.View.ItemType.prototype.initialize.call(this,options);
},enter:function(events){var that=this;
events=$.extend(events||{},{"click      .remove-item":"hideReadonlyElements","mouseover  .pim-prep-instruction":"showPrepToolTip","mouseout   .pim-prep-instruction":"hidePrepToolTip"});
this.model.bind("change:unitsPerCase",this.renderCaseUnitsReadonly,this);
this.model.bind("change:unitsPerCase",this.resetLabelQuantity,this);
this.model.bind("change:numberOfCases",this.renderNumberCasesReadonly,this);
this.model.bind("change:numberOfCases",this.resetLabelQuantity,this);
this.model.bind("change:labelQuantity",this.renderLabelQuantityReadonly,this);
if(this.model.get("releaseDate")&&this.shipment.get("confirmedFulfillableDateEpoch")&&this.model.get("releaseDate")>=this.shipment.get("confirmedFulfillableDateEpoch")){this.el.find(".preorder-label").show();
}else{this.el.find(".preorder-label").hide();
}if(this.isBackorderedHCPOItem()){this.el.find(".backorder-label").show();
}else{this.el.find(".backorder-label").hide();
}FBA.Core.View.ItemType.prototype.enter.call(this,events);
},exit:function(){this.model.unbind("change:unitsPerCase",this.renderCaseUnitsReadonly,this);
this.model.unbind("change:unitsPerCase",this.resetLabelQuantity,this);
this.model.unbind("change:numberOfCases",this.renderNumberCasesReadonly,this);
this.model.unbind("change:numberOfCases",this.resetLabelQuantity,this);
this.model.unbind("change:labelQuantity",this.renderLabelQuantityReadonly,this);
this.hidePrepToolTip();
FBA.Core.View.ItemType.prototype.exit.call(this);
},render:function(){var el=this.el;
el.html(this.template({isEditable:this.isEditable,useCasePack:this.useCasePack,showUnitsReceived:this.showUnitsReceived,model:this.model,prepDetails:this.getPrepDetailsForTemplate(),disableRemoveItemsFromShipment:APF.getAttr("disableRemoveItemsFromShipment")}));
if(!this.model.collection){el.addClass("remove");
el.find(".remove-item").removeClass("remove-item-icon");
el.find(".update-quantity").hide();
el.find(".quantity-readonly").hide();
el.find(".update-label-quantity").hide();
el.find(".label-quantity-readonly").hide();
el.find(".total-quantity").hide();
el.find(".total-recieved").html("");
el.find(".indi-pack").html("");
el.find(".case-pack").html("");
el.find(".label").html("");
}FBA.Core.View.ItemType.prototype.render.call(this);
},isBackorderedHCPOItem:function(){return this.shipment.get("needByDate")&&(!this.model.get("releaseDate")||(this.shipment.get("createDateFromEpoch")&&this.model.get("releaseDate")<this.shipment.get("createDateFromEpoch")));
},getPrepDetailsForTemplate:function(){var prepDetails=this.model.get("prepDetails");
var prepDict={labelOwner:null,prep:[]};
if(!prepDetails){return{};
}$.each(prepDetails,function(){if(this.prepType==="NONE"||this.prepOwner==="NONE"){return;
}if(this.prepType==="ITEM_LABELING"){prepDict.labelOwner=this.prepOwner;
}else{prepDict.prep.push({prepType:this.prepType,prepOwner:this.prepOwner});
}});
return prepDict;
},showPrepToolTip:function(e){e.preventDefault();
e.stopPropagation();
var target=$(e.target);
this.hidePrepToolTip();
this.tooltipPopover=new APF.View.Popover({locationElement:target,location:"bottom",localContent:target.next(),title:target.html()});
this.tooltipPopover.render();
},hidePrepToolTip:function(){if(this.tooltipPopover){this.tooltipPopover.hide();
}},toggleEditCaseUnits:function(toggle){var el=this.el;
if(this.model.collection){el.find(".update-case-units").toggle(toggle);
el.find(".case-units-readonly").toggle(!toggle);
}},toggleEditNumberCases:function(toggle){var el=this.el;
if(this.model.collection){el.find(".update-number-cases").toggle(toggle);
el.find(".number-cases-readonly").toggle(!toggle);
}},toggleEditLabelQuantity:function(toggle){var el=this.el;
if(this.model.collection){el.find(".update-label-quantity").toggle(toggle);
el.find(".label-quantity-readonly").toggle(!toggle);
}},hideReadonlyElements:function(){var el=this.el;
el.find(".case-units-readonly").hide();
el.find(".number-cases-readonly").hide();
el.find(".label-quantity-readonly").hide();
},resetLabelQuantity:function(){var shipment=this.shipment;
if(!this.model.isAmazonLabeledItem()){var model=this.model;
var originalLabelQuantity=model.get("labelQuantity");
var newLabelQuantity=model.getQuantity();
var shipmentLabelQuantity=parseInt(shipment.get("totalLabelQuantity"))-parseInt(originalLabelQuantity)+parseInt(newLabelQuantity);
this.el.find(".update-label-quantity").val(newLabelQuantity);
model.set({labelQuantity:newLabelQuantity});
shipment.set({totalLabelQuantity:shipmentLabelQuantity});
}},renderCaseUnitsReadonly:function(){this.el.find(".case-units-readonly").html(this.model.get("unitsPerCase"));
},renderNumberCasesReadonly:function(){this.el.find(".number-cases-readonly").html(this.model.get("numberOfCases"));
},renderLabelQuantityReadonly:function(){this.el.find(".label-quantity-readonly").html(this.model.get("labelQuantity"));
}});
}(jQuery));
(function($){FBA.Core.View.WorkflowShipmentSummaryShipmentLabelOptOutPopover=APF.View.Popover.extend({initialize:function(options){this.el=$(this.el);
this.sasShipment=new FBA.Core.Model.SasShipment({shipmentId:options.model.get("shipmentId")});
options=$.extend(options,{modal:true,location:"centered",width:600,title:APF.strings["label-items-yourself"],literalContent:_.template($("#fba-core-template-workflow-shipment-summary-shipment-label-opt-out-popover").html())});
APF.View.Popover.prototype.initialize.call(this,options);
},events:{"click  #opt-out-agree":"optOutAgree","click  #opt-out-cancel":"hide"},enter:function(){Backbone.View.prototype.delegateEvents.call(this,this.events);
APF.View.Popover.prototype.enter.call(this);
},optOutAgree:function(){this.sasShipment.save();
this.hide();
APF.trigger("labelOptOut:agree");
location.reload();
},onHide:function(){APF.View.Popover.prototype.onHide.call(this);
setTimeout(function(){$("#fba-core-view-meta-data-shipment-contents a.view-modify-units").click();
},15);
}});
}(jQuery));
